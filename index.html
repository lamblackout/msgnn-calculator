<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSG –ó–∞–∫—É–ø–∫–∏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Drag & Drop –∑–æ–Ω–∞ */
        .drop-zone {
            border: 3px dashed #CBD5E1;
            transition: all 0.3s ease;
        }
        .drop-zone.drag-over {
            border-color: #3B82F6;
            background-color: #EFF6FF;
        }
        .drop-zone:hover {
            border-color: #94A3B8;
        }

        /* –°—Ç–∞—Ç—É—Å—ã */
        .status-ok { color: #10B981; }
        .status-warning { color: #F59E0B; }
        .status-error { color: #EF4444; }
        .row-error { background-color: #FEF2F2; }
        .row-warning { background-color: #FFFBEB; }

        /* –°–ø–∏–Ω–Ω–µ—Ä */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            animation: spin 1s linear infinite;
            border: 2px solid #E5E7EB;
            border-top-color: #3B82F6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
        }

        /* –ü–æ–ª—è —Ç–∞–±–ª–∏—Ü—ã */
        .table-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #D1D5DB;
            border-radius: 4px;
            font-size: 13px;
        }
        .table-input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .table-input:disabled {
            background-color: #F3F4F6;
            color: #9CA3AF;
        }
        .table-select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #D1D5DB;
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }

        /* –°–∫—Ä—ã—Ç–∏–µ –∫–æ–ª–æ–Ω–æ–∫ */
        .col-hidden { display: none; }

        /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ */
        #positions-table th,
        #positions-table td {
            padding: 6px 4px;
            font-size: 13px;
        }
        #positions-table th {
            white-space: nowrap;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º */
        .supplier-btn {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .supplier-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        .supplier-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ */
        .supplier-result-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            padding: 24px;
            margin: 20px 0;
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .result-icon {
            font-size: 40px;
        }

        .result-info h3 {
            margin: 0;
            font-size: 20px;
            color: #333;
            font-weight: 600;
        }

        .result-info p {
            margin: 4px 0 0;
            color: #666;
        }

        .result-status {
            margin-left: auto;
            background: #d4edda;
            color: #155724;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
        }

        .excel-download-section {
            padding: 20px 0;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .btn-download-excel {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-download-excel:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-download-excel:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .excel-hint {
            display: block;
            margin-top: 8px;
            color: #888;
            font-size: 13px;
        }

        .send-section {
            padding-top: 20px;
        }

        .send-label {
            text-align: center;
            color: #666;
            margin-bottom: 16px;
        }

        /* –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º */
        .supplier-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-supplier {
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: transform 0.2s, box-shadow 0.2s;
            color: white;
        }

        .btn-supplier:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-supplier:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-nn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-moscow {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-factories {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-sent {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ */
        .active-requests-container {
            margin-top: 16px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #dee2e6;
        }

        .active-requests-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .active-requests-header h4 {
            margin: 0;
            font-size: 14px;
            color: #495057;
        }

        .btn-show-more {
            padding: 4px 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-show-more:hover {
            background: #5a6268;
        }

        .active-requests-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* –ü–ª–∞—à–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ */
        .request-card {
            padding: 12px;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745;
            border-radius: 10px;
            animation: slideIn 0.3s ease-out;
            position: relative;
        }

        .request-card.ready {
            background: linear-gradient(135deg, #b8f5c8 0%, #7ddf9c 100%);
            border-color: #155724;
            box-shadow: 0 3px 12px rgba(40, 167, 69, 0.25);
        }

        .request-card.hidden-card {
            display: none;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .request-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .request-card-icon {
            font-size: 22px;
        }

        .request-card-info {
            flex: 1;
        }

        .request-card-info h5 {
            font-size: 13px;
            font-weight: 600;
            color: #155724;
            margin: 0;
        }

        .request-card-info p {
            font-size: 12px;
            color: #1e7e34;
            margin: 2px 0 0 0;
        }

        .request-card-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .request-card-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .request-card-badge.ready {
            background: #155724;
            color: white;
        }

        .request-card-badge.downloaded {
            background: #0d6efd;
            color: white;
        }

        .btn-download-request.downloaded {
            background: #0d6efd !important;
            color: white !important;
            cursor: default;
        }

        .btn-close-card {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            padding: 0;
            background: rgba(0,0,0,0.1);
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .btn-close-card:hover {
            opacity: 1;
            background: rgba(0,0,0,0.2);
        }

        .request-card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .btn-check-request {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-check-request:hover {
            background: #138496;
        }

        .btn-check-request:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .btn-download-request {
            padding: 6px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-download-request:hover:not(:disabled) {
            background: #218838;
        }

        .btn-download-request:disabled {
            background: #94d3a2;
            color: rgba(255,255,255,0.7);
            cursor: not-allowed;
        }

        .request-card-result {
            margin-top: 8px;
            padding: 8px;
            background: rgba(255,255,255,0.7);
            border-radius: 6px;
            font-size: 12px;
            color: #155724;
        }

        .request-card-result.error {
            background: #f8d7da;
            color: #721c24;
        }

        .suppliers-list {
            margin-top: 4px;
            font-size: 11px;
            color: #666;
        }

        /* ============================================ */
        /* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –í–•–û–î–ê */
        /* ============================================ */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-modal {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-logo {
            font-size: 28px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 32px;
        }

        .login-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
            transition: border-color 0.2s;
        }

        .login-input:focus {
            outline: none;
            border-color: #22c55e;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .login-btn:hover {
            background: #16a34a;
        }

        .login-error {
            color: #ef4444;
            font-size: 14px;
            margin-top: 16px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ */
        .logout-btn {
            position: fixed;
            top: 16px;
            right: 16px;
            padding: 8px 16px;
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 100;
        }

        .logout-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }

        /* –°–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –¥–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
        .app-content.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞ -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-modal">
            <div class="login-logo">MSG –ó–∞–∫—É–ø–∫–∏</div>
            <div class="login-subtitle">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫—É–ø–∫–∞–º–∏</div>

            <form id="login-form" onsubmit="return handleLogin(event)">
                <input type="text" id="login-username" class="login-input" placeholder="–õ–æ–≥–∏–Ω" autocomplete="username" required>
                <input type="password" id="login-password" class="login-input" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password" required>
                <button type="submit" class="login-btn">–í–æ–π—Ç–∏</button>
            </form>

            <div id="login-error" class="login-error">–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å</div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ -->
    <button id="logout-btn" class="logout-btn" onclick="handleLogout()" style="display: none;">
        üö™ –í—ã–π—Ç–∏
    </button>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div id="app-content" class="app-content hidden">
    <div class="container mx-auto px-4 py-8 max-w-7xl">

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">MSG –ó–∞–∫—É–ø–∫–∏</h1>
            <p class="text-gray-500 text-sm">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫—É–ø–∫–∞–º–∏ –º–µ—Ç–∞–ª–ª–æ–ø—Ä–æ–∫–∞—Ç–∞</p>
            <p class="text-gray-600 mt-2">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∑–∞—è–≤–∫—É –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –ø–æ–∑–∏—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é</p>
        </header>

        <!-- –°–µ–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <section class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">1. –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–∫–∏</h2>

            <!-- Drag & Drop –∑–æ–Ω–∞ -->
            <div id="drop-zone" class="drop-zone rounded-lg p-8 text-center mb-4 cursor-pointer"
                 onclick="document.getElementById('file-input').click()">
                <input type="file" id="file-input" class="hidden" accept=".txt,.pdf,.xlsx,.xls,.jpg,.jpeg,.png" multiple>
                <div class="text-gray-500">
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <p class="text-lg font-medium">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                    <p class="text-sm mt-1">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                    <p class="text-xs text-gray-400 mt-2">PDF, XLSX, TXT, JPG, PNG</p>
                </div>
            </div>

            <!-- –ò–ª–∏ —Ç–µ–∫—Å—Ç -->
            <div class="relative my-4">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">–∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç</span></div>
            </div>

            <!-- Textarea -->
            <textarea
                id="order-text"
                rows="5"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-y text-sm"
                placeholder="–¢—Ä—É–±–∞ –ø—Ä–æ—Ñ–∏–ª—å–Ω–∞—è 60—Ö40—Ö3 - 100–º&#10;–ê—Ä–º–∞—Ç—É—Ä–∞ 12 –ê500–° - 2.5—Ç&#10;–õ–∏—Å—Ç –≥/–∫ 5–º–º 1250—Ö2500 - 10—à—Ç"
            ></textarea>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="flex gap-4 mt-4">
                <button onclick="parseOrder()" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                    <span id="parse-spinner" class="spinner hidden"></span>
                    <span>–†–∞—Å–ø–∞—Ä—Å–∏—Ç—å</span>
                </button>
                <button onclick="addEmptyRow()" class="px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition">
                    + –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é
                </button>
                <button onclick="clearAll()" class="px-6 py-3 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition">
                    –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                </button>
            </div>
        </section>

        <!-- –°—Ç–∞—Ç—É—Å –ø–∞—Ä—Å–∏–Ω–≥–∞ -->
        <section id="parse-status" class="hidden bg-white rounded-lg shadow-md p-4 mb-6">
            <div id="parse-success" class="hidden flex items-center gap-2 text-green-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: <strong id="parsed-count">0</strong> –ø–æ–∑–∏—Ü–∏–π</span>
            </div>
            <div id="parse-error" class="hidden flex items-center gap-2 text-red-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span id="error-message">–û—à–∏–±–∫–∞</span>
            </div>
        </section>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–∑–∏—Ü–∏–π -->
        <section id="positions-section" class="hidden bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">2. –ü–æ–∑–∏—Ü–∏–∏ –∑–∞—è–≤–∫–∏</h2>
                <span id="positions-count" class="text-sm text-gray-500"></span>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm" id="positions-table">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-2 py-2 text-left w-8">#</th>
                            <th class="px-2 py-2 text-left min-w-[180px]">–¢–∏–ø –º–µ—Ç–∞–ª–ª–∞</th>
                            <th class="px-2 py-2 text-left min-w-[100px]">–†–∞–∑–º–µ—Ä</th>
                            <th class="px-2 py-2 text-left w-20">–í–µ—Å, —Ç</th>
                            <th class="px-2 py-2 text-left w-20 col-length">–î–ª–∏–Ω–∞, –º</th>
                            <th class="px-2 py-2 text-left w-20 col-pieces">–ö–æ–ª-–≤–æ, —à—Ç</th>
                            <th class="px-2 py-2 text-left w-24 col-length-piece">–î–ª. —à—Ç, –º</th>
                            <th class="px-2 py-2 text-left w-20 col-width">–®–∏—Ä–∏–Ω–∞, –º</th>
                            <th class="px-2 py-2 text-left w-20 col-length-sheet">–î–ª. –ª–∏—Å—Ç–∞, –º</th>
                            <th class="px-2 py-2 text-left w-24 col-steel">–ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏</th>
                            <th class="px-2 py-2 text-center w-16">–£–¥–∞–ª–∏—Ç—å</th>
                        </tr>
                    </thead>
                    <tbody id="positions-body">
                    </tbody>
                </table>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="mt-4 flex justify-end gap-4">
                <!-- –°–∫—Ä—ã—Ç–∞—è –∫–Ω–æ–ø–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) -->
                <button id="btn-calculate" onclick="calculateOrder()" class="hidden px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                    <span id="calc-spinner" class="spinner hidden"></span>
                    <span>–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</span>
                </button>
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ - –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å -->
                <button id="btn-supplier-request" onclick="submitSupplierRequest()" class="supplier-btn">
                    <span id="supplier-spinner" class="spinner hidden"></span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 2L11 13"></path>
                        <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
                    </svg>
                    <span>–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º</span>
                </button>
            </div>
        </section>

        <!-- –ò—Ç–æ–≥–∏ —Ä–∞—Å—á—ë—Ç–∞ -->
        <section id="results-section" class="hidden bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">3. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á—ë—Ç–∞</h2>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="text-sm text-blue-600 font-medium">–û–±—â–∏–π –≤–µ—Å</div>
                    <div class="text-2xl font-bold text-blue-800"><span id="total-weight">0</span> —Ç</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <div class="text-sm text-green-600 font-medium">–û–±—â–∞—è –¥–ª–∏–Ω–∞</div>
                    <div class="text-2xl font-bold text-green-800"><span id="total-length">0</span> –º</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-4">
                    <div class="text-sm text-purple-600 font-medium">–ü–æ–∑–∏—Ü–∏–π</div>
                    <div class="text-2xl font-bold text-purple-800"><span id="total-items">0</span></div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm text-gray-600 font-medium">–†–∞—Å—Å—á–∏—Ç–∞–Ω–æ</div>
                    <div class="text-2xl font-bold text-gray-800"><span id="calc-success">0</span>/<span id="calc-total">0</span></div>
                </div>
            </div>
        </section>

        <!-- –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º -->
        <div id="supplier-request-result" class="supplier-result-card" style="display: none;">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="result-header">
                <div class="result-icon">üìã</div>
                <div class="result-info">
                    <h3 id="result-request-id">–ó–ü-20251213-001</h3>
                    <p id="result-summary">0 –ø–æ–∑–∏—Ü–∏–π ‚Ä¢ 0 —Ç</p>
                </div>
                <div id="result-status" class="result-status">‚úÖ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ</div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∞—Ç—å Excel -->
            <div class="excel-download-section">
                <button id="btn-download-excel" class="btn-download-excel" onclick="downloadExcel()">
                    üì• –°–∫–∞—á–∞—Ç—å Excel –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                </button>
                <span class="excel-hint">–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å—ë –≤–µ—Ä–Ω–æ</span>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <div class="send-section">
                <p class="send-label">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å:</p>
                <div class="supplier-buttons">
                    <button id="btn-send-nn" class="btn-supplier btn-nn" onclick="sendToSuppliers('nn')">
                        üìç –ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥
                    </button>
                    <button id="btn-send-moscow" class="btn-supplier btn-moscow" onclick="sendToSuppliers('moscow')">
                        üèôÔ∏è –ú–æ—Å–∫–≤–∞ –∏ —Ä–µ–≥–∏–æ–Ω—ã
                    </button>
                    <button id="btn-send-factories" class="btn-supplier btn-factories" onclick="sendToSuppliers('factories')">
                        üè≠ –ó–∞–≤–æ–¥—ã
                    </button>
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º (–í–´–ù–ï–°–ï–ù –ù–ê–†–£–ñ–£!) -->
        <div id="active-requests-container" class="active-requests-container" style="display: none;">
            <div class="active-requests-header">
                <h4>üìä –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º</h4>
                <button id="btn-show-more-requests" class="btn-show-more" style="display: none;" onclick="toggleMoreRequests()">
                    –ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë (<span id="hidden-requests-count">0</span>)
                </button>
            </div>
            <div id="active-requests-list" class="active-requests-list">
                <!-- –ü–ª–∞—à–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>

        <footer class="text-center text-gray-500 text-sm mt-8">
            <p>MSG –ó–∞–∫—É–ø–∫–∏ v4.28</p>
        </footer>
    </div>
    </div><!-- /app-content -->

    <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä (—Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ—É–Ω–∫—Ü–∏—é calculateMetal) -->
    <script src="calculator.browser.js"></script>

    <!-- JavaScript -->
    <script>
    // ============================================================
    // –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
    // ============================================================
    const AUTH_KEY = 'msg_auth';
    const CREDENTIALS = { login: 'msg', password: 'Zakupki2024!#' };

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    function checkAuth() {
        const isAuth = sessionStorage.getItem(AUTH_KEY) === 'true';
        const loginOverlay = document.getElementById('login-overlay');
        const appContent = document.getElementById('app-content');
        const logoutBtn = document.getElementById('logout-btn');

        if (isAuth) {
            loginOverlay.style.display = 'none';
            appContent.classList.remove('hidden');
            logoutBtn.style.display = 'block';
        } else {
            loginOverlay.style.display = 'flex';
            appContent.classList.add('hidden');
            logoutBtn.style.display = 'none';
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞
    function handleLogin(event) {
        event.preventDefault();

        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;
        const errorEl = document.getElementById('login-error');

        if (username === CREDENTIALS.login && password === CREDENTIALS.password) {
            sessionStorage.setItem(AUTH_KEY, 'true');
            errorEl.classList.remove('show');
            checkAuth();
        } else {
            errorEl.classList.add('show');
            document.getElementById('login-password').value = '';
        }

        return false;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ö–æ–¥–∞
    function handleLogout() {
        sessionStorage.removeItem(AUTH_KEY);
        checkAuth();
        document.getElementById('login-username').value = '';
        document.getElementById('login-password').value = '';
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', checkAuth);

    // ============================================================
    // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
    // ============================================================
    const CONFIG = {
        API_BASE: 'https://primary-production-4e88.up.railway.app/webhook',
        ENDPOINTS: {
            PARSE: '/calc-parse',
            PARSE_FILE: '/calc-parse-file',
            CALCULATE: '/calc-calculate'
        },
        METALS_DB_URL: 'https://raw.githubusercontent.com/lamblackout/metal-calculator/main/docs/database/metals.json'
    };

    // ============================================================
    // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –ê–ö–¢–ò–í–ù–´–• –ó–ê–Ø–í–û–ö (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –Ω–∞—á–∞–ª–µ!)
    // ============================================================
    const ACTIVE_REQUESTS_KEY = 'metalCalc_activeRequests';
    const MAX_VISIBLE_REQUESTS = 5;
    let activeRequests = [];
    let requestTimers = {}; // –¢–∞–π–º–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    let requestSummaryData = {}; // –î–∞–Ω–Ω—ã–µ —Å–≤–æ–¥–æ–∫ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    let notifiedRequests = new Set(); // –ó–∞—è–≤–∫–∏ –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö —É–∂–µ –ø—Ä–æ–∏–≥—Ä–∞–Ω –∑–≤—É–∫

    // ============================================================
    // –¢–ò–ü–´ –ú–ï–¢–ê–õ–õ–û–í –ò –ò–• –ü–û–õ–Ø (–∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞)
    // ============================================================

    // –¢–∏–ø—ã —Å –ø–æ–ª–µ–º "–î–ª–∏–Ω–∞ 1 —à—Ç"
    const TYPES_WITH_LENGTH_PIECE = [
        'armature_a1', 'armature_a1_galv', 'armature_a3', 'armature_a3_galv',
        'armature_at800', 'armature_at1000',
        'beam', 'wire_rod', 'square',
        'circle', 'circle_galv',
        'strip', 'strip_galv', 'bulb_flat',
        'rels',
        'tryba_vgp', 'tryba_vgp_ocink', 'tryba_pnd',
        'tryba_gd', 'tryba_gd_ocink', 'tryba_bs_kotelnaya',
        'tryba_xd', 'tryba_xd_ocink',
        'tryba_es_kvadr', 'tryba_es_kvadr_ocink',
        'tryba_es_oval', 'tryba_es_oval_ocink',
        'tryba_es_ploskooval', 'tryba_es_ploskooval_ocink',
        'tryba_es_pr', 'tryba_es_pr_ocink',
        'tryba_es', 'tryba_es_ocink',
        'ygolok', 'ygolok_gnyt', 'ygolok_gnyt_ocink', 'ygolok_ocink',
        'shveller', 'shveller_gnyt', 'shveller_gnyt_ocink', 'shveller_ocink',
        'shestigrannik'
    ];

    // –¢–∏–ø—ã –ë–ï–ó –ø–æ–ª—è "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç—É–∫" (—Ç–æ–ª—å–∫–æ –í–µ—Å –∏ –î–ª–∏–Ω–∞)
    const TYPES_WITHOUT_PIECES = [
        'rope', 'rope_armature', 'rope_galv',
        'wire', 'wire_galv',
        'profnastil_okrash', 'profnastil_ocink',
        'sytynka',
        'shpynt_dvutavroviy', 'shpynt_larsen', 'shpynt_pvh',
        'shpynt_trubchatiy', 'shpynt_holodnognutiy'
    ];

    // –ö—Ä–µ–ø–µ–∂–∏ (—Ç–æ–ª—å–∫–æ –í–µ—Å –∏ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ, –ë–ï–ó –ø–æ–ª—è –î–ª–∏–Ω–∞)
    const FASTENER_TYPES = [
        'bolt', 'screw', 'nut', 'nail', 'selftapping',
        'washer', 'stud', 'cotter', 'woodscrew'
    ];

    // –õ–∏—Å—Ç–æ–≤—ã–µ —Ç–∏–ø—ã (–®–∏—Ä–∏–Ω–∞ –∏ –î–ª–∏–Ω–∞ –ª–∏—Å—Ç–∞ –≤–º–µ—Å—Ç–æ –î–ª–∏–Ω—ã)
    const SHEET_TYPES = [
        'sheet_hot', 'sheet_cold', 'sheet_galv', 'sheet_painted',
        'sheet_riffle', 'sheet_pv', 'sheet_korr', 'sheet_pvl',
        'plate_hot', 'plate_cold',
        'tape', 'tape_galv', 'tape_cold'
    ];

    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –¥–ª–∏–Ω—ã –¥–ª—è —Ç–∏–ø–æ–≤
    const STANDARD_LENGTHS = {
        'armature_a1': [6, 11.7], 'armature_a1_galv': [6, 11.7],
        'armature_a3': [6, 11.7], 'armature_a3_galv': [6, 11.7],
        'armature_at800': [6, 9.9, 10, 11.7], 'armature_at1000': [6, 9.9, 10, 11.7],
        'beam': [12],
        'wire_rod': [6, 11.7],
        'shveller': [6, 12], 'shveller_ocink': [6, 12],
        'shveller_gnyt': [3, 6, 12], 'shveller_gnyt_ocink': [3, 6, 12],
        'tryba_vgp': [6, 7.8, 10], 'tryba_vgp_ocink': [6, 7.8, 10],
        'tryba_es_kvadr': [6, 12], 'tryba_es_kvadr_ocink': [6, 12],
        'tryba_es_pr': [6, 12], 'tryba_es_pr_ocink': [6, 12],
        'tryba_es': [6, 10, 11.7, 12], 'tryba_es_ocink': [6, 10, 11.7, 12],
        'square': [6],
        'circle': [6], 'circle_galv': [6],
        'strip': [6], 'strip_galv': [6], 'bulb_flat': [6],
        'ygolok': [6, 12], 'ygolok_ocink': [6, 12],
        'ygolok_gnyt': [6, 12], 'ygolok_gnyt_ocink': [6, 12],
        'shestigrannik': [6],
        'rels': [12.5, 25]
    };

    // –ú–∞—Ä–∫–∏ —Å—Ç–∞–ª–∏ —Å –ø–ª–æ—Ç–Ω–æ—Å—Ç—å—é
    const STEEL_GRADES = [
        { value: '—Å—Ç3', name: '—Å—Ç3', density: 7.85 },
        { value: '—Å—Ç0', name: '—Å—Ç0', density: 7.85 },
        { value: '—Å—Ç10', name: '—Å—Ç10', density: 7.856 },
        { value: '—Å—Ç20', name: '—Å—Ç20', density: 7.859 },
        { value: '—Å—Ç35', name: '—Å—Ç35', density: 7.826 },
        { value: '—Å—Ç45', name: '—Å—Ç45', density: 7.826 },
        { value: '09–ì2–°', name: '09–ì2–°', density: 7.85 },
        { value: '40–•', name: '40–•', density: 7.85 },
        { value: '65–ì', name: '65–ì', density: 7.85 }
    ];

    // ‚úÖ –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –ª–∏—Å—Ç–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    // –î–ª—è –ª–∏—Å—Ç–æ–≤ standardSizes = [[—à–∏—Ä–∏–Ω–∞_–º–º, –¥–ª–∏–Ω–∞_–º–º], ...], –Ω–∞–ø—Ä–∏–º–µ—Ä [[1250, 2500]]
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –º–µ—Ç—Ä–∞—Ö
    function getDefaultSheetWidth(metalKey) {
        if (!metalKey || !SHEET_TYPES.includes(metalKey)) return '';
        const metal = state.metalsDB?.[metalKey];
        if (!metal?.standardSizes?.length) return 1.25; // –î–µ—Ñ–æ–ª—Ç 1.25–º
        const firstSize = metal.standardSizes[0];
        if (Array.isArray(firstSize) && firstSize.length >= 1) {
            return firstSize[0] / 1000; // –º–º ‚Üí –º
        }
        return 1.25;
    }

    function getDefaultSheetLength(metalKey) {
        if (!metalKey || !SHEET_TYPES.includes(metalKey)) return '';
        const metal = state.metalsDB?.[metalKey];
        if (!metal?.standardSizes?.length) return 2.5; // –î–µ—Ñ–æ–ª—Ç 2.5–º
        const firstSize = metal.standardSizes[0];
        if (Array.isArray(firstSize) && firstSize.length >= 2) {
            return firstSize[1] / 1000; // –º–º ‚Üí –º
        }
        return 2.5;
    }

    // ============================================================
    // –°–û–°–¢–û–Ø–ù–ò–ï
    // ============================================================
    let state = {
        items: [],
        metalsDB: null,
        metalsList: [],
        calcResults: null
    };

    // ============================================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ============================================================
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('üöÄ DOMContentLoaded started');

        // –°–ù–ê–ß–ê–õ–ê –∑–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏ (–Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞!)
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫...');
        console.log('üì¶ ACTIVE_REQUESTS_KEY:', ACTIVE_REQUESTS_KEY);
        console.log('üì¶ localStorage raw:', localStorage.getItem(ACTIVE_REQUESTS_KEY));
        loadActiveRequests();
        console.log('üì¶ activeRequests –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏:', activeRequests);
        renderActiveRequests();

        localStorage.removeItem('metalCalcState'); // –ß–∏—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ calculator.browser.js –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
        if (typeof window.calculateMetal !== 'function') {
            console.error('‚ùå –û–®–ò–ë–ö–ê: window.calculateMetal –Ω–µ –Ω–∞–π–¥–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É calculator.browser.js');
            alert('–û—à–∏–±–∫–∞: –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
            return;
        }
        console.log('‚úÖ calculateMetal –¥–æ—Å—Ç—É–ø–Ω–∞');

        await loadMetalsDatabase();
        setupDragAndDrop();

        // –¢–µ—Å—Ç–æ–≤—ã–π –≤—ã–∑–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
        testCalculations();
    });

    function testCalculations() {
        if (!state.metalsDB) return;
        const metalDatabase = { metals: state.metalsDB };

        // –¢–µ—Å—Ç 1: –õ–∏—Å—Ç –≥/–∫ —Ç–æ–ª—â–∏–Ω–∞ 8–º–º, –≤–µ—Å 0.283—Ç
        const testSheet = window.calculateMetal({
            metalType: 'sheet_hot',
            size: 8,
            weight: 0.283,
            steelType: '—Å—Ç3'
        }, metalDatabase);
        console.log('üß™ –¢–ï–°–¢ –õ–∏—Å—Ç 8–º–º 0.283—Ç:', testSheet);

        // –¢–µ—Å—Ç 2: –ë–∞–ª–∫–∞ 40–®1, –≤–µ—Å 1—Ç
        const testBeam = window.calculateMetal({
            metalType: 'beam',
            size: '40–®1',
            weight: 1,
            steelType: '—Å—Ç3'
        }, metalDatabase);
        console.log('üß™ –¢–ï–°–¢ –ë–∞–ª–∫–∞ 40–®1 1—Ç:', testBeam);
    }

    async function loadMetalsDatabase() {
        try {
            const response = await fetch(CONFIG.METALS_DB_URL);
            const data = await response.json();
            state.metalsDB = data.metals;

            // –°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ –¥–ª—è dropdown —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            const categories = {};
            for (const [key, metal] of Object.entries(data.metals)) {
                const cat = metal.category || '–î—Ä—É–≥–æ–µ';
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push({ key, name: metal.name || key, metal });
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const catOrder = [
                '–ê—Ä–º–∞—Ç—É—Ä–∞', '–ë–∞–ª–∫–∞', '–ö–∞–Ω–∞—Ç', '–ö–∞—Ç–∞–Ω–∫–∞', '–ö–≤–∞–¥—Ä–∞—Ç', '–ö—Ä–µ–ø–µ–∂', '–ö—Ä—É–≥',
                '–õ–µ–Ω—Ç–∞/—à—Ç—Ä–∏–ø—Å', '–õ–∏—Å—Ç/—Ä—É–ª–æ–Ω', '–ü–ª–∏—Ç–∞', '–ü–æ–ª–æ—Å–∞', '–ü–æ–ª–æ—Å–æ–±—É–ª—å–±', '–ü—Ä–æ–≤–æ–ª–æ–∫–∞',
                '–ü—Ä–æ—Ñ–Ω–∞—Å—Ç–∏–ª', '–†–µ–ª—å—Å', '–°—É—Ç—É–Ω–∫–∞', '–¢—Ä—É–±–∞', '–£–≥–æ–ª–æ–∫', '–®–≤–µ–ª–ª–µ—Ä',
                '–®–µ—Å—Ç–∏–≥—Ä–∞–Ω–Ω–∏–∫', '–®–ø—É–Ω—Ç'
            ];

            state.metalsList = [];
            for (const cat of catOrder) {
                if (categories[cat]) {
                    categories[cat].sort((a, b) => a.name.localeCompare(b.name, 'ru'));
                    for (const m of categories[cat]) {
                        state.metalsList.push({ ...m, category: cat });
                    }
                }
            }
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            for (const [cat, metals] of Object.entries(categories)) {
                if (!catOrder.includes(cat)) {
                    metals.sort((a, b) => a.name.localeCompare(b.name, 'ru'));
                    for (const m of metals) {
                        state.metalsList.push({ ...m, category: cat });
                    }
                }
            }

            console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${state.metalsList.length} —Ç–∏–ø–æ–≤ –º–µ—Ç–∞–ª–ª–∞`);
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã:', e);
        }
    }

    // ============================================================
    // –ü–û–õ–£–ß–ï–ù–ò–ï –†–ê–ó–ú–ï–†–û–í –î–õ–Ø –¢–ò–ü–ê –ú–ï–¢–ê–õ–õ–ê
    // ============================================================
    function getSizesForMetal(metalKey) {
        const metal = state.metalsDB?.[metalKey];
        if (!metal) return [];

        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: sizes > thicknesses > railTypes > weights keys
        if (metal.sizes && metal.sizes.length > 0) {
            return metal.sizes.map(s => {
                if (Array.isArray(s)) return s.join('√ó');
                return String(s);
            });
        }
        if (metal.thicknesses && metal.thicknesses.length > 0) {
            return metal.thicknesses.map(t => String(t));
        }
        if (metal.railTypes && metal.railTypes.length > 0) {
            return metal.railTypes;
        }
        if (metal.weights && Object.keys(metal.weights).length > 0) {
            return Object.keys(metal.weights);
        }
        return [];
    }

    // ============================================================
    // –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –¢–ò–ü–ê –ü–û–õ–ï–ô
    // ============================================================
    function getFieldsConfig(metalKey) {
        const isSheet = SHEET_TYPES.includes(metalKey);
        const isFastener = FASTENER_TYPES.includes(metalKey);
        const hasLengthPiece = TYPES_WITH_LENGTH_PIECE.includes(metalKey);
        const noPieces = TYPES_WITHOUT_PIECES.includes(metalKey);

        return {
            showWeight: true,  // –í–µ—Å –≤—Å–µ–≥–¥–∞
            showLength: !isSheet && !isFastener,  // –î–ª–∏–Ω–∞ (–Ω–µ –¥–ª—è –ª–∏—Å—Ç–æ–≤ –∏ –∫—Ä–µ–ø–µ–∂–∞)
            showPieces: !noPieces,  // –®—Ç—É–∫–∏ (–Ω–µ –¥–ª—è –∫–∞–Ω–∞—Ç–æ–≤, –ø—Ä–æ–≤–æ–ª–æ–∫–∏ –∏ —Ç.–¥.)
            showLengthPiece: hasLengthPiece && !isSheet,  // –î–ª–∏–Ω–∞ 1 —à—Ç
            showWidth: isSheet,  // –®–∏—Ä–∏–Ω–∞ –ª–∏—Å—Ç–∞
            showLengthSheet: isSheet,  // –î–ª–∏–Ω–∞ –ª–∏—Å—Ç–∞
            showSteel: true,  // –ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏ –≤—Å–µ–≥–¥–∞
            isSheet,
            isFastener
        };
    }

    // ============================================================
    // DRAG & DROP
    // ============================================================
    function setupDragAndDrop() {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'));
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'));
        });

        dropZone.addEventListener('drop', e => {
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFiles(files);
        });

        fileInput.addEventListener('change', e => {
            if (e.target.files.length > 0) handleFiles(e.target.files);
        });
    }

    async function handleFiles(files) {
        const file = files[0];
        const ext = file.name.split('.').pop().toLowerCase();

        showSpinner('parse-spinner', true);

        try {
            if (ext === 'txt') {
                const text = await file.text();
                document.getElementById('order-text').value = text;
                await parseOrder();
            } else if (CONFIG.API_BASE) {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(CONFIG.API_BASE + CONFIG.ENDPOINTS.PARSE_FILE, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success && data.items) {
                    console.log('üì• –î–∞–Ω–Ω—ã–µ –æ—Ç –ø–∞—Ä—Å–µ—Ä–∞:', JSON.stringify(data.items, null, 2));
                    state.items = data.items.map((item, i) => normalizeItem(item, i));
                    console.log('üìä –ü–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:', JSON.stringify(state.items, null, 2));
                    renderTable();
                    showParseSuccess(state.items.length);
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç
                    setTimeout(() => calculateOrder(), 100);
                } else {
                    showParseError(data.error || '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ñ–∞–π–ª–∞');
                }
            } else {
                alert('–î–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ PDF/XLSX/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ n8n');
            }
        } catch (e) {
            showParseError(e.message);
        } finally {
            showSpinner('parse-spinner', false);
        }
    }

    // ============================================================
    // –ü–ê–†–°–ò–ù–ì
    // ============================================================
    async function parseOrder() {
        const text = document.getElementById('order-text').value.trim();
        if (!text) {
            alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞—è–≤–∫–∏');
            return;
        }

        showSpinner('parse-spinner', true);

        try {
            let items;

            if (CONFIG.API_BASE) {
                const response = await fetch(CONFIG.API_BASE + CONFIG.ENDPOINTS.PARSE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                const data = await response.json();
                items = data.items || [];
            } else {
                items = parseLocalOrder(text);
            }

            console.log('üì• –î–∞–Ω–Ω—ã–µ –æ—Ç –ø–∞—Ä—Å–µ—Ä–∞:', JSON.stringify(items, null, 2));
            state.items = items.map((item, i) => normalizeItem(item, i));
            console.log('üìä –ü–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:', JSON.stringify(state.items, null, 2));
            saveState();
            renderTable();
            showParseSuccess(state.items.length);
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç
            setTimeout(() => calculateOrder(), 100);

        } catch (e) {
            showParseError(e.message);
        } finally {
            showSpinner('parse-spinner', false);
        }
    }

    // ============================================================
    // –ü–û–ò–°–ö –¢–ò–ü–ê –ú–ï–¢–ê–õ–õ–ê (fuzzy matching)
    // ============================================================
    function findMetalType(name) {
        if (!name || !state.metalsDB) return null;

        const nameLower = name.toLowerCase();

        // ‚úÖ –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê –¥–ª—è —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—â–∏—Ö—Å—è –Ω–∞–∑–≤–∞–Ω–∏–π

        // –õ–ò–°–¢–´ - –≤–∞–∂–Ω–æ —Ä–∞–∑–ª–∏—á–∞—Ç—å –≥/–∫, —Ö/–∫, –æ—Ü–∏–Ω–∫ –∏ —Ç.–¥.
        if (nameLower.includes('–ª–∏—Å—Ç') || nameLower.includes('—Ä—É–ª–æ–Ω')) {
            // –õ–∏—Å—Ç —Ä–∏—Ñ–ª–µ–Ω—ã–π
            if (nameLower.includes('—Ä–∏—Ñ–ª')) {
                console.log(`üìã "–õ–∏—Å—Ç" —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ –õ–∏—Å—Ç —Ä–∏—Ñ–ª–µ–Ω—ã–π`);
                return { key: 'sheet_checkered', name: '–õ–∏—Å—Ç —Ä–∏—Ñ–ª–µ–Ω—ã–π' };
            }
            // –õ–∏—Å—Ç –ü–í –æ—Ü–∏–Ω–∫–æ–≤–∞–Ω–Ω—ã–π
            if (nameLower.includes('–ø–≤') && (nameLower.includes('–æ—Ü–∏–Ω–∫') || nameLower.includes('–æ—Ü'))) {
                console.log(`üìã "–õ–∏—Å—Ç" —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ –õ–∏—Å—Ç –ü–í –æ—Ü–∏–Ω–∫.`);
                return { key: 'sheet_pv_galv', name: '–õ–∏—Å—Ç –ü–í –æ—Ü–∏–Ω–∫.' };
            }
            // –õ–∏—Å—Ç –ü–í
            if (nameLower.includes('–ø–≤')) {
                console.log(`üìã "–õ–∏—Å—Ç" —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ –õ–∏—Å—Ç –ü–í`);
                return { key: 'sheet_pv', name: '–õ–∏—Å—Ç –ü–í' };
            }
            // –õ–∏—Å—Ç –æ—Ü–∏–Ω–∫–æ–≤–∞–Ω–Ω—ã–π
            if (nameLower.includes('–æ—Ü–∏–Ω–∫') || nameLower.match(/\b–æ—Ü\b/)) {
                console.log(`üìã "–õ–∏—Å—Ç" —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ –õ–∏—Å—Ç/—Ä—É–ª–æ–Ω –æ—Ü–∏–Ω–∫.`);
                return { key: 'sheet_galv', name: '–õ–∏—Å—Ç/—Ä—É–ª–æ–Ω –æ—Ü–∏–Ω–∫.' };
            }
            // –õ–∏—Å—Ç –æ–∫—Ä–∞—à–µ–Ω–Ω—ã–π
            if (nameLower.includes('–æ–∫—Ä–∞—à') || nameLower.includes('–∫—Ä–∞—à–µ–Ω')) {
                console.log(`üìã "–õ–∏—Å—Ç" —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ –õ–∏—Å—Ç/—Ä—É–ª–æ–Ω –æ–∫—Ä–∞—à.`);
                return { key: 'sheet_painted', name: '–õ–∏—Å—Ç/—Ä—É–ª–æ–Ω –æ–∫—Ä–∞—à.' };
            }
            // –õ–∏—Å—Ç —Ö–æ–ª–æ–¥–Ω–æ–∫–∞—Ç–∞–Ω—ã–π
            if (nameLower.includes('—Ö/–∫') || nameLower.includes('—Ö–∫') || nameLower.includes('—Ö–æ–ª–æ–¥–Ω')) {
                console.log(`üìã "–õ–∏—Å—Ç" —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ –õ–∏—Å—Ç/—Ä—É–ª–æ–Ω —Ö/–∫`);
                return { key: 'sheet_cold', name: '–õ–∏—Å—Ç/—Ä—É–ª–æ–Ω —Ö/–∫' };
            }
            // –õ–∏—Å—Ç –≥–æ—Ä—è—á–µ–∫–∞—Ç–∞–Ω—ã–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ª–∏—Å—Ç–æ–≤)
            console.log(`üìã "–õ–∏—Å—Ç" —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ –õ–∏—Å—Ç/—Ä—É–ª–æ–Ω –≥/–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)`);
            return { key: 'sheet_hot', name: '–õ–∏—Å—Ç/—Ä—É–ª–æ–Ω –≥/–∫' };
        }

        // –ë–ê–õ–ö–ò
        if (nameLower.includes('–±–∞–ª–∫') || nameLower.includes('–¥–≤—É—Ç–∞–≤—Ä')) {
            console.log(`üìã "–ë–∞–ª–∫–∞" —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ –ë–∞–ª–∫–∞`);
            return { key: 'beam', name: '–ë–∞–ª–∫–∞' };
        }

        // –®–í–ï–õ–õ–ï–†–´
        if (nameLower.includes('—à–≤–µ–ª–ª–µ—Ä')) {
            if (nameLower.includes('–æ—Ü–∏–Ω–∫') || nameLower.includes('–æ—Ü')) {
                console.log(`üìã "–®–≤–µ–ª–ª–µ—Ä" —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ –®–≤–µ–ª–ª–µ—Ä –æ—Ü–∏–Ω–∫.`);
                return { key: 'shveller_ocink', name: '–®–≤–µ–ª–ª–µ—Ä –æ—Ü–∏–Ω–∫.' };
            }
            console.log(`üìã "–®–≤–µ–ª–ª–µ—Ä" —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ –®–≤–µ–ª–ª–µ—Ä`);
            return { key: 'shveller', name: '–®–≤–µ–ª–ª–µ—Ä' };
        }

        // –ü—Ä–æ—Ñ–∏–ª—å = –ø—Ä–æ—Ñ–∏–ª—å–Ω–∞—è —Ç—Ä—É–±–∞ (–∫–≤–∞–¥—Ä–∞—Ç–Ω–∞—è –∏–ª–∏ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∞—è)
        if (nameLower.includes('–ø—Ä–æ—Ñ–∏–ª—å')) {
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã: "–ü—Ä–æ—Ñ–∏–ª—å 180x180x6" –∏–ª–∏ "–ü—Ä–æ—Ñ–∏–ª—å 140x7" (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π)
            const sizeMatch = nameLower.match(/(\d+)[x—ÖX√ó](\d+)(?:[x—ÖX√ó](\d+))?/);
            if (sizeMatch) {
                const a = parseInt(sizeMatch[1]);
                const b = parseInt(sizeMatch[2]);
                const c = sizeMatch[3] ? parseInt(sizeMatch[3]) : null;

                // ‚úÖ –õ–û–ì–ò–ö–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –¢–ò–ü–ê –¢–†–£–ë–´:
                // 1. "140—Ö140—Ö7" (3 —á–∏—Å–ª–∞, a==b) ‚Üí –∫–≤–∞–¥—Ä–∞—Ç–Ω–∞—è
                // 2. "140—Ö7" (2 —á–∏—Å–ª–∞, b‚â§12) ‚Üí —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ö–í–ê–î–†–ê–¢–ù–û–ô —Ç—Ä—É–±—ã (140—Ö140—Ö7)
                // 3. "180—Ö140—Ö6" (3 —á–∏—Å–ª–∞, a‚â†b) ‚Üí –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∞—è
                // 4. "180—Ö140" (2 —á–∏—Å–ª–∞, b>12) ‚Üí –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∞—è (–±–µ–∑ —Ç–æ–ª—â–∏–Ω—ã)

                if (c !== null) {
                    // 3 —á–∏—Å–ª–∞: AxBxT
                    if (a === b) {
                        console.log(`üìê "–ü—Ä–æ—Ñ–∏–ª—å" —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ –¢—Ä—É–±–∞ –∫–≤–∞–¥—Ä. (${a}x${b}x${c})`);
                        return { key: 'tryba_es_kvadr', name: '–¢—Ä—É–±–∞ –∫–≤–∞–¥—Ä.' };
                    } else {
                        console.log(`üìê "–ü—Ä–æ—Ñ–∏–ª—å" —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ –¢—Ä—É–±–∞ –ø—Ä—è–º–æ—É–≥. (${a}x${b}x${c})`);
                        return { key: 'tryba_es_pr', name: '–¢—Ä—É–±–∞ –ø—Ä—è–º–æ—É–≥.' };
                    }
                } else {
                    // 2 —á–∏—Å–ª–∞: AxT (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π) –∏–ª–∏ AxB (–±–µ–∑ —Ç–æ–ª—â–∏–Ω—ã)
                    if (b <= 12) {
                        // b —ç—Ç–æ —Ç–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω–∫–∏ ‚Üí —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ö–í–ê–î–†–ê–¢–ù–û–ô —Ç—Ä—É–±—ã
                        console.log(`üìê "–ü—Ä–æ—Ñ–∏–ª—å" —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ –¢—Ä—É–±–∞ –∫–≤–∞–¥—Ä. (—Å–æ–∫—Ä–∞—â. ${a}x${b} ‚Üí ${a}x${a}x${b})`);
                        return { key: 'tryba_es_kvadr', name: '–¢—Ä—É–±–∞ –∫–≤–∞–¥—Ä.' };
                    } else {
                        // b —ç—Ç–æ –≤—Ç–æ—Ä–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ ‚Üí –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∞—è (–±–µ–∑ —Ç–æ–ª—â–∏–Ω—ã)
                        console.log(`üìê "–ü—Ä–æ—Ñ–∏–ª—å" —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ –¢—Ä—É–±–∞ –ø—Ä—è–º–æ—É–≥. (${a}x${b})`);
                        return { key: 'tryba_es_pr', name: '–¢—Ä—É–±–∞ –ø—Ä—è–º–æ—É–≥.' };
                    }
                }
            }
        }

        // –°–æ–∫—Ä–∞—â–µ–Ω–∏—è
        const ABBR = {
            '—ç/—Å': '—ç–ª–µ–∫—Ç—Ä–æ—Å–≤–∞—Ä–Ω', '—ç—Å': '—ç–ª–µ–∫—Ç—Ä–æ—Å–≤–∞—Ä–Ω',
            '–±/—à': '–±–µ—Å—à–æ–≤–Ω', '–±—à': '–±–µ—Å—à–æ–≤–Ω',
            '–≥/–∫': '–≥–æ—Ä—è—á–µ–∫–∞—Ç–∞–Ω', '–≥–∫': '–≥–æ—Ä—è—á–µ–∫–∞—Ç–∞–Ω',
            '—Ö/–∫': '—Ö–æ–ª–æ–¥–Ω–æ–∫–∞—Ç–∞–Ω', '—Ö–∫': '—Ö–æ–ª–æ–¥–Ω–æ–∫–∞—Ç–∞–Ω',
            '–æ—Ü': '–æ—Ü–∏–Ω–∫', '–≤–≥–ø': '–≤–æ–¥–æ–≥–∞–∑–æ–ø—Ä–æ–≤–æ–¥',
            '–ø—Ä–æ—Ñ': '–ø—Ä–æ—Ñ–∏–ª—å–Ω', '–ø—Ä': '–ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω',
            '–∫–≤': '–∫–≤–∞–¥—Ä–∞—Ç–Ω', '–¥–≤': '–¥–≤—É—Ç–∞–≤—Ä'
        };

        let expanded = nameLower;
        for (const [short, full] of Object.entries(ABBR)) {
            expanded = expanded.replace(new RegExp(short, 'gi'), full);
        }

        // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        for (const [key, metal] of Object.entries(state.metalsDB)) {
            if (metal.name?.toLowerCase() === nameLower) {
                return { key, name: metal.name };
            }
        }

        // –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        const keywords = expanded
            .replace(/\d+[x—ÖX√ó*]\d+([x—ÖX√ó*]\d+)?/g, '')
            .replace(/\d+([.,]\d+)?/g, '')
            .replace(/[^\w–∞-—è—ë]/gi, ' ')
            .split(/\s+/)
            .filter(w => w.length > 2);

        let bestMatch = null;
        let bestScore = 0;

        for (const [key, metal] of Object.entries(state.metalsDB)) {
            const metalName = (metal.name || '').toLowerCase();
            let score = 0;

            for (const kw of keywords) {
                if (metalName.includes(kw)) score += kw.length * 2;
                if (key.toLowerCase().includes(kw)) score += kw.length;
            }

            if (score > bestScore) {
                bestScore = score;
                bestMatch = { key, name: metal.name };
            }
        }

        return bestScore >= 5 ? bestMatch : null;
    }

    function normalizeItem(item, index) {
        let metalKey = item.metal_key;
        let metalName = item.metal_name || item.name || '';

        // –ê–≤—Ç–æ–ø–æ–∏—Å–∫ —Ç–∏–ø–∞
        if (!metalKey && metalName && state.metalsDB) {
            const found = findMetalType(metalName);
            if (found) metalKey = found.key;
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥ –ø–æ–ª–µ–π
        const config = getFieldsConfig(metalKey);

        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
        let size = item.size || '';
        if (!size && metalName) {
            const match = metalName.match(/(\d+(?:[.,]\d+)?)[—Öx√ó*](\d+(?:[.,]\d+)?)(?:[—Öx√ó*](\d+(?:[.,]\d+)?))?/);
            if (match) size = match[0].replace(/[xX*√ó]/g, '—Ö');
            else {
                const single = metalName.match(/\b(\d+(?:[.,]\d+)?)\s*(?:–º–º)?\b/);
                if (single) size = single[1];
            }
        }

        // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –¥–ª–∏–Ω–∞ —à—Ç—É–∫–∏
        let lengthPiece = item.length_per_piece || '';
        if (!lengthPiece && metalKey && STANDARD_LENGTHS[metalKey]) {
            lengthPiece = STANDARD_LENGTHS[metalKey][0];
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —á–∏—Å–ª–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏ (—É–±–∏—Ä–∞–µ—Ç –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è –∏ –∑–∞–ø—è—Ç—ã–µ)
        const parseNum = (val) => {
            if (!val && val !== 0) return '';
            if (typeof val === 'number') return val;
            // –£–±–∏—Ä–∞–µ–º –µ–¥–∏–Ω–∏—Ü—ã –∏ –ø–∞—Ä—Å–∏–º: "231 –º" -> 231, "4,5–º.–∫–≤" -> 4.5, "20,467" -> 20.467
            const str = String(val).replace(/[^\d,.\-]/g, '').replace(',', '.');
            const num = parseFloat(str);
            return isNaN(num) ? '' : num;
        };

        // –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –ø–∞—Ä—Å–∏–Ω–≥–∞
        const rawWeight = parseNum(item.weight || item.tons || item.weight_tons || item.—Ç–æ–Ω–Ω—ã || item.–≤–µ—Å || item.–¢–Ω);
        const rawLength = parseNum(item.length || item.meters || item.length_meters || item.–º–µ—Ç—Ä—ã || item.–¥–ª–∏–Ω–∞ || item.–ú–µ—Ç—Ä—ã);
        const rawPieces = parseNum(item.pieces || item.count || item.—à—Ç || item.—à—Ç—É–∫–∏);
        const rawQuantity = parseNum(item.quantity || item.–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è
        let unit = (item.unit || item.–µ–¥–∏–Ω–∏—Ü–∞ || '').toLowerCase();
        if (!unit && item.quantity) {
            // –ü—Ä–æ–±—É–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑ —Å—Ç—Ä–æ–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            const qtyStr = String(item.quantity || '').toLowerCase();
            if (qtyStr.includes('—Ç') || qtyStr.includes('—Ç–Ω')) unit = '—Ç–Ω';
            else if (qtyStr.includes('–º¬≤') || qtyStr.includes('–º.–∫–≤') || qtyStr.includes('–∫–≤')) unit = '–º¬≤';
            else if (qtyStr.includes('—à—Ç')) unit = '—à—Ç';
            else if (qtyStr.includes('–º')) unit = '–º';
        }

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ quantity + unit
        let weight = rawWeight;
        let length = rawLength;
        let pieces = rawPieces;

        if (rawQuantity && !weight && !length && !pieces) {
            // –ï—Å—Ç—å —Ç–æ–ª—å–∫–æ quantity - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ unit
            if (unit === '—Ç–Ω' || unit === '—Ç') {
                weight = rawQuantity;
            } else if (unit === '–º' || unit === '–º–µ—Ç—Ä') {
                length = rawQuantity;
            } else if (unit === '—à—Ç' || unit === '—à—Ç—É–∫') {
                pieces = rawQuantity;
            } else if (unit === '–º¬≤' || unit === '–º.–∫–≤') {
                // –î–ª—è –º¬≤ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –ø–ª–æ—â–∞–¥—å, –ø–æ–∑–∂–µ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ–º
                length = rawQuantity; // –≤—Ä–µ–º–µ–Ω–Ω–æ
            } else {
                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - —à—Ç—É–∫–∏
                pieces = rawQuantity;
            }
        }

        // ‚úÖ –ò–°–•–û–î–ù–´–ô –í–ï–° –∏–∑ –∑–∞—è–≤–∫–∏ - —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –∏ –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
        // –≠—Ç–æ "—Å–≤—è—â–µ–Ω–Ω–æ–µ" –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—Å–µ–≥–¥–∞ –≤–µ–¥—ë—Ç—Å—è –ø–µ—Ä–µ—Å—á—ë—Ç
        const originalWeight = item.original_weight !== undefined
            ? item.original_weight
            : (weight || rawQuantity || null);

        return {
            index: index + 1,
            metal_key: metalKey || '',
            metal_name: metalName,
            size: size,
            weight: weight,
            length: length,
            pieces: pieces,
            quantity: rawQuantity || '',
            unit: unit || '—à—Ç',
            length_per_piece: lengthPiece,
            // ‚úÖ –î–ª—è –ª–∏—Å—Ç–æ–≤: –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∏–∑ standardSizes –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            width: item.width || item.—à–∏—Ä–∏–Ω–∞ || getDefaultSheetWidth(metalKey),
            length_sheet: item.length_sheet || item.–¥–ª–∏–Ω–∞_–ª–∏—Å—Ç–∞ || getDefaultSheetLength(metalKey),
            steel_grade: item.steel_grade || item.–º–∞—Ä–∫–∞_—Å—Ç–∞–ª–∏ || '—Å—Ç3',
            raw_text: item.raw_text || metalName,
            original_weight: originalWeight,  // ‚úÖ –ò—Å—Ö–æ–¥–Ω—ã–π –≤–µ—Å –∏–∑ –∑–∞—è–≤–∫–∏
            _config: config
        };
    }

    function parseLocalOrder(text) {
        const lines = text.split('\n').filter(l => l.trim());
        return lines.map((line, i) => ({ name: line.trim(), raw_text: line }));
    }

    // ============================================================
    // –¢–ê–ë–õ–ò–¶–ê
    // ============================================================
    function renderTable() {
        const tbody = document.getElementById('positions-body');
        tbody.innerHTML = '';

        state.items.forEach((item, i) => {
            tbody.appendChild(createRow(item, i));
        });

        document.getElementById('positions-section').classList.remove('hidden');
        document.getElementById('positions-count').textContent = `${state.items.length} –ø–æ–∑–∏—Ü–∏–π`;

        updateColumnVisibility();
    }

    function createRow(item, index) {
        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gray-50';
        tr.dataset.index = index;

        const config = item._config || getFieldsConfig(item.metal_key);
        const sizes = getSizesForMetal(item.metal_key);
        const sizeInList = sizes.includes(String(item.size));
        const standardLengths = STANDARD_LENGTHS[item.metal_key] || [];

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω –ª–∏ –º–µ—Ç–∞–ª–ª –≤ –±–∞–∑–µ
        const metalInDB = item.metal_key && state.metalsDB?.[item.metal_key];

        tr.innerHTML = `
            <td class="px-2 py-2 text-gray-500">${item.index}</td>

            <!-- –¢–∏–ø –º–µ—Ç–∞–ª–ª–∞ -->
            <td class="px-2 py-2">
                <select class="table-select" onchange="onMetalChange(${index}, this.value)">
                    <option value="">${item.metal_name && !metalInDB ? item.metal_name + ' (?)' : '-- –í—ã–±–µ—Ä–∏—Ç–µ --'}</option>
                    ${renderMetalOptions(item.metal_key)}
                </select>
                ${item.metal_name && !metalInDB ? `<div class="text-xs text-orange-600 mt-1">${item.metal_name}</div>` : ''}
            </td>

            <!-- –†–∞–∑–º–µ—Ä -->
            <td class="px-2 py-2">
                ${sizes.length > 0 ? `
                    <select class="table-select" onchange="onSizeChange(${index}, this.value)">
                        <option value="">-- –†–∞–∑–º–µ—Ä --</option>
                        ${sizes.map(s => `<option value="${s}" ${String(s) === String(item.size) ? 'selected' : ''}>${s}</option>`).join('')}
                        <option value="_custom" ${item.size && !sizeInList ? 'selected' : ''}>–î—Ä—É–≥–æ–π...</option>
                    </select>
                    ${item.size && !sizeInList ? `<input type="text" class="table-input mt-1" value="${item.size}" onchange="onFieldChange(${index}, 'size', this.value)">` : ''}
                ` : `
                    <input type="text" class="table-input" value="${item.size || ''}" placeholder="—Ä–∞–∑–º–µ—Ä" onchange="onFieldChange(${index}, 'size', this.value)">
                `}
            </td>

            <!-- –í–µ—Å -->
            <td class="px-2 py-2">
                <input type="number" class="table-input" value="${item.weight}" step="0.001" placeholder="0.000"
                       onchange="onFieldChange(${index}, 'weight', this.value)">
            </td>

            <!-- –î–ª–∏–Ω–∞ -->
            <td class="px-2 py-2 col-length">
                <input type="number" class="table-input" value="${item.length}" step="0.01" placeholder="0.00"
                       onchange="onFieldChange(${index}, 'length', this.value)"
                       ${!config.showLength ? 'disabled' : ''}>
            </td>

            <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç—É–∫ -->
            <td class="px-2 py-2 col-pieces">
                <input type="number" class="table-input" value="${item.pieces}" step="1" placeholder="0"
                       onchange="onFieldChange(${index}, 'pieces', this.value)"
                       ${!config.showPieces ? 'disabled' : ''}>
            </td>

            <!-- –î–ª–∏–Ω–∞ 1 —à—Ç -->
            <td class="px-2 py-2 col-length-piece">
                ${standardLengths.length > 0 ? `
                    <select class="table-select" onchange="onFieldChange(${index}, 'length_per_piece', this.value)">
                        ${standardLengths.map(l => `<option value="${l}" ${String(l) === String(item.length_per_piece) ? 'selected' : ''}>${l} –º</option>`).join('')}
                        <option value="custom">–Ω/–¥</option>
                    </select>
                ` : `
                    <input type="number" class="table-input" value="${item.length_per_piece}" step="0.1" placeholder="6"
                           onchange="onFieldChange(${index}, 'length_per_piece', this.value)"
                           ${!config.showLengthPiece ? 'disabled' : ''}>
                `}
            </td>

            <!-- –®–∏—Ä–∏–Ω–∞ -->
            <td class="px-2 py-2 col-width">
                <input type="number" class="table-input" value="${item.width}" step="0.01" placeholder="1.25"
                       onchange="onFieldChange(${index}, 'width', this.value)"
                       ${!config.showWidth ? 'disabled' : ''}>
            </td>

            <!-- –î–ª–∏–Ω–∞ –ª–∏—Å—Ç–∞ -->
            <td class="px-2 py-2 col-length-sheet">
                <input type="number" class="table-input" value="${item.length_sheet}" step="0.01" placeholder="2.5"
                       onchange="onFieldChange(${index}, 'length_sheet', this.value)"
                       ${!config.showLengthSheet ? 'disabled' : ''}>
            </td>

            <!-- –ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏ -->
            <td class="px-2 py-2 col-steel">
                <select class="table-select" onchange="onFieldChange(${index}, 'steel_grade', this.value)">
                    ${STEEL_GRADES.map(g => `<option value="${g.value}" ${g.value === item.steel_grade ? 'selected' : ''}>${g.name}</option>`).join('')}
                </select>
            </td>

            <!-- –£–¥–∞–ª–∏—Ç—å -->
            <td class="px-2 py-2 text-center">
                <button onclick="removeRow(${index})" class="text-red-500 hover:text-red-700" title="–£–¥–∞–ª–∏—Ç—å">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
            </td>
        `;

        return tr;
    }

    function renderMetalOptions(selectedKey) {
        let html = '';
        let currentCat = '';

        for (const m of state.metalsList) {
            if (m.category !== currentCat) {
                if (currentCat) html += '</optgroup>';
                html += `<optgroup label="${m.category}">`;
                currentCat = m.category;
            }
            html += `<option value="${m.key}" ${m.key === selectedKey ? 'selected' : ''}>${m.name}</option>`;
        }
        if (currentCat) html += '</optgroup>';

        return html;
    }

    function updateColumnVisibility() {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ —Ç–∏–ø—ã –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ
        let hasSheet = false, hasRod = false, hasFastener = false, hasLengthPiece = false;

        for (const item of state.items) {
            const config = item._config || getFieldsConfig(item.metal_key);
            if (config.isSheet) hasSheet = true;
            if (config.isFastener) hasFastener = true;
            if (config.showLength) hasRod = true;
            if (config.showLengthPiece) hasLengthPiece = true;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
        document.querySelectorAll('th.col-length, td.col-length').forEach(el => {
            el.classList.toggle('col-hidden', !hasRod && !hasSheet);
        });
        document.querySelectorAll('th.col-pieces, td.col-pieces').forEach(el => {
            el.classList.toggle('col-hidden', false); // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
        });
        document.querySelectorAll('th.col-length-piece, td.col-length-piece').forEach(el => {
            el.classList.toggle('col-hidden', !hasLengthPiece);
        });
        document.querySelectorAll('th.col-width, td.col-width').forEach(el => {
            el.classList.toggle('col-hidden', !hasSheet);
        });
        document.querySelectorAll('th.col-length-sheet, td.col-length-sheet').forEach(el => {
            el.classList.toggle('col-hidden', !hasSheet);
        });
    }

    function onMetalChange(index, metalKey) {
        const item = state.items[index];
        item.metal_key = metalKey;

        const metal = state.metalsDB?.[metalKey];
        if (metal) {
            item.metal_name = metal.name;
            item.size = '';  // –°–±—Ä–æ—Å —Ä–∞–∑–º–µ—Ä–∞
            item._config = getFieldsConfig(metalKey);

            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –¥–ª–∏–Ω—É
            if (STANDARD_LENGTHS[metalKey]) {
                item.length_per_piece = STANDARD_LENGTHS[metalKey][0];
            }
        }

        saveState();
        renderTable();
    }

    function onSizeChange(index, value) {
        if (value === '_custom') {
            state.items[index].size = '';
        } else {
            state.items[index].size = value;
        }
        saveState();
        renderTable();
    }

    function onFieldChange(index, field, value) {
        const item = state.items[index];
        item[field] = value;

        const config = getFieldsConfig(item.metal_key);

        // ‚úÖ –°–ü–ï–¶–ò–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø –ò–ó–ú–ï–ù–ï–ù–ò–Ø –†–ê–ó–ú–ï–†–û–í –®–¢–£–ö–ò/–õ–ò–°–¢–ê
        // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ length_per_piece (–¥–ª—è –ª–∏–Ω–µ–π–Ω—ã—Ö) –∏–ª–∏ width/length_sheet (–¥–ª—è –ª–∏—Å—Ç–æ–≤)
        // –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –û–¢ –ò–°–•–û–î–ù–û–ì–û –í–ï–°–ê (original_weight)
        // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        if (field === 'length_per_piece' ||
            (config.isSheet && (field === 'width' || field === 'length_sheet'))) {
            recalculateFromOriginalWeight(index);
            saveState();
            return;
        }

        // ‚úÖ –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–µ—Å–∞ –≤—Ä—É—á–Ω—É—é - –æ–±–Ω–æ–≤–ª—è–µ–º original_weight
        if (field === 'weight') {
            const newWeight = parseFloat(value);
            if (newWeight > 0) {
                item.original_weight = newWeight;
                console.log(`üìù –û–±–Ω–æ–≤–ª—ë–Ω –∏—Å—Ö–æ–¥–Ω—ã–π –≤–µ—Å: ${newWeight} —Ç`);
            }
        }

        // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π - –ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç —á–µ—Ä–µ–∑ calculateMetal
        if (['weight', 'length', 'pieces', 'width', 'length_sheet'].includes(field)) {
            recalculateRow(index, field);
        }

        saveState();
    }

    // ‚úÖ –ü–ï–†–ï–°–ß–Å–¢ –û–¢ –ò–°–•–û–î–ù–û–ì–û –í–ï–°–ê
    // –î–ª—è –õ–ò–ù–ï–ô–ù–´–• —Ç–∏–ø–æ–≤ (—Ç—Ä—É–±—ã, —É–≥–æ–ª–∫–∏, –±–∞–ª–∫–∏):
    //   –æ–±—â–∞—è_–¥–ª–∏–Ω–∞ = original_weight √ó 1000 / weight_per_meter
    //   –∫–æ–ª_–≤–æ_—à—Ç—É–∫ = round(–æ–±—â–∞—è_–¥–ª–∏–Ω–∞ / –¥–ª–∏–Ω–∞_—à—Ç—É–∫–∏)
    //   —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è_–¥–ª–∏–Ω–∞ = –∫–æ–ª_–≤–æ_—à—Ç—É–∫ √ó –¥–ª–∏–Ω–∞_—à—Ç—É–∫–∏
    //   —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π_–≤–µ—Å = —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è_–¥–ª–∏–Ω–∞ √ó weight_per_meter / 1000
    //
    // –î–ª—è –õ–ò–°–¢–û–í (–ø–ª–æ—â–∞–¥–Ω—ã—Ö —Ç–∏–ø–æ–≤):
    //   –æ–±—â–∞—è_–ø–ª–æ—â–∞–¥—å = original_weight √ó 1000 / weight_per_m2
    //   –ø–ª–æ—â–∞–¥—å_–ª–∏—Å—Ç–∞ = —à–∏—Ä–∏–Ω–∞ √ó –¥–ª–∏–Ω–∞_–ª–∏—Å—Ç–∞
    //   –∫–æ–ª_–≤–æ_–ª–∏—Å—Ç–æ–≤ = round(–æ–±—â–∞—è_–ø–ª–æ—â–∞–¥—å / –ø–ª–æ—â–∞–¥—å_–ª–∏—Å—Ç–∞)
    //   —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è_–ø–ª–æ—â–∞–¥—å = –∫–æ–ª_–≤–æ_–ª–∏—Å—Ç–æ–≤ √ó –ø–ª–æ—â–∞–¥—å_–ª–∏—Å—Ç–∞
    //   —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π_–≤–µ—Å = —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è_–ø–ª–æ—â–∞–¥—å √ó weight_per_m2 / 1000
    function recalculateFromOriginalWeight(index) {
        const item = state.items[index];
        if (!item.metal_key || !item.size) return;

        const config = getFieldsConfig(item.metal_key);
        const originalWeight = parseFloat(item.original_weight);

        if (!originalWeight || originalWeight <= 0) {
            console.log(`‚ö†Ô∏è –ù–µ—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –≤–µ—Å–∞ –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞`);
            return;
        }

        // –ü–æ–ª—É—á–∞–µ–º weight_per_meter/weight_per_m2 —á–µ—Ä–µ–∑ calculateMetal
        const parsedSize = parseSize(item.size, item.metal_key);
        if (!parsedSize) return;

        const params = {
            metalType: item.metal_key,
            size: parsedSize,
            steelType: item.steel_grade || '—Å—Ç3',
            pieces: 1,
            lengthSheet: 1,
            width: 1 // –î–ª—è –ª–∏—Å—Ç–æ–≤: 1–º¬≤ (1–º √ó 1–º)
        };

        try {
            const metalDatabase = { metals: state.metalsDB };
            const result = window.calculateMetal(params, metalDatabase);

            if (!result.success || !result.weightPerMeter) {
                console.log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–µ—Å –Ω–∞ –µ–¥–∏–Ω–∏—Ü—É:`, result.error);
                return;
            }

            const weightPerUnit = result.weightPerMeter; // –∫–≥/–º –¥–ª—è –ª–∏–Ω–µ–π–Ω—ã—Ö, –∫–≥/–º¬≤ –¥–ª—è –ª–∏—Å—Ç–æ–≤

            if (config.isSheet) {
                // ‚úÖ –õ–ò–°–¢–´: —Ä–∞—Å—á—ë—Ç –ø–æ –ø–ª–æ—â–∞–¥–∏
                const sheetWidth = parseFloat(item.width) || 1.25;
                const sheetLength = parseFloat(item.length_sheet) || 2.5;
                const areaPerSheet = sheetWidth * sheetLength; // –º¬≤

                // 1. –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –≤–µ—Å–∞
                const totalArea = originalWeight * 1000 / weightPerUnit; // –º¬≤

                // 2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—Å—Ç–æ–≤ (–æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ)
                const pieces = Math.round(totalArea / areaPerSheet);

                // 3. –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ø–ª–æ—â–∞–¥—å (–∫—Ä–∞—Ç–Ω–∞ –ª–∏—Å—Ç–∞–º)
                const actualArea = pieces * areaPerSheet;

                // 4. –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤–µ—Å (–∫—Ä–∞—Ç–µ–Ω –ª–∏—Å—Ç–∞–º)
                const actualWeight = actualArea * weightPerUnit / 1000; // —Ç–æ–Ω–Ω—ã

                console.log(`üìê –ü–µ—Ä–µ—Å—á—ë—Ç –õ–ò–°–¢–ê –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –≤–µ—Å–∞:`);
                console.log(`   original_weight = ${originalWeight} —Ç`);
                console.log(`   weight_per_m¬≤ = ${weightPerUnit.toFixed(3)} –∫–≥/–º¬≤`);
                console.log(`   total_area = ${originalWeight}√ó1000/${weightPerUnit.toFixed(3)} = ${totalArea.toFixed(2)} –º¬≤`);
                console.log(`   sheet_size = ${sheetWidth}√ó${sheetLength} = ${areaPerSheet.toFixed(2)} –º¬≤`);
                console.log(`   pieces = round(${totalArea.toFixed(2)}/${areaPerSheet.toFixed(2)}) = ${pieces} –ª–∏—Å—Ç–æ–≤`);
                console.log(`   actual_area = ${pieces}√ó${areaPerSheet.toFixed(2)} = ${actualArea.toFixed(2)} –º¬≤`);
                console.log(`   actual_weight = ${actualArea.toFixed(2)}√ó${weightPerUnit.toFixed(3)}/1000 = ${actualWeight.toFixed(3)} —Ç`);

                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è (original_weight –ù–ï —Ç—Ä–æ–≥–∞–µ–º!)
                item.weight = Math.round(actualWeight * 1000) / 1000;
                item.length = Math.round(actualArea * 100) / 100; // –î–ª—è –ª–∏—Å—Ç–æ–≤ length = –ø–ª–æ—â–∞–¥—å –º¬≤
                item.pieces = pieces;

            } else {
                // ‚úÖ –õ–ò–ù–ï–ô–ù–´–ï –¢–ò–ü–´: —Ä–∞—Å—á—ë—Ç –ø–æ –¥–ª–∏–Ω–µ
                const lengthPerPiece = parseFloat(item.length_per_piece) || 6;

                // 1. –û–±—â–∞—è –¥–ª–∏–Ω–∞ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –≤–µ—Å–∞
                const totalLength = originalWeight * 1000 / weightPerUnit; // –º

                // 2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç—É–∫ (–æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ)
                const pieces = Math.round(totalLength / lengthPerPiece);

                // 3. –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–ª–∏–Ω–∞ (–∫—Ä–∞—Ç–Ω–∞ —à—Ç—É–∫–∞–º)
                const actualLength = pieces * lengthPerPiece;

                // 4. –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤–µ—Å (–∫—Ä–∞—Ç–µ–Ω —à—Ç—É–∫–∞–º)
                const actualWeight = actualLength * weightPerUnit / 1000; // —Ç–æ–Ω–Ω—ã

                console.log(`üìê –ü–µ—Ä–µ—Å—á—ë—Ç –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –≤–µ—Å–∞:`);
                console.log(`   original_weight = ${originalWeight} —Ç`);
                console.log(`   weight_per_meter = ${weightPerUnit.toFixed(3)} –∫–≥/–º`);
                console.log(`   total_length = ${originalWeight}√ó1000/${weightPerUnit.toFixed(3)} = ${totalLength.toFixed(2)} –º`);
                console.log(`   length_per_piece = ${lengthPerPiece} –º`);
                console.log(`   pieces = round(${totalLength.toFixed(2)}/${lengthPerPiece}) = ${pieces} —à—Ç`);
                console.log(`   actual_length = ${pieces}√ó${lengthPerPiece} = ${actualLength} –º`);
                console.log(`   actual_weight = ${actualLength}√ó${weightPerUnit.toFixed(3)}/1000 = ${actualWeight.toFixed(3)} —Ç`);

                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è (original_weight –ù–ï —Ç—Ä–æ–≥–∞–µ–º!)
                item.weight = Math.round(actualWeight * 1000) / 1000;
                item.length = Math.round(actualLength * 100) / 100;
                item.pieces = pieces;
            }

            renderTable();
            updateTotals();

        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –≤–µ—Å–∞:', e);
        }
    }

    // –ü–µ—Ä–µ—Å—á—ë—Ç –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª—è (–∏—Å–ø–æ–ª—å–∑—É–µ–º calculateMetal)
    function recalculateRow(index, changedField) {
        const item = state.items[index];
        if (!item.metal_key) return;

        // –ü–∞—Ä—Å–∏–º —Ä–∞–∑–º–µ—Ä
        const parsedSize = parseSize(item.size, item.metal_key);
        if (!parsedSize) return;

        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è calculateMetal
        const params = {
            metalType: item.metal_key,
            size: parsedSize,
            steelType: item.steel_grade || '—Å—Ç3'
        };

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ (—Ç–æ —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–∏)
        const config = getFieldsConfig(item.metal_key);

        if (changedField === 'weight' && item.weight && parseFloat(item.weight) > 0) {
            params.weight = parseFloat(item.weight);
        } else if (changedField === 'length' && item.length && parseFloat(item.length) > 0) {
            params.length = parseFloat(item.length);
        } else if (changedField === 'pieces' && item.pieces && parseInt(item.pieces) > 0) {
            params.pieces = parseInt(item.pieces);
        } else if (changedField === 'width' || changedField === 'length_sheet') {
            // ‚úÖ –¢–æ–ª—å–∫–æ –¥–ª—è –õ–ò–°–¢–û–í: –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ –ª–∏—Å—Ç–∞ - –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Ç —Ç–æ–≥–æ —á—Ç–æ –µ—Å—Ç—å
            // (length_per_piece –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –≤ onFieldChange!)
            if (item.weight && parseFloat(item.weight) > 0) {
                params.weight = parseFloat(item.weight);
            } else if (item.pieces && parseInt(item.pieces) > 0) {
                params.pieces = parseInt(item.pieces);
            } else if (item.length && parseFloat(item.length) > 0) {
                params.length = parseFloat(item.length);
            } else {
                return; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞
            }
        } else {
            return; // –ù–µ—á–µ–≥–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å
        }

        // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª–∏–Ω—É —à—Ç—É–∫–∏:
        // 1. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª length_per_piece - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–µ
        // 2. –ò–Ω–∞—á–µ - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –¥–ª–∏–Ω—É (–±–∞–ª–∫–∏ 12–º, —Ç—Ä—É–±—ã 6–º, –∞—Ä–º–∞—Ç—É—Ä–∞ 11.7–º)
        const userLength = item.length_per_piece ? parseFloat(item.length_per_piece) : null;
        const standardLength = STANDARD_LENGTHS[item.metal_key]?.[0];

        if (userLength && userLength > 0) {
            params.lengthSheet = userLength;
            console.log(`üìè –ò—Å–ø–æ–ª—å–∑—É–µ–º –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–£–Æ –¥–ª–∏–Ω—É —à—Ç—É–∫–∏: ${userLength}–º`);
        } else if (standardLength) {
            params.lengthSheet = standardLength;
            console.log(`üìè –ò—Å–ø–æ–ª—å–∑—É–µ–º –°–¢–ê–ù–î–ê–†–¢–ù–£–Æ –¥–ª–∏–Ω—É —à—Ç—É–∫–∏: ${standardLength}–º`);
        }

        // –î–ª—è –ª–∏—Å—Ç–æ–≤ –¥–æ–±–∞–≤–ª—è–µ–º —à–∏—Ä–∏–Ω—É –∏ –¥–ª–∏–Ω—É –ª–∏—Å—Ç–∞
        if (config.isSheet) {
            if (item.width) params.width = parseFloat(item.width);
            if (item.length_sheet) params.lengthSheet = parseFloat(item.length_sheet);
        }

        console.log(`üîÑ –ü–µ—Ä–µ—Å—á—ë—Ç —Å—Ç—Ä–æ–∫–∏ ${index + 1}, –ø–æ–ª–µ: ${changedField}`, params);

        try {
            const metalDatabase = { metals: state.metalsDB };
            const result = window.calculateMetal(params, metalDatabase);

            console.log(`üìä –†–µ–∑—É–ª—å—Ç–∞—Ç:`, result);

            if (result.success) {
                // ‚úÖ –í–°–ï–ì–î–ê –ø—Ä–∏–º–µ–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç calculateMetal
                // –û–Ω–∏ —É–∂–µ –≤–∫–ª—é—á–∞—é—Ç –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ —Ü–µ–ª—ã—Ö —à—Ç—É–∫!
                // –≠—Ç–æ –∑–Ω–∞—á–∏—Ç: –µ—Å–ª–∏ –≤–≤–µ–ª–∏ –≤–µ—Å 20.467—Ç, –∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–∞—ë—Ç 21.264—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 21.264—Ç
                if (result.weight !== null) {
                    item.weight = result.weight;
                }
                if (result.length !== null) {
                    item.length = result.length;
                }
                if (result.pieces !== null) {
                    item.pieces = result.pieces;
                }
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞:', e);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —ç—Ç—É —Å—Ç—Ä–æ–∫—É
        renderTable();
        updateTotals();
    }

    // –û–±–Ω–æ–≤–∏—Ç—å –∏—Ç–æ–≥–∏ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Å—á—ë—Ç–∞
    function updateTotals() {
        let totalWeight = 0;
        let totalLength = 0;
        let calculated = 0;

        for (const item of state.items) {
            if (item.weight && parseFloat(item.weight) > 0) {
                totalWeight += parseFloat(item.weight);
                calculated++;
            }
            if (item.length && parseFloat(item.length) > 0) {
                totalLength += parseFloat(item.length);
            }
        }

        document.getElementById('total-weight').textContent = Math.round(totalWeight * 1000) / 1000;
        document.getElementById('total-length').textContent = Math.round(totalLength * 100) / 100;
        document.getElementById('total-items').textContent = state.items.length;
        document.getElementById('calc-success').textContent = calculated;
        document.getElementById('calc-total').textContent = state.items.length;
        document.getElementById('results-section').classList.remove('hidden');
    }

    function addEmptyRow() {
        state.items.push(normalizeItem({}, state.items.length));
        saveState();
        renderTable();
    }

    function removeRow(index) {
        state.items.splice(index, 1);
        state.items.forEach((item, i) => item.index = i + 1);
        saveState();
        renderTable();
    }

    // ============================================================
    // –†–ê–°–ß–Å–¢
    // ============================================================
    async function calculateOrder() {
        if (state.items.length === 0) {
            alert('–î–æ–±–∞–≤—å—Ç–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞');
            return;
        }

        showSpinner('calc-spinner', true);

        try {
            // ‚úÖ –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç —á–µ—Ä–µ–∑ calculateMetal
            // API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–µ–∫—Å—Ç–∞/—Ñ–∞–π–ª–æ–≤
            const results = calculateLocal(state.items);

            // –û–±–Ω–æ–≤–ª—è–µ–º state.items —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –æ—Ç calculateMetal (–£–ñ–ï —Å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º!)
            if (results.items) {
                results.items.forEach((r, i) => {
                    if (state.items[i]) {
                        console.log(`üîÑ –ü–†–ò–ú–ï–ù–Ø–ï–ú –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏ ${i + 1}:`, {
                            before: { weight: state.items[i].weight, length: state.items[i].length, pieces: state.items[i].pieces },
                            fromCalcMetal: { weight: r.weight, length: r.length, pieces: r.pieces },
                            error: r.error
                        });

                        // ‚úÖ –í–°–ï–ì–î–ê –ø—Ä–∏–º–µ–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã calculateMetal (–æ–Ω–∏ —É–∂–µ —Å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º)
                        // ‚ö†Ô∏è original_weight –ù–ï —Ç—Ä–æ–≥–∞–µ–º - —ç—Ç–æ –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∑–∞—è–≤–∫–∏!
                        if (r.weight !== undefined && r.weight !== null) {
                            state.items[i].weight = r.weight;
                        }
                        if (r.length !== undefined && r.length !== null) {
                            state.items[i].length = r.length;
                        }
                        if (r.pieces !== undefined && r.pieces !== null) {
                            state.items[i].pieces = r.pieces;
                        }

                        console.log(`   after: { weight: ${state.items[i].weight}, length: ${state.items[i].length}, pieces: ${state.items[i].pieces} }`);
                    }
                });
            }

            state.calcResults = results;
            saveState();
            renderTable();
            renderResults(results);

        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞: ' + e.message);
        } finally {
            showSpinner('calc-spinner', false);
        }
    }

    // ============================================================
    // –†–ê–°–ß–Å–¢ –í–ï–°–ê –ù–ê –ú–ï–¢–† (—Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º calculateMetal –∏–∑ calculator.browser.js)
    // ============================================================
    // –§—É–Ω–∫—Ü–∏—è getWeightPerMeter —É–¥–∞–ª–µ–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º calculateMetal –Ω–∞–ø—Ä—è–º—É—é

    function calculateLocal(items) {
        const results = [];
        let totalWeight = 0;
        let totalLength = 0;
        let successCount = 0;

        console.log('üßÆ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞—Å—á—ë—Ç –¥–ª—è', items.length, '–ø–æ–∑–∏—Ü–∏–π (–∏—Å–ø–æ–ª—å–∑—É–µ–º calculateMetal)');

        // –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∫–æ—Ç–æ—Ä—ã–π –æ–∂–∏–¥–∞–µ—Ç calculateMetal
        const metalDatabase = { metals: state.metalsDB };

        for (const item of items) {
            const result = { index: item.index, error: null };

            console.log(`üìç –ü–æ–∑–∏—Ü–∏—è ${item.index}:`, {
                metal_key: item.metal_key,
                size: item.size,
                weight: item.weight,
                length: item.length,
                pieces: item.pieces
            });

            if (!item.metal_key) {
                result.error = '–¢–∏–ø –º–µ—Ç–∞–ª–ª–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω';
                console.log(`  ‚ùå ${result.error}`);
                results.push(result);
                continue;
            }

            // –ü–∞—Ä—Å–∏–º —Ä–∞–∑–º–µ—Ä –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
            const parsedSize = parseSize(item.size, item.metal_key);

            // üîç –°–ü–ï–¶–ò–ê–õ–¨–ù–ê–Ø –û–¢–õ–ê–î–ö–ê –î–õ–Ø –ë–ê–õ–û–ö
            if (item.metal_key === 'beam') {
                const metalInfo = state.metalsDB['beam'];
                console.log('üî∑ –ë–ê–õ–ö–ê –î–ï–¢–ê–õ–ò:', {
                    inputSize: item.size,
                    parsedSize: parsedSize,
                    parsedSizeType: typeof parsedSize,
                    formula: metalInfo?.formula,
                    weightsKeys: metalInfo?.weights ? Object.keys(metalInfo.weights).slice(0, 10) : '–Ω–µ—Ç weights',
                    weightForSize: metalInfo?.weights?.[parsedSize],
                    weightForSizeStr: metalInfo?.weights?.[String(parsedSize)]
                });
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è calculateMetal
            const params = {
                metalType: item.metal_key,
                size: parsedSize,
                steelType: item.steel_grade || '—Å—Ç3'
            };

            // ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Ö–æ–¥–Ω–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ UNIT –∏–∑ –ø–∞—Ä—Å–µ—Ä–∞
            // –≠—Ç–æ –≥–ª–∞–≤–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —á—Ç–æ –∏–º–µ–Ω–Ω–æ —É–∫–∞–∑–∞–ª –∫–ª–∏–µ–Ω—Ç –≤ –∑–∞—è–≤–∫–µ
            const unit = (item.unit || '').toLowerCase();
            const qty = parseFloat(item.quantity) || 0;
            let inputSource = 'unknown';

            console.log(`  üìã unit="${unit}", quantity=${qty}, weight=${item.weight}, length=${item.length}, pieces=${item.pieces}`);

            if (unit.includes('—Ç') || unit === '—Ç–Ω') {
                // –ö–ª–∏–µ–Ω—Ç —É–∫–∞–∑–∞–ª –¢–û–ù–ù–´
                const weightVal = qty || parseFloat(item.weight) || 0;
                if (weightVal > 0) {
                    params.weight = weightVal;
                    inputSource = `—Ç–æ–Ω–Ω—ã (${weightVal}—Ç)`;
                }
            } else if (unit.includes('–º¬≤') || unit.includes('–º.–∫–≤') || unit.includes('–∫–≤')) {
                // –ö–ª–∏–µ–Ω—Ç —É–∫–∞–∑–∞–ª –ü–õ–û–©–ê–î–¨ (–¥–ª—è –ª–∏—Å—Ç–æ–≤)
                const areaVal = qty || parseFloat(item.length) || 0;
                if (areaVal > 0) {
                    params.length = areaVal; // –¥–ª—è –ª–∏—Å—Ç–æ–≤ length = –ø–ª–æ—â–∞–¥—å
                    inputSource = `–ø–ª–æ—â–∞–¥—å (${areaVal}–º¬≤)`;
                }
            } else if (unit.includes('–º') && !unit.includes('¬≤')) {
                // –ö–ª–∏–µ–Ω—Ç —É–∫–∞–∑–∞–ª –ú–ï–¢–†–´
                const lengthVal = qty || parseFloat(item.length) || 0;
                if (lengthVal > 0) {
                    params.length = lengthVal;
                    inputSource = `–º–µ—Ç—Ä—ã (${lengthVal}–º)`;
                }
            } else if (unit.includes('—à—Ç')) {
                // –ö–ª–∏–µ–Ω—Ç —É–∫–∞–∑–∞–ª –®–¢–£–ö–ò
                const piecesVal = Math.round(qty) || parseInt(item.pieces) || 0;
                if (piecesVal > 0) {
                    params.pieces = piecesVal;
                    inputSource = `—à—Ç—É–∫–∏ (${piecesVal}—à—Ç)`;
                }
            }

            // Fallback: –µ—Å–ª–∏ unit –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–π –∏–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω
            if (!params.weight && !params.length && !params.pieces) {
                // –°–º–æ—Ç—Ä–∏–º —á—Ç–æ –µ—Å—Ç—å –≤ –¥–∞–Ω–Ω—ã—Ö
                if (item.weight && parseFloat(item.weight) > 0) {
                    params.weight = parseFloat(item.weight);
                    inputSource = `fallback: –≤–µ—Å (${item.weight}—Ç)`;
                } else if (item.length && parseFloat(item.length) > 0) {
                    params.length = parseFloat(item.length);
                    inputSource = `fallback: –¥–ª–∏–Ω–∞ (${item.length}–º)`;
                } else if (item.pieces && parseInt(item.pieces) > 0) {
                    params.pieces = parseInt(item.pieces);
                    inputSource = `fallback: —à—Ç—É–∫–∏ (${item.pieces}—à—Ç)`;
                } else if (qty > 0) {
                    params.pieces = Math.round(qty);
                    inputSource = `fallback: quantity –∫–∞–∫ —à—Ç—É–∫–∏ (${qty})`;
                } else {
                    result.error = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ (–≤–µ—Å, –¥–ª–∏–Ω–∞ –∏–ª–∏ —à—Ç—É–∫–∏)';
                    console.log(`  ‚ùå ${result.error}`);
                    results.push(result);
                    continue;
                }
            }

            console.log(`  üéØ –í—Ö–æ–¥–Ω–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä: ${inputSource}`);

            // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª–∏–Ω—É —à—Ç—É–∫–∏:
            // 1. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª length_per_piece - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–µ
            // 2. –ò–Ω–∞—á–µ - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –¥–ª–∏–Ω—É (–±–∞–ª–∫–∏ 12–º, —Ç—Ä—É–±—ã 6–º, –∞—Ä–º–∞—Ç—É—Ä–∞ 11.7–º)
            const userLength = item.length_per_piece ? parseFloat(item.length_per_piece) : null;
            const standardLength = STANDARD_LENGTHS[item.metal_key]?.[0];

            if (userLength && userLength > 0) {
                params.lengthSheet = userLength;
                console.log(`  üìè –ò—Å–ø–æ–ª—å–∑—É–µ–º –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–£–Æ –¥–ª–∏–Ω—É —à—Ç—É–∫–∏: ${userLength}–º`);
            } else if (standardLength) {
                params.lengthSheet = standardLength;
                console.log(`  üìè –ò—Å–ø–æ–ª—å–∑—É–µ–º –°–¢–ê–ù–î–ê–†–¢–ù–£–Æ –¥–ª–∏–Ω—É —à—Ç—É–∫–∏: ${standardLength}–º`);
            }

            // –î–ª—è –ª–∏—Å—Ç–æ–≤ –¥–æ–±–∞–≤–ª—è–µ–º —à–∏—Ä–∏–Ω—É –∏ –¥–ª–∏–Ω—É –ª–∏—Å—Ç–∞
            const config = getFieldsConfig(item.metal_key);
            if (config.isSheet) {
                if (item.width) params.width = parseFloat(item.width);
                if (item.length_sheet) params.lengthSheet = parseFloat(item.length_sheet);
            }

            console.log(`  üì¶ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è calculateMetal:`, params);

            // üîç –û–¢–õ–ê–î–ö–ê –¥–ª—è –±–∞–ª–æ–∫ –∏ –ª–∏—Å—Ç–æ–≤
            const metalInfo = state.metalsDB[item.metal_key];
            if (metalInfo) {
                console.log(`  üîç DEBUG: formula="${metalInfo.formula}"`);
                console.log(`  üîç DEBUG: params.size=${params.size} (type: ${typeof params.size})`);
                console.log(`  üîç DEBUG: weights["${params.size}"] =`, metalInfo.weights?.[String(params.size)]);
                console.log(`  üîç DEBUG: steelCoefficients["${params.steelType}"] =`, metalInfo.steelCoefficients?.[params.steelType]);
                console.log(`  üîç DEBUG: has weights:`, !!metalInfo.weights, ', has steelCoefs:', !!(metalInfo.steelDensities || metalInfo.steelCoefficients));
            }

            try {
                // ‚úÖ –ò–°–ü–û–õ–¨–ó–£–ï–ú –§–£–ù–ö–¶–ò–Æ –ò–ó calculator.browser.js
                const calcResult = window.calculateMetal(params, metalDatabase);

                console.log(`  üìä –†–µ–∑—É–ª—å—Ç–∞—Ç calculateMetal:`, calcResult);

                if (!calcResult.success) {
                    console.log(`  ‚ùå CALC FAIL:`, {
                        row: item.index,
                        metalKey: item.metal_key,
                        formula: metalInfo?.formula,
                        size: params.size,
                        sizeType: typeof params.size,
                        error: calcResult.error
                    });
                }

                if (calcResult.success) {
                    result.weight = calcResult.weight;
                    result.length = calcResult.length;
                    result.pieces = calcResult.pieces;
                    result.weightPerMeter = calcResult.weightPerMeter;

                    if (result.weight && result.weight > 0) {
                        totalWeight += result.weight;
                        successCount++;
                    }
                    if (result.length && result.length > 0) {
                        totalLength += result.length;
                    }

                    console.log(`  ‚úÖ –£—Å–ø–µ—Ö: –≤–µ—Å=${result.weight}—Ç, –¥–ª–∏–Ω–∞=${result.length}–º, —à—Ç=${result.pieces}`);
                } else {
                    result.error = calcResult.error;
                    console.log(`  ‚ùå –û—à–∏–±–∫–∞ calculateMetal: ${result.error}`);
                }
            } catch (e) {
                result.error = e.message;
                console.log(`  ‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${e.message}`);
            }

            results.push(result);
        }

        console.log(`üèÅ –ò—Ç–æ–≥–æ: ${successCount}/${items.length} —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ, –≤–µ—Å=${totalWeight}—Ç, –¥–ª–∏–Ω–∞=${totalLength}–º`);

        return {
            success: true,
            items: results,
            totals: {
                weight: Math.round(totalWeight * 1000) / 1000,
                length: Math.round(totalLength * 100) / 100,
                items_total: items.length,
                items_calculated: successCount
            }
        };
    }

    // –ü–∞—Ä—Å–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è calculateMetal
    function parseSize(size, metalKey) {
        if (!size) return null;

        const metal = state.metalsDB?.[metalKey];
        if (!metal) return size;

        const sizeStr = String(size).replace(',', '.');

        // ‚úÖ –ë–ê–õ–ö–ò, –®–í–ï–õ–õ–ï–†–´, –†–ï–õ–¨–°–´ - —Ä–∞–∑–º–µ—Ä—ã —ç—Ç–æ –±—É–∫–≤–µ–Ω–Ω–æ-—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ ("40–®1", "20–ë1", "–†65")
        // –î–ª—è –Ω–∏—Ö –ù–ï –Ω—É–∂–Ω–æ –ø–∞—Ä—Å–∏—Ç—å –≤ —á–∏—Å–ª–æ - –ø–µ—Ä–µ–¥–∞—ë–º –∫–∞–∫ –µ—Å—Ç—å
        // –í–ê–ñ–ù–û: —É–±–∏—Ä–∞–µ–º –í–°–ï –ø—Ä–æ–±–µ–ª—ã –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–µ–≥–∏—Å—Ç—Ä: "40 —à 1" -> "40–®1"
        const stringFormulasUpperCase = ['beam', 'channel', 'shveller_simple', 'shveller_galv_simple', 'rels_linear'];
        if (stringFormulasUpperCase.includes(metal.formula)) {
            // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ –≤–µ—Ä—Ö–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
            const normalizedSize = sizeStr.replace(/\s/g, '').toUpperCase();
            console.log(`üìã –ë–∞–ª–∫–∞/—à–≤–µ–ª–ª–µ—Ä/—Ä–µ–ª—å—Å: —Ä–∞–∑–º–µ—Ä "${sizeStr}" -> "${normalizedSize}"`);
            return normalizedSize;
        }

        // ‚úÖ –ü–†–û–§–ò–õ–¨–ù–´–ï –¢–†–£–ë–´ –ò –£–ì–û–õ–ö–ò - —Ä–∞–∑–º–µ—Ä—ã –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏ "180—Ö180—Ö6" (–≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ —Ö)
        const stringFormulasAsIs = [
            'tryba_kvadr_linear', 'tryba_pr_linear', 'tryba_pr_galv_linear', 'tryba_es_linear', 'tryba_es_galv_linear',
            'ygolok_linear', 'ygolok_galv_linear', 'ygolok_gnyt_linear', 'ygolok_gnyt_galv_linear'
        ];
        if (stringFormulasAsIs.includes(metal.formula)) {
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –∫ —Ä—É—Å—Å–∫–æ–π —Ö (—Ç–∞–∫ –≤ –±–∞–∑–µ)
            let normalizedSize = sizeStr.replace(/[xX√ó]/g, '—Ö');

            // ‚úÖ –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø –°–û–ö–†–ê–©–Å–ù–ù–´–• –†–ê–ó–ú–ï–†–û–í –ö–í–ê–î–†–ê–¢–ù–´–• –¢–†–£–ë –ò –£–ì–û–õ–ö–û–í
            // "140—Ö7" ‚Üí "140—Ö140—Ö7" (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Ç—Ä—É–±)
            // "125—Ö8" ‚Üí "125—Ö125—Ö8" (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Ä–∞–≤–Ω–æ–ø–æ–ª–æ—á–Ω—ã—Ö —É–≥–æ–ª–∫–æ–≤)
            // –õ–æ–≥–∏–∫–∞: –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ 2 —á–∏—Å–ª–∞ –∏ –≤—Ç–æ—Ä–æ–µ ‚â§ —Ç–æ–ª—â–∏–Ω—ã ‚Äî —ç—Ç–æ —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
            const isSquarePipe = metalKey?.includes('kvadr') || metal.formula?.includes('kvadr');
            const isAngle = metal.formula?.includes('ygolok');

            if (isSquarePipe || isAngle) {
                const twoPartMatch = normalizedSize.match(/^(\d+(?:[.,]\d+)?)—Ö(\d+(?:[.,]\d+)?)$/);
                if (twoPartMatch) {
                    const first = parseFloat(twoPartMatch[1].replace(',', '.'));
                    const second = parseFloat(twoPartMatch[2].replace(',', '.'));
                    // –î–ª—è —Ç—Ä—É–± —Ç–æ–ª—â–∏–Ω–∞ ‚â§ 12–º–º, –¥–ª—è —É–≥–æ–ª–∫–æ–≤ ‚â§ 35–º–º
                    const maxThickness = isAngle ? 35 : 12;
                    if (second <= maxThickness && second < first) {
                        normalizedSize = `${twoPartMatch[1]}—Ö${twoPartMatch[1]}—Ö${twoPartMatch[2]}`;
                        const typeLabel = isAngle ? '–£–≥–æ–ª–æ–∫' : '–ö–≤–∞–¥—Ä–∞—Ç–Ω–∞—è —Ç—Ä—É–±–∞';
                        console.log(`üìê ${typeLabel}: —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç "${sizeStr}" -> "${normalizedSize}"`);
                    }
                }
            }

            const typeLabel = metal.formula.includes('ygolok') ? '–£–≥–æ–ª–æ–∫' : '–ü—Ä–æ—Ñ–∏–ª—å–Ω–∞—è —Ç—Ä—É–±–∞';
            console.log(`üìã ${typeLabel}: —Ä–∞–∑–º–µ—Ä "${sizeStr}" -> "${normalizedSize}"`);
            return normalizedSize;
        }

        // ‚úÖ –¢–†–£–ë–´ (—Å—Ç–∞—Ä—ã–µ —Ñ–æ—Ä–º—É–ª—ã) - —Ä–∞–∑–º–µ—Ä—ã —ç—Ç–æ –º–∞—Å—Å–∏–≤—ã —á–∏—Å–µ–ª [60, 40, 3]
        // –í–ê–ñ–ù–û: sheet –∏ strip –ù–ï –∑–¥–µ—Å—å - –¥–ª—è –Ω–∏—Ö —Ä–∞–∑–º–µ—Ä —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ç–æ–ª—â–∏–Ω–∞ (—á–∏—Å–ª–æ)
        const arrayFormulas = ['pipe', 'pipe_pnd', 'pipe_square', 'pipe_oval', 'pipe_rect', 'angle'];
        if (arrayFormulas.includes(metal.formula)) {
            // –†–∞–∑–±–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –Ω–∞ —á–∞—Å—Ç–∏: "60—Ö40—Ö3" -> [60, 40, 3]
            const parts = sizeStr.split(/[—Öx√ó]/).map(p => parseFloat(p)).filter(p => !isNaN(p));
            if (parts.length > 1) {
                return parts;
            }
        }

        // ‚úÖ –õ–ò–°–¢–´ - —Ä–∞–∑–º–µ—Ä —ç—Ç–æ —Ç–æ–ª—â–∏–Ω–∞ (–ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ)
        if (metal.formula === 'sheet') {
            const num = parseFloat(sizeStr);
            console.log(`üìã –õ–∏—Å—Ç: —Ä–∞–∑–º–µ—Ä "${sizeStr}" -> ${num} (—Ç–æ–ª—â–∏–Ω–∞)`);
            return isNaN(num) ? sizeStr : num;
        }

        // ‚úÖ –ö–†–ï–ü–Å–ñ (metiz) - —Ä–∞–∑–º–µ—Ä—ã –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏ "6—Ö30", "–ú8" –∏ —Ç.–¥.
        if (metal.formula === 'metiz') {
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –∫ —Ä—É—Å—Å–∫–æ–π —Ö (—Ç–∞–∫ –≤ –±–∞–∑–µ)
            const normalizedSize = sizeStr.replace(/[xX√ó]/g, '—Ö');
            console.log(`üî© –ö—Ä–µ–ø—ë–∂: —Ä–∞–∑–º–µ—Ä "${sizeStr}" -> "${normalizedSize}"`);
            return normalizedSize;
        }

        // ‚úÖ –û–°–¢–ê–õ–¨–ù–´–ï (–∞—Ä–º–∞—Ç—É—Ä–∞, –∫—Ä—É–≥ –∏ —Ç.–¥.) - –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –±—É–∫–≤—ã
        // –ï—Å–ª–∏ –µ—Å—Ç—å –±—É–∫–≤—ã (–∫—Ä–æ–º–µ x/—Ö) - –ø–µ—Ä–µ–¥–∞—ë–º –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
        if (/[–∞-—è–ê-–Øa-zA-Z]/.test(sizeStr.replace(/[x—ÖX√ó]/g, ''))) {
            console.log(`üìã –†–∞–∑–º–µ—Ä "${sizeStr}" —Å–æ–¥–µ—Ä–∂–∏—Ç –±—É–∫–≤—ã - –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞`);
            return sizeStr;
        }

        // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ —á–∏—Å–ª–æ
        const num = parseFloat(sizeStr);
        return isNaN(num) ? sizeStr : num;
    }

    function renderResults(results) {
        if (!results || !results.totals) return;

        document.getElementById('total-weight').textContent = results.totals.weight;
        document.getElementById('total-length').textContent = results.totals.length;
        document.getElementById('total-items').textContent = results.totals.items_total;
        document.getElementById('calc-success').textContent = results.totals.items_calculated;
        document.getElementById('calc-total').textContent = results.totals.items_total;

        document.getElementById('results-section').classList.remove('hidden');
    }

    // ============================================================
    // –£–¢–ò–õ–ò–¢–´
    // ============================================================
    function showSpinner(id, show) {
        document.getElementById(id).classList.toggle('hidden', !show);
    }

    function showParseSuccess(count) {
        document.getElementById('parse-status').classList.remove('hidden');
        document.getElementById('parse-success').classList.remove('hidden');
        document.getElementById('parse-error').classList.add('hidden');
        document.getElementById('parsed-count').textContent = count;
    }

    function showParseError(message) {
        document.getElementById('parse-status').classList.remove('hidden');
        document.getElementById('parse-success').classList.add('hidden');
        document.getElementById('parse-error').classList.remove('hidden');
        document.getElementById('error-message').textContent = message;
    }

    function saveState() {
        localStorage.setItem('metalCalcState', JSON.stringify({
            items: state.items,
            calcResults: state.calcResults
        }));
    }

    function restoreState() {
        try {
            const saved = localStorage.getItem('metalCalcState');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.items?.length > 0) {
                    state.items = data.items.map((item, i) => {
                        item._config = getFieldsConfig(item.metal_key);
                        return item;
                    });
                    state.calcResults = data.calcResults;
                    renderTable();
                    if (state.calcResults) renderResults(state.calcResults);
                }
            }
        } catch (e) {}
    }

    function clearAll() {
        if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏?')) return;
        state.items = [];
        state.calcResults = null;
        document.getElementById('order-text').value = '';
        document.getElementById('positions-section').classList.add('hidden');
        document.getElementById('results-section').classList.add('hidden');
        document.getElementById('supplier-request-result').style.display = 'none';
        document.getElementById('parse-status').classList.add('hidden');
        localStorage.removeItem('metalCalcState');

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ Excel
        window.currentExcelBase64 = null;
        window.currentExcelFilename = null;
        window.currentSupplierRequest = null;
    }

    // ============================================================
    // –§–£–ù–ö–¶–ò–ò –ó–ê–ü–†–û–°–ê –ü–û–°–¢–ê–í–©–ò–ö–ê–ú
    // ============================================================

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID –∑–∞–ø—Ä–æ—Å–∞
    function generateRequestId() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const dateStr = `${year}${month}${day}`;

        // –ü–æ–ª—É—á–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –∏–∑ localStorage –¥–ª—è —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
        const counterKey = `supplier_request_counter_${dateStr}`;
        let counter = parseInt(localStorage.getItem(counterKey) || '0') + 1;
        localStorage.setItem(counterKey, counter.toString());

        // –§–æ—Ä–º–∞—Ç: –ó–ü-–ì–ì–ì–ì–ú–ú–î–î-XXX
        const counterStr = String(counter).padStart(3, '0');
        return `–ó–ü-${dateStr}-${counterStr}`;
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞
    function showSupplierResult(requestId, itemsCount, totalWeight) {
        // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –≤–µ—Å - —á–∏—Å–ª–æ
        const weight = parseFloat(totalWeight) || 0;

        document.getElementById('result-request-id').textContent = requestId;
        document.getElementById('result-summary').textContent =
            `${itemsCount} ${getPositionWord(itemsCount)} ‚Ä¢ ${weight.toFixed(3)} —Ç`;

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –∫–Ω–æ–ø–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏
        document.querySelectorAll('.btn-supplier').forEach(btn => {
            btn.disabled = false;
            btn.classList.remove('btn-sent');
        });
        document.getElementById('btn-send-nn').innerHTML = 'üìç –ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥';
        document.getElementById('btn-send-moscow').innerHTML = 'üèôÔ∏è –ú–æ—Å–∫–≤–∞ –∏ —Ä–µ–≥–∏–æ–Ω—ã';
        document.getElementById('btn-send-factories').innerHTML = 'üè≠ –ó–∞–≤–æ–¥—ã';

        // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ"
        const statusEl = document.getElementById('result-status');
        statusEl.textContent = '‚úÖ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ';
        statusEl.style.background = '#d4edda';
        statusEl.style.color = '#155724';

        // –ö–Ω–æ–ø–∫–∞ Excel - —Å–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç
        const excelSection = document.querySelector('.excel-download-section');
        if (window.currentExcelBase64) {
            excelSection.style.display = 'block';
        } else {
            excelSection.style.display = 'none';
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
        document.getElementById('supplier-request-result').style.display = 'block';

        console.log(`üìã –ü–æ–∫–∞–∑–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${requestId}, ${itemsCount} –ø–æ–∑., ${weight.toFixed(3)} —Ç`);
    }

    // –°–∫–ª–æ–Ω–µ–Ω–∏–µ —Å–ª–æ–≤–∞ "–ø–æ–∑–∏—Ü–∏—è"
    function getPositionWord(count) {
        const lastTwo = count % 100;
        const lastOne = count % 10;

        if (lastTwo >= 11 && lastTwo <= 19) return '–ø–æ–∑–∏—Ü–∏–π';
        if (lastOne === 1) return '–ø–æ–∑–∏—Ü–∏—è';
        if (lastOne >= 2 && lastOne <= 4) return '–ø–æ–∑–∏—Ü–∏–∏';
        return '–ø–æ–∑–∏—Ü–∏–π';
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è Excel
    function downloadExcel() {
        console.log('üì• downloadExcel –≤—ã–∑–≤–∞–Ω');
        console.log('üìÑ currentExcelBase64:', window.currentExcelBase64 ? '—Å—É—â–µ—Å—Ç–≤—É–µ—Ç (' + window.currentExcelBase64.length + ' —Å–∏–º–≤–æ–ª–æ–≤)' : 'NULL');
        console.log('üìÑ currentExcelFilename:', window.currentExcelFilename || '–Ω–µ –∑–∞–¥–∞–Ω');

        if (!window.currentExcelBase64) {
            alert('Excel —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω.\n\n–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n- Webhook –Ω–µ –≤–µ—Ä–Ω—É–ª —Ñ–∞–π–ª\n- –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∑–∞–Ω–æ–≤–æ.');
            return;
        }

        try {
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º base64 –≤ blob
            const byteCharacters = atob(window.currentExcelBase64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], {
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            });

            // –°–æ–∑–¥–∞—ë–º —Å—Å—ã–ª–∫—É –∏ —Å–∫–∞—á–∏–≤–∞–µ–º
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = window.currentExcelFilename || '–ó–∞–ø—Ä–æ—Å_–ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º.xlsx';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            console.log('‚úÖ Excel —Å–∫–∞—á–∞–Ω —É—Å–ø–µ—à–Ω–æ:', a.download);
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ Excel:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏: ' + error.message);
        }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª–µ–π –∏–∑ DOM –≤ state.items
    function syncFieldsFromDOM() {
        const tbody = document.getElementById('positions-body');
        if (!tbody) return;

        const rows = tbody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            if (index >= state.items.length) return;
            const item = state.items[index];

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—Å–µ —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è –∏–∑ –∏–Ω–ø—É—Ç–æ–≤
            const weightInput = row.querySelector('input[onchange*="weight"]');
            const lengthInput = row.querySelector('input[onchange*="\'length\'"]');
            const piecesInput = row.querySelector('input[onchange*="pieces"]');
            const widthInput = row.querySelector('input[onchange*="width"]');
            const lengthSheetInput = row.querySelector('input[onchange*="length_sheet"]');

            if (weightInput) item.weight = parseFloat(weightInput.value) || 0;
            if (lengthInput) item.length = parseFloat(lengthInput.value) || 0;
            if (piecesInput) item.pieces = parseInt(piecesInput.value) || 0;
            if (widthInput) item.width = parseFloat(widthInput.value) || 0;
            if (lengthSheetInput) item.length_sheet = parseFloat(lengthSheetInput.value) || 0;
        });

        console.log('üîÑ –ü–æ–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ DOM');
    }

    // –ü–µ—Ä–µ—Å—á—ë—Ç –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    function recalculateAllRows() {
        console.log('üìä –ü–µ—Ä–µ—Å—á—ë—Ç –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π...');

        const metalDatabase = { metals: state.metalsDB };

        state.items.forEach((item, index) => {
            if (!item.metal_key || !item.size) return;

            const parsedSize = parseSize(item.size, item.metal_key);
            if (!parsedSize) return;

            const params = {
                metalType: item.metal_key,
                size: parsedSize,
                steelType: item.steel_grade || '—Å—Ç3'
            };

            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –≤–µ—Å ‚Üí –¥–ª–∏–Ω–∞ ‚Üí —à—Ç—É–∫–∏
            if (item.weight && parseFloat(item.weight) > 0) {
                params.weight = parseFloat(item.weight);
            } else if (item.length && parseFloat(item.length) > 0) {
                params.length = parseFloat(item.length);
            } else if (item.pieces && parseInt(item.pieces) > 0) {
                params.pieces = parseInt(item.pieces);
            } else {
                return; // –ù–µ—á–µ–≥–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –¥–ª–∏–Ω—É —à—Ç—É–∫–∏
            const config = getFieldsConfig(item.metal_key);
            if (item.length_per_piece) {
                params.lengthSheet = parseFloat(item.length_per_piece);
            }

            // –î–ª—è –ª–∏—Å—Ç–æ–≤ - —à–∏—Ä–∏–Ω–∞ –∏ –¥–ª–∏–Ω–∞ –ª–∏—Å—Ç–∞
            if (config.isSheet) {
                if (item.width) params.width = parseFloat(item.width);
                if (item.length_sheet) params.lengthSheet = parseFloat(item.length_sheet);
            }

            try {
                const result = window.calculateMetal(params, metalDatabase);
                if (result.success) {
                    if (result.weight !== null) item.weight = result.weight;
                    if (result.length !== null) item.length = result.length;
                    if (result.pieces !== null) item.pieces = result.pieces;
                    console.log(`  ‚úÖ –ü–æ–∑–∏—Ü–∏—è ${index + 1}: –≤–µ—Å=${item.weight}—Ç, –¥–ª–∏–Ω–∞=${item.length}–º, —à—Ç=${item.pieces}`);
                }
            } catch (e) {
                console.error(`  ‚ùå –û—à–∏–±–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ ${index + 1}:`, e);
            }
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∏ –∏—Ç–æ–≥–∏
        renderTable();
        updateTotals();
    }

    async function submitSupplierRequest() {
        const btn = document.getElementById('btn-supplier-request');
        const spinner = document.getElementById('supplier-spinner');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–∑–∏—Ü–∏–π
        if (!state.items || state.items.length === 0) {
            alert('–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏. –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∑–∞–∫–∞–∑.');
            return;
        }

        // ‚úÖ –°–ù–ê–ß–ê–õ–ê —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—è –∏–∑ DOM (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–ø—É—Å—Ç–∏–ª –ø–æ–ª–µ)
        syncFieldsFromDOM();

        // ‚úÖ –ó–ê–¢–ï–ú –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        recalculateAllRows();

        console.log('üì§ –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:', state.items.map(i => ({
            metal: i.metal_key,
            size: i.size,
            weight: i.weight,
            length: i.length,
            pieces: i.pieces
        })));

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
        btn.disabled = true;
        spinner.classList.remove('hidden');

        try {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –∑–∞–ø—Ä–æ—Å–∞
            const requestId = generateRequestId();
            console.log('üì§ –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º:', requestId);

            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const requestData = {
                request_id: requestId,
                timestamp: new Date().toISOString(),
                items: state.items.map((item, index) => {
                    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –º–µ—Ç–∞–ª–ª–æ–≤
                    const metalDB = state.metalsDB?.[item.metal_key] || {};

                    return {
                        // –ù–æ–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏
                        position: index + 1,

                        // –¢–∏–ø –º–µ—Ç–∞–ª–ª–∞
                        metal_key: item.metal_key || '',
                        metal_type: metalDB.name || item.metal_name || item.metal_key || '',
                        metal_name: item.metal_name || metalDB.name || '',

                        // –†–∞–∑–º–µ—Ä—ã
                        size: item.size || '',

                        // –í–µ—Å –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                        weight: parseFloat(item.weight) || 0,
                        total_length: parseFloat(item.total_length) || parseFloat(item.length) || 0,
                        pieces: parseInt(item.pieces) || 0,
                        length_per_piece: parseFloat(item.length_per_piece) || 0,

                        // –î–ª—è –ª–∏—Å—Ç–æ–≤ - —à–∏—Ä–∏–Ω–∞ –∏ –¥–ª–∏–Ω–∞ –ª–∏—Å—Ç–∞
                        width: parseFloat(item.width) || null,
                        length_sheet: parseFloat(item.length_sheet) || null,

                        // –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∏ –º–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏
                        gost: metalDB.gost || metalDB.standard || '',
                        steel_grade: item.steel_grade || item.steel_type || '—Å—Ç3',

                        // –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è
                        unit: item.unit || '—à—Ç',

                        // –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ–∑–∏—Ü–∏–∏
                        raw_text: item.raw_text || ''
                    };
                }),
                totals: {
                    weight: 0, // –ë—É–¥–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ –Ω–∏–∂–µ
                    length: 0, // –ë—É–¥–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ –Ω–∏–∂–µ
                    items_count: state.items.length
                }
            };

            // ‚úÖ –°—á–∏—Ç–∞–µ–º –∏—Ç–æ–≥–∏ –õ–û–ö–ê–õ–¨–ù–û –∏–∑ items (–¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏)
            const totalWeight = requestData.items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);
            const totalLength = requestData.items.reduce((sum, item) => sum + (parseFloat(item.total_length) || 0), 0);
            const itemsCount = requestData.items.length;

            // –û–±–Ω–æ–≤–ª—è–µ–º totals —Å –ª–æ–∫–∞–ª—å–Ω–æ –ø–æ—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            requestData.totals.weight = totalWeight;
            requestData.totals.length = totalLength;
            requestData.totals.items_count = itemsCount;

            console.log('üì¶ –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:', requestData);
            console.log(`üìä –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç: ${itemsCount} –ø–æ–∑–∏—Ü–∏–π, ${totalWeight.toFixed(3)} —Ç`);

            // URL –≤–µ–±—Ö—É–∫–∞ n8n
            const webhookUrl = 'https://primary-production-4e88.up.railway.app/webhook/supplier-request';

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            let webhookSuccess = false;
            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ –û—Ç–≤–µ—Ç –æ—Ç webhook:', result);

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ Excel –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (result.excel_base64) {
                        window.currentExcelBase64 = result.excel_base64;
                        window.currentExcelFilename = result.excel_filename || `–ó–∞–ø—Ä–æ—Å_${requestId}.xlsx`;
                        console.log('üíæ Excel —Å–æ—Ö—Ä–∞–Ω—ë–Ω:', window.currentExcelFilename, '(' + result.excel_base64.length + ' chars)');
                    } else {
                        console.warn('‚ö†Ô∏è Excel base64 –Ω–µ –ø–æ–ª—É—á–µ–Ω –æ—Ç webhook');
                        window.currentExcelBase64 = null;
                        window.currentExcelFilename = null;
                    }

                    webhookSuccess = true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (fetchError) {
                // –ï—Å–ª–∏ –≤–µ–±—Ö—É–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                console.warn('‚ö†Ô∏è –í–µ–±—Ö—É–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', fetchError.message);
                window.currentExcelBase64 = null;
                window.currentExcelFilename = null;
            }

            // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º
            window.currentSupplierRequest = {
                request_id: requestId,
                items: requestData.items,
                totals: requestData.totals
            };
            console.log('üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (—Å –õ–û–ö–ê–õ–¨–ù–´–ú –≤–µ—Å–æ–º)
            showSupplierResult(requestId, itemsCount, totalWeight);

            // –¢–∞–∫–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á—ë—Ç–∞
            document.getElementById('results-section').classList.remove('hidden');
            updateTotals(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏ –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message);
        } finally {
            // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
            btn.disabled = false;
            spinner.classList.add('hidden');
        }
    }

    // ============================================================
    // –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–†–û–°–ê –ü–û–°–¢–ê–í–©–ò–ö–ê–ú –ü–û –ö–ê–¢–ï–ì–û–†–ò–Ø–ú
    // ============================================================

    async function sendToSuppliers(category) {
        const categoryNames = {
            'nn': '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥',
            'moscow': '–ú–æ—Å–∫–≤–∞ –∏ —Ä–µ–≥–∏–æ–Ω—ã',
            'factories': '–ó–∞–≤–æ–¥—ã'
        };

        const categoryName = categoryNames[category];

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
        if (!window.currentSupplierRequest) {
            alert('–°–Ω–∞—á–∞–ª–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º');
            return;
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${categoryName}"?`)) {
            return;
        }

        const btn = document.getElementById(`btn-send-${category}`);
        const allButtons = document.querySelectorAll('.btn-supplier');

        // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
        allButtons.forEach(b => b.disabled = true);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –Ω–∞ —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–µ
        const originalContent = btn.innerHTML;
        btn.innerHTML = `<span class="spinner" style="width:16px;height:16px;border-width:2px;"></span> –û—Ç–ø—Ä–∞–≤–∫–∞...`;

        const payload = {
            category: category,
            category_name: categoryName,
            request_id: window.currentSupplierRequest.request_id,
            items: window.currentSupplierRequest.items,
            totals: window.currentSupplierRequest.totals,
            timestamp: new Date().toISOString(),
            excel_base64: window.currentExcelBase64 || null,
            excel_filename: window.currentExcelFilename || null
        };

        console.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º (${categoryName}):`, payload);

        try {
            const response = await fetch('https://primary-production-4e88.up.railway.app/webhook/send-supplier-request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                const result = await response.json();
                console.log('‚úÖ –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);

                // –û—Ç–º–µ—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é
                btn.innerHTML = `‚úÖ ${categoryName}`;
                btn.classList.add('btn-sent');
                btn.disabled = true; // –û—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π

                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                allButtons.forEach(b => {
                    if (b.id !== `btn-send-${category}` && !b.classList.contains('btn-sent')) {
                        b.disabled = false;
                    }
                });

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–≤–æ–¥–∫–∏
                showSummaryTrackingPanel(result);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                const suppliersInfo = result.suppliers_count ? `\n–ü–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤: ${result.suppliers_count}` : '';
                const moscowTime = result.collect_at ? formatMoscowTime(result.collect_at) : '';
                const collectInfo = moscowTime ? `\n–°–≤–æ–¥–∫–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞ –≤ ${moscowTime} (–º—Å–∫)` : '';
                alert(`‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!\n\n–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${categoryName}${suppliersInfo}${collectInfo}`);

            } else {
                throw new Error(`HTTP ${response.status}`);
            }

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            btn.innerHTML = originalContent;

            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
            allButtons.forEach(b => {
                if (!b.classList.contains('btn-sent')) {
                    b.disabled = false;
                }
            });

            alert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`);
        }
    }

    // ============================================================
    // –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï –°–í–û–î–ö–ò –û–¢ –ü–û–°–¢–ê–í–©–ò–ö–û–í (–°–ü–ò–°–û–ö –ê–ö–¢–ò–í–ù–´–• –ó–ê–ö–ê–ó–û–í)
    // ============================================================
    // (–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω—ã –≤ –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ hoisting)

    // –ó–≤—É–∫–æ–≤–æ–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ (Web Audio API)
    function playNotificationSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800; // –ß–∞—Å—Ç–æ—Ç–∞ –∑–≤—É–∫–∞
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);

            console.log('üîî –ó–≤—É–∫–æ–≤–æ–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ');
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', e);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ localStorage
    function loadActiveRequests() {
        try {
            const saved = localStorage.getItem(ACTIVE_REQUESTS_KEY);
            if (saved) {
                activeRequests = JSON.parse(saved);
                // –£–¥–∞–ª—è–µ–º —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä—ã–µ (>7 –¥–Ω–µ–π)
                const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
                const beforeCount = activeRequests.length;
                activeRequests = activeRequests.filter(r => new Date(r.created_at).getTime() > sevenDaysAgo);
                const removedCount = beforeCount - activeRequests.length;
                if (removedCount > 0) {
                    console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ ${removedCount} —Å—Ç–∞—Ä—ã—Ö –∑–∞—è–≤–æ–∫ (>7 –¥–Ω–µ–π)`);
                    saveActiveRequests();
                }
                console.log(`üìÇ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${activeRequests.length} –∑–∞—è–≤–æ–∫ –∏–∑ localStorage`);
            } else {
                console.log('üìÇ localStorage –ø—É—Å—Ç, –∑–∞—è–≤–æ–∫ –Ω–µ—Ç');
            }
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ activeRequests:', e);
            activeRequests = [];
        }
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ localStorage
    function saveActiveRequests() {
        try {
            localStorage.setItem(ACTIVE_REQUESTS_KEY, JSON.stringify(activeRequests));
            console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${activeRequests.length} –∑–∞—è–≤–æ–∫ –≤ localStorage`);
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è activeRequests:', e);
        }
    }

    // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤ —Å–ø–∏—Å–æ–∫
    function addActiveRequest(result) {
        const request = {
            request_id: result.request_id,
            category: result.category,
            category_name: result.category_name || result.category,
            collect_at: result.collect_at,
            collect_at_formatted: result.collect_at_formatted,
            suppliers_count: result.suppliers_count,
            created_at: new Date().toISOString(),
            status: 'pending'
        };

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
        activeRequests.unshift(request);
        saveActiveRequests();

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
        renderActiveRequests();

        console.log('üìä –î–æ–±–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å:', request.request_id);
    }

    // –£–¥–∞–ª–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–∑ —Å–ø–∏—Å–∫–∞
    function removeActiveRequest(requestId) {
        console.log(`üóëÔ∏è –£–¥–∞–ª—è—é –∑–∞—è–≤–∫—É: ${requestId}`);

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
        if (requestTimers[requestId]) {
            clearInterval(requestTimers[requestId]);
            delete requestTimers[requestId];
        }
        // –£–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å–≤–æ–¥–∫–∏
        delete requestSummaryData[requestId];
        // –£–¥–∞–ª—è–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ –æ–ø–æ–≤–µ—â—ë–Ω–Ω—ã—Ö
        notifiedRequests.delete(requestId);

        // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
        activeRequests = activeRequests.filter(r => r.request_id !== requestId);
        saveActiveRequests();

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
        renderActiveRequests();
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    let showAllRequests = false;
    function toggleMoreRequests() {
        showAllRequests = !showAllRequests;
        renderActiveRequests();
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    function renderActiveRequests() {
        const container = document.getElementById('active-requests-container');
        const list = document.getElementById('active-requests-list');
        const showMoreBtn = document.getElementById('btn-show-more-requests');
        const hiddenCount = document.getElementById('hidden-requests-count');

        if (!container || !list) {
            console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä active-requests-container –Ω–µ –Ω–∞–π–¥–µ–Ω!');
            return;
        }

        if (activeRequests.length === 0) {
            container.style.display = 'none';
            console.log('üé® –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            return;
        }

        container.style.display = 'block';
        console.log(`üé® –û—Ç—Ä–∏—Å–æ–≤–∞–Ω–æ ${activeRequests.length} –∫–∞—Ä—Ç–æ—á–µ–∫ –∑–∞—è–≤–æ–∫`);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç—å
        const visibleRequests = showAllRequests ? activeRequests : activeRequests.slice(0, MAX_VISIBLE_REQUESTS);
        const hiddenNum = activeRequests.length - MAX_VISIBLE_REQUESTS;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë"
        if (hiddenNum > 0 && !showAllRequests) {
            showMoreBtn.style.display = 'block';
            hiddenCount.textContent = hiddenNum;
            showMoreBtn.textContent = `–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë (${hiddenNum})`;
        } else if (showAllRequests && activeRequests.length > MAX_VISIBLE_REQUESTS) {
            showMoreBtn.style.display = 'block';
            showMoreBtn.textContent = '–°–∫—Ä—ã—Ç—å';
        } else {
            showMoreBtn.style.display = 'none';
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –∫–∞–∂–¥–æ–π –ø–ª–∞—à–∫–∏
        list.innerHTML = visibleRequests.map(req => {
            const isReady = req.status === 'ready';
            const isDownloaded = req.status === 'downloaded';
            const hasData = !!requestSummaryData[req.request_id];

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å –∏ —Ç–µ–∫—Å—Ç –¥–ª—è –±–µ–π–¥–∂–∞
            let badgeClass = 'pending';
            let badgeText = '‚è≥ –°–±–æ—Ä';
            if (isDownloaded) {
                badgeClass = 'downloaded';
                badgeText = '‚úÖ –°–∫–∞—á–∞–Ω–æ';
            } else if (isReady) {
                badgeClass = 'ready';
                badgeText = '‚úÖ –ì–æ—Ç–æ–≤–æ';
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            let downloadBtnText = 'üì• –°–∫–∞—á–∞—Ç—å Excel';
            let downloadBtnClass = 'btn-download-request';
            if (isDownloaded) {
                downloadBtnText = '‚úÖ –°–∫–∞—á–∞–Ω–æ';
                downloadBtnClass = 'btn-download-request downloaded';
            }

            return `
                <div id="request-card-${req.request_id}" class="request-card ${isReady || isDownloaded ? 'ready' : ''}">
                    <button class="btn-close-card" onclick="removeActiveRequest('${req.request_id}')" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
                    <div class="request-card-header">
                        <div class="request-card-icon">üìä</div>
                        <div class="request-card-info">
                            <h5>${req.request_id}</h5>
                            <p id="status-${req.request_id}">‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${req.category_name}</p>
                        </div>
                        <div id="badge-${req.request_id}" class="request-card-badge ${badgeClass}">
                            ${badgeText}
                        </div>
                    </div>
                    <div id="timer-${req.request_id}" class="request-card-timer" style="font-size: 12px; color: #1e7e34; margin-bottom: 8px;"></div>
                    <div class="request-card-actions">
                        <button id="btn-check-${req.request_id}" class="btn-check-request" onclick="checkRequestStatus('${req.request_id}')">
                            üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                        </button>
                        <button id="btn-download-${req.request_id}" class="${downloadBtnClass}" onclick="downloadRequestExcel('${req.request_id}')" ${hasData || isDownloaded ? '' : 'disabled'}>
                            ${downloadBtnText}
                        </button>
                    </div>
                    <div id="result-${req.request_id}" class="request-card-result" style="display: none;"></div>
                </div>
            `;
        }).join('');

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä—ã –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–∫—Ä–æ–º–µ –≥–æ—Ç–æ–≤—ã—Ö –∏ —Å–∫–∞—á–∞–Ω–Ω—ã—Ö)
        visibleRequests.forEach(req => {
            if (req.collect_at && req.status !== 'ready' && req.status !== 'downloaded') {
                const moscowTime = formatMoscowTime(req.collect_at);
                startRequestCountdown(req.request_id, new Date(req.collect_at), moscowTime);
            }
        });
    }

    // –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á—ë—Ç–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    function startRequestCountdown(requestId, targetTime, formattedTime) {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
        if (requestTimers[requestId]) {
            clearInterval(requestTimers[requestId]);
        }

        const timerEl = document.getElementById(`timer-${requestId}`);
        const badgeEl = document.getElementById(`badge-${requestId}`);
        const cardEl = document.getElementById(`request-card-${requestId}`);

        if (!timerEl) return;

        function updateTimer() {
            const now = new Date();
            const diff = targetTime - now;

            if (diff <= 0) {
                clearInterval(requestTimers[requestId]);
                delete requestTimers[requestId];

                timerEl.innerHTML = `<strong>‚è∞ –í—Ä–µ–º—è —Å–±–æ—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</strong> –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å"`;
                if (badgeEl) {
                    badgeEl.className = 'request-card-badge ready';
                    badgeEl.textContent = '‚úÖ –ì–æ—Ç–æ–≤–æ';
                }
                if (cardEl) cardEl.classList.add('ready');

                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞—è–≤–∫–∏
                if (!notifiedRequests.has(requestId)) {
                    notifiedRequests.add(requestId);
                    playNotificationSound();
                }
                return;
            }

            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            timerEl.textContent = `‚è≥ –°–≤–æ–¥–∫–∞ –≥–æ—Ç–æ–≤–∞ —á–µ—Ä–µ–∑ ${timeStr} (–¥–æ ${formattedTime} –º—Å–∫)`;
        }

        updateTimer();
        requestTimers[requestId] = setInterval(updateTimer, 1000);
    }

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    async function checkRequestStatus(requestId) {
        const btn = document.getElementById(`btn-check-${requestId}`);
        const resultEl = document.getElementById(`result-${requestId}`);
        const badgeEl = document.getElementById(`badge-${requestId}`);
        const downloadBtn = document.getElementById(`btn-download-${requestId}`);
        const cardEl = document.getElementById(`request-card-${requestId}`);
        const statusEl = document.getElementById(`status-${requestId}`);
        const timerEl = document.getElementById(`timer-${requestId}`);

        if (!btn) return;

        btn.disabled = true;
        btn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';

        try {
            const url = `https://primary-production-4e88.up.railway.app/webhook/get-supplier-summary?request_id=${encodeURIComponent(requestId)}`;
            console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤–æ–¥–∫—É:', url);

            const response = await fetch(url);
            const result = await response.json();

            console.log('üìä –û—Ç–≤–µ—Ç —Å–≤–æ–¥–∫–∏:', result);

            resultEl.style.display = 'block';

            if (result.success && result.ready) {
                // –°–≤–æ–¥–∫–∞ –≥–æ—Ç–æ–≤–∞!
                if (requestTimers[requestId]) {
                    clearInterval(requestTimers[requestId]);
                    delete requestTimers[requestId];
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                requestSummaryData[requestId] = result;

                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                badgeEl.className = 'request-card-badge ready';
                badgeEl.textContent = '‚úÖ –ì–æ—Ç–æ–≤–æ';
                cardEl.classList.add('ready');
                downloadBtn.disabled = false;

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É
                const priceFormatted = result.total_best_price
                    ? result.total_best_price.toLocaleString('ru-RU') + ' ‚ÇΩ'
                    : 'N/A';

                // –°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
                const suppliersList = result.suppliers && result.suppliers.length > 0
                    ? `<div class="suppliers-list">–û—Ç–≤–µ—Ç–∏–ª–∏: ${result.suppliers.join(', ')}</div>`
                    : '';

                statusEl.textContent = `–û—Ç–≤–µ—Ç–∏–ª–∏: ${result.responses_count} –∏–∑ ${result.suppliers_count} –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤`;
                timerEl.innerHTML = '';

                resultEl.className = 'request-card-result';
                resultEl.innerHTML = `
                    <strong>‚úÖ –°–≤–æ–¥–∫–∞ –≥–æ—Ç–æ–≤–∞!</strong><br>
                    –õ—É—á—à–∞—è —Ü–µ–Ω–∞: <strong>${priceFormatted}</strong>
                    ${suppliersList}
                `;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –º–∞—Å—Å–∏–≤–µ
                const reqIndex = activeRequests.findIndex(r => r.request_id === requestId);
                if (reqIndex >= 0) {
                    activeRequests[reqIndex].status = 'ready';
                    saveActiveRequests();
                }

            } else if (result.success && !result.ready) {
                // –ï—â—ë —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è
                resultEl.className = 'request-card-result';
                resultEl.textContent = `‚è≥ ${result.message || '–°–±–æ—Ä –æ—Ç–≤–µ—Ç–æ–≤ –µ—â—ë –∏–¥—ë—Ç...'}`;

            } else {
                throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤–æ–¥–∫–∏:', error);
            resultEl.className = 'request-card-result error';
            resultEl.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
        } finally {
            btn.disabled = false;
            btn.textContent = 'üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
        }
    }

    // –°–∫–∞—á–∞—Ç—å Excel –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    function downloadRequestExcel(requestId) {
        const data = requestSummaryData[requestId];

        if (!data || !data.excel_base64) {
            alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å" —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
            return;
        }

        try {
            const byteCharacters = atob(data.excel_base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], {
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = data.excel_filename || `–°–≤–æ–¥–∫–∞_${requestId}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            console.log('üì• Excel —Å–∫–∞—á–∞–Ω:', data.excel_filename);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "downloaded" –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
            const reqIndex = activeRequests.findIndex(r => r.request_id === requestId);
            if (reqIndex >= 0) {
                activeRequests[reqIndex].status = 'downloaded';
                activeRequests[reqIndex].downloaded_at = new Date().toISOString();
                saveActiveRequests();
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º UI - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–°–∫–∞—á–∞–Ω–æ"
            const badgeEl = document.getElementById(`badge-${requestId}`);
            const downloadBtn = document.getElementById(`btn-download-${requestId}`);
            if (badgeEl) {
                badgeEl.className = 'request-card-badge downloaded';
                badgeEl.textContent = '‚úÖ –°–∫–∞—á–∞–Ω–æ';
            }
            if (downloadBtn) {
                downloadBtn.innerHTML = '‚úÖ –°–∫–∞—á–∞–Ω–æ';
                downloadBtn.classList.add('downloaded');
            }

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è Excel:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + error.message);
        }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–≤–æ–¥–∫–∏ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏)
    function showSummaryTrackingPanel(result) {
        addActiveRequest(result);
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
    function formatPrice(price) {
        if (!price && price !== 0) return 'N/A';
        return price.toLocaleString('ru-RU');
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–π —Ç–∞–π–º–∑–æ–Ω–µ (UTC+3)
    function formatMoscowTime(isoString) {
        if (!isoString) return '';
        try {
            const date = new Date(isoString);
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏
            return date.toLocaleTimeString('ru-RU', {
                timeZone: 'Europe/Moscow',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏:', e);
            return '';
        }
    }
    </script>
</body>
</html>

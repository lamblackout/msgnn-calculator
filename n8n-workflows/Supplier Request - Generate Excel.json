{
  "name": "Supplier Request - Generate Excel",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "supplier-request",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "0b52f19e-411d-4565-8da0-619c11eb4101",
      "name": "Webhook: Supplier Request",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -16,
        0
      ],
      "webhookId": "a44b8b75-a30b-4aae-8ca9-35c1f6039da4"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ webhook (–¥–∞–Ω–Ω—ã–µ –≤ body)\nconst webhookData = $input.first().json;\nconst body = webhookData.body || webhookData;\nconst requestId = body.request_id || body.requestId;\nconst items = body.items || [];\nconsole.log('üì• –ü–æ–ª—É—á–µ–Ω–æ –ø–æ–∑–∏—Ü–∏–π:', items.length);\nconsole.log('üì• Request ID:', requestId);\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è Excel (—Å –∫–æ–ª–æ–Ω–∫–æ–π –ü—Ä–∏–º–µ—á–∞–Ω–∏—è)\nconst excelRows = items.map((item, idx) => {\n  return {\n    '‚Ññ': idx + 1,\n    '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ': item.metal_type || item.metal_name || '',\n    '–†–∞–∑–º–µ—Ä': item.size || '',\n    '–ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏': item.steel_grade || '',\n    '–í–µ—Å, —Ç': item.weight ? Number(item.weight).toFixed(3) : '',\n    '–ö–æ–ª-–≤–æ, —à—Ç': item.pieces || '',\n    '–î–ª. —à—Ç, –º': item.length_per_piece || '',\n    '–®–∏—Ä–∏–Ω–∞, –º': item.width || '',\n    '–î–ª. –ª–∏—Å—Ç–∞, –º': item.length_sheet || '',\n    '–¶–µ–Ω–∞': '',\n    '–ü—Ä–∏–º–µ—á–∞–Ω–∏—è': ''\n  };\n});\n\n// –°—á–∏—Ç–∞–µ–º –æ–±—â–∏–π –≤–µ—Å\nconst totalWeight = items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);\n\n// –î–æ–±–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç—Ä–æ–∫—É\nexcelRows.push({\n  '‚Ññ': '',\n  '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ': '–ò–¢–û–ì–û:',\n  '–†–∞–∑–º–µ—Ä': '',\n  '–ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏': '',\n  '–í–µ—Å, —Ç': totalWeight ? Number(totalWeight).toFixed(3) : '',\n  '–ö–æ–ª-–≤–æ, —à—Ç': '',\n  '–î–ª. —à—Ç, –º': '',\n  '–®–∏—Ä–∏–Ω–∞, –º': '',\n  '–î–ª. –ª–∏—Å—Ç–∞, –º': '',\n  '–¶–µ–Ω–∞': '',\n  '–ü—Ä–∏–º–µ—á–∞–Ω–∏—è': ''\n});\n\nconsole.log('üìä –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ —Å—Ç—Ä–æ–∫ –¥–ª—è Excel:', excelRows.length);\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π item\nreturn excelRows.map((row, index) => ({\n  json: row,\n  pairedItem: { item: 0 }\n}));"
      },
      "id": "9a653c58-bcb3-4099-a6ce-58dae03d7cfb",
      "name": "Code: Prepare Excel Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        0
      ]
    },
    {
      "parameters": {
        "operation": "toFile",
        "fileFormat": "xlsx",
        "binaryPropertyName": "excelFile",
        "options": {
          "fileName": "={{ '–ó–∞–ø—Ä–æ—Å_–ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º_' + $('Webhook: Supplier Request').first().json.requestId + '.xlsx' }}",
          "headerRow": true,
          "sheetName": "–ó–∞—è–≤–∫–∞"
        }
      },
      "id": "4998fafe-1c16-40c9-b415-b18f043f87fc",
      "name": "Create Excel File",
      "type": "n8n-nodes-base.spreadsheetFile",
      "typeVersion": 2,
      "position": [
        432,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ webhook\nconst webhookData = $('Webhook: Supplier Request').first().json;\nconst body = webhookData.body || webhookData;\nconst requestId = body.request_id || body.requestId;\nconst items = body.items || [];\nconst totals = body.totals || {};\n\n// –°—á–∏—Ç–∞–µ–º –æ–±—â–∏–π –≤–µ—Å\nconst calculatedTotalWeight = items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);\nconst finalTotalWeight = totals.weight || calculatedTotalWeight;\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ (–î–î.–ú–ú.–ì–ì)\nconst now = new Date();\nconst day = String(now.getDate()).padStart(2, '0');\nconst month = String(now.getMonth() + 1).padStart(2, '0');\nconst year = String(now.getFullYear()).slice(-2);\nconst dateStr = `${day}.${month}.${year}`;\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞\nconst excelFilename = `–ó–∞–ø—Ä–æ—Å_${dateStr}_${requestId || '–∑–∞—è–≤–∫–∞'}.xlsx`;\n\n// –ü–æ–ª—É—á–∞–µ–º Excel –≤ base64 –∏–∑ binary –¥–∞–Ω–Ω—ã—Ö\nlet excelBase64 = '';\n\ntry {\n  const binaryData = $input.first().binary;\n  console.log('Binary data keys:', Object.keys(binaryData || {}));\n  \n  if (binaryData) {\n    const binaryKey = Object.keys(binaryData)[0];\n    if (binaryKey && binaryData[binaryKey]) {\n      excelBase64 = binaryData[binaryKey].data;\n      console.log('‚úÖ Excel base64 –∏–∑–≤–ª–µ—á—ë–Ω, –¥–ª–∏–Ω–∞:', excelBase64.length);\n    }\n  }\n} catch (error) {\n  console.log('‚ùå –û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è Excel:', error.message);\n}\n\nconsole.log('üìÑ –ò–º—è —Ñ–∞–π–ª–∞:', excelFilename);\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —Å base64 –≤–Ω—É—Ç—Ä–∏ JSON\nreturn [{\n  json: {\n    success: true,\n    request_id: requestId,\n    timestamp: body.timestamp,\n    total_weight: Number(finalTotalWeight).toFixed(3),\n    items_count: items.length,\n    excel_base64: excelBase64,\n    excel_filename: excelFilename,\n    message: '–ó–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω'\n  }\n}];"
      },
      "id": "48e2e457-b1b3-47a4-9569-58efab0c5401",
      "name": "Code: Prepare Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        640,
        0
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "0cd635cc-1662-4ee9-b507-beff23e7e8ef",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        864,
        0
      ]
    },
    {
      "parameters": {
        "content": "## Supplier Request - Generate Excel\n\n**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**\n- requestId: –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏\n- items: –º–∞—Å—Å–∏–≤ –ø–æ–∑–∏—Ü–∏–π\n- totalWeight: –æ–±—â–∏–π –≤–µ—Å\n- totalPositions: –∫–æ–ª-–≤–æ –ø–æ–∑–∏—Ü–∏–π\n\n**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**\n- JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –∑–∞—è–≤–∫–∏\n- Excel —Ñ–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è",
        "height": 656
      },
      "id": "5368fa03-67c2-42ad-8a57-34246d2572da",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -592,
        -256
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook: Supplier Request": {
      "main": [
        [
          {
            "node": "Code: Prepare Excel Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code: Prepare Excel Data": {
      "main": [
        [
          {
            "node": "Create Excel File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Excel File": {
      "main": [
        [
          {
            "node": "Code: Prepare Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code: Prepare Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "a97bbb6a-e437-476c-9632-1e762d2125ea",
  "meta": {
    "instanceId": "e053b61b8b3bdff69a323dc7c626e5598b37038308beed9b02f6dd362745fcdd"
  },
  "id": "Fh9ttcbDvCBHgJxz",
  "tags": []
}
{
  "name": "Web Calculator API v4",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "calc-parse",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "3b97ef95-4479-44ff-b7b2-2131a4cf0926",
      "name": "Webhook: Parse",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2128,
        -240
      ],
      "webhookId": "calc-parse-001",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "text-content",
              "name": "text_content",
              "value": "={{ $json.body.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "d31598b2-c3db-4138-a4de-2e2cea2a59a7",
      "name": "Set: Text Content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1904,
        -240
      ]
    },
    {
      "parameters": {
        "resource": "chat",
        "chatModel": "gpt-4.1-mini",
        "prompt": {
          "messages": [
            {
              "role": "system",
              "content": "–¢—ã - AI –ø–∞—Ä—Å–µ—Ä –∑–∞—è–≤–æ–∫ –Ω–∞ –ú–ï–¢–ê–õ–õ–û–ü–†–û–ö–ê–¢. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∏–∑–≤–ª–µ—á—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∑–∞—è–≤–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.\n\n**–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô JSON –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:**\n```json\n{\n  \"items\": [\n    {\n      \"name\": \"–¢—Ä—É–±–∞ —ç–ª–µ–∫—Ç—Ä–æ—Å–≤–∞—Ä–Ω–∞—è 57x3.5\",\n      \"quantity\": 100,\n      \"unit\": \"–º\",\n      \"gost\": \"–ì–û–°–¢ 10704-91\",\n      \"pieces\": null,\n      \"length_per_piece\": null,\n      \"width\": null,\n      \"length_sheet\": null,\n      \"steel_grade\": null\n    }\n  ]\n}\n```\n\n**–ü–†–ê–í–ò–õ–ê:**\n1. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ —Ç–æ–Ω–Ω–∞—Ö (—Ç, —Ç–Ω) ‚Üí quantity + unit=\"—Ç–Ω\"\n2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –º–µ—Ç—Ä–∞—Ö (–º, –º.–ø., –ú/–ø, –º/–ø, –ø–æ–≥.–º) ‚Üí quantity + unit=\"–º\"\n3. –®—Ç—É–∫–∏ (—à—Ç, –®—Ç.) ‚Üí pieces (—á–∏—Å–ª–æ) + unit=\"—à—Ç\"\n4. –î–ª–∏–Ω–∞ 1 —à—Ç—É–∫–∏ ‚Üí length_per_piece\n5. –†–∞–∑–º–µ—Ä—ã –ª–∏—Å—Ç–æ–≤ ‚Üí width, length_sheet (–≤ –º–µ—Ç—Ä–∞—Ö)\n6. –ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏ ‚Üí steel_grade\n7. NULL –¥–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª–µ–π\n8. –û—Ç–≤–µ—Ç –¢–û–õ–¨–ö–û JSON –±–µ–∑ markdown\n\n**‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –ö–û–õ–û–ù–û–ö –í –¢–ê–ë–õ–ò–¶–ê–•:**\n- –ö–æ–ª–æ–Ω–∫–∞ \"–ú/–ø\" = –ú–ï–¢–†–´ –ø–æ–≥–æ–Ω–Ω—ã–µ ‚Üí quantity (—á–∏—Å–ª–æ –∫–∞–∫ –µ—Å—Ç—å) + unit=\"–º\"\n- –ö–æ–ª–æ–Ω–∫–∞ \"–®—Ç.\" = –®–¢–£–ö–ò ‚Üí pieces (—á–∏—Å–ª–æ –∫–∞–∫ –µ—Å—Ç—å) + unit=\"—à—Ç\"\n- –ù–ï –ü–ï–†–ï–°–ß–ò–¢–´–í–ê–ô —á–∏—Å–ª–∞! –ë–µ—Ä–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –ö–ê–ö –ï–°–¢–¨\n- –î–ª—è –ë–ê–õ–û–ö, –î–í–£–¢–ê–í–†–û–í, –®–í–ï–õ–õ–ï–†–û–í, –¢–†–£–ë ‚Üí –∫–æ–ª–æ–Ω–∫–∞ –ú/–ø = –ú–ï–¢–†–´\n- –î–ª—è –õ–ò–°–¢–û–í ‚Üí –∫–æ–ª–æ–Ω–∫–∞ –®—Ç. = –®–¢–£–ö–ò\n\n**–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ü–ê–†–°–ò–ù–ì–ê:**\n- \"–î–≤—É—Ç–∞–≤—Ä 30–ë2, –ú/–ø: 204\" ‚Üí quantity: 204, unit: \"–º\" (–ù–ï —Ç–æ–Ω–Ω—ã!)\n- \"–¢—Ä—É–±–∞ 200—Ö100—Ö5, –ú/–ø: 12\" ‚Üí quantity: 12, unit: \"–º\"\n- \"–õ–∏—Å—Ç 8, –®—Ç.: 1\" ‚Üí pieces: 1, unit: \"—à—Ç\"\n- \"–õ–∏—Å—Ç 30, –®—Ç.: –ø–æ–ª.–ª–∏—Å—Ç–∞\" ‚Üí pieces: 0.5, unit: \"—à—Ç\"\n\n**–°–û–ö–†–ê–©–ï–ù–ò–Ø:** —Ö/–∫=—Ö–æ–ª–æ–¥–Ω–æ–∫–∞—Ç–∞–Ω—ã–π, –≥/–∫=–≥–æ—Ä—è—á–µ–∫–∞—Ç–∞–Ω—ã–π, —ç/—Å=—ç–ª–µ–∫—Ç—Ä–æ—Å–≤–∞—Ä–Ω–∞—è, –±/—à=–±–µ—Å—à–æ–≤–Ω–∞—è, –æ—Ü=–æ—Ü–∏–Ω–∫–æ–≤–∞–Ω–Ω–∞—è, –≤–≥–ø=–≤–æ–¥–æ–≥–∞–∑–æ–ø—Ä–æ–≤–æ–¥–Ω–∞—è, –ø—Ä–æ—Ñ=–ø—Ä–æ—Ñ–∏–ª—å–Ω–∞—è\n\n–†–∞—Å–ø–∞—Ä—Å–∏ –∑–∞—è–≤–∫—É:"
            },
            {
              "content": "={{ $json.text_content }}"
            }
          ]
        },
        "options": {
          "maxTokens": 4000,
          "temperature": 0.1
        },
        "requestOptions": {}
      },
      "id": "02b43ac2-6188-4fa3-a165-0eecdce62d56",
      "name": "OpenAI: Parse Order",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1.1,
      "position": [
        -1680,
        -240
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "credentials": {
        "openAiApi": {
          "id": "ZNb2GdFIiM7vrhFZ",
          "name": "OpenAi account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================\n// Code: Process Parse Result v4\n// –ò–ó–ú–ï–ù–ï–ù–û: –§–æ—Ä–º–∏—Ä—É–µ—Ç parsed_data –¥–ª—è Validate Order Fields\n// ============================================================\n\nconst aiMessage = $input.first().json;\nlet parsedData;\nlet success = true;\nlet error = null;\n\ntry {\n  let jsonText = aiMessage.message?.content || aiMessage.content || '';\n  jsonText = jsonText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  parsedData = JSON.parse(jsonText);\n  \n  if (!parsedData.items || !Array.isArray(parsedData.items)) {\n    throw new Error('Invalid AI response: missing items array');\n  }\n  \n  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º items —Å –ø–æ–ª–µ–º name (–Ω—É–∂–Ω–æ –¥–ª—è Validate Order Fields)\n  parsedData.items = parsedData.items.map((item, i) => ({\n    index: i + 1,\n    name: item.name,  // ‚Üê –í–ê–ñ–ù–û: Validate –∏—â–µ—Ç –ø–æ name\n    raw_text: item.name,\n    quantity: item.quantity || item.pieces,\n    unit: item.unit || (item.pieces ? '—à—Ç' : '–º'),\n    pieces: item.pieces,\n    length_per_piece: item.length_per_piece,\n    width: item.width,\n    length_sheet: item.length_sheet,\n    steel_grade: item.steel_grade,\n    gost: item.gost\n  }));\n  \n} catch (e) {\n  success = false;\n  error = e.message;\n  parsedData = { items: [] };\n}\n\n// –§–æ—Ä–º–∞—Ç –¥–ª—è Validate Order Fields:\n// { parsed_data: { items: [...] } }\nreturn [{ \n  json: { \n    _sourceType: 'text',\n    _parseSuccess: success,\n    _parseError: error,\n    parsed_data: {\n      items: parsedData.items\n    }\n  } \n}];"
      },
      "id": "7c54ac4e-19df-4e22-bbc7-1d1f417f7fda",
      "name": "Code: Process Parse Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1456,
        -240
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "calc-parse-file",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "2f4dbdc1-f9aa-4318-b515-24364538c906",
      "name": "Webhook: Parse File",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2128,
        -704
      ],
      "webhookId": "calc-parse-file-001",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞ –∏–∑ binary –¥–∞–Ω–Ω—ã—Ö\nconst item = $input.first();\nconst binary = item.binary || {};\nconst json = item.json || {};\n\n// –ò—â–µ–º —Ñ–∞–π–ª –≤ binary (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–¥ —Ä–∞–∑–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏: data, file, file0 –∏ —Ç.–¥.)\nlet fileData = null;\nlet mimeType = null;\nlet fileName = null;\nlet binaryKey = null;\n\nfor (const key of Object.keys(binary)) {\n  if (binary[key]) {\n    fileData = binary[key];\n    mimeType = fileData.mimeType || '';\n    fileName = fileData.fileName || '';\n    binaryKey = key;\n    break;\n  }\n}\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞ –ø–æ mimeType\nlet fileType = 'unknown';\n\nif (mimeType) {\n  if (mimeType.includes('pdf')) {\n    fileType = 'pdf';\n  } else if (mimeType.includes('spreadsheet') || mimeType.includes('excel') || mimeType.includes('xlsx') || mimeType.includes('xls') || mimeType.includes('openxmlformats-officedocument.spreadsheetml')) {\n    fileType = 'xlsx';\n  } else if (mimeType.includes('image')) {\n    fileType = 'image';\n  } else if (mimeType.includes('text/plain')) {\n    fileType = 'text';\n  }\n}\n\n// –ï—Å–ª–∏ mimeType –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω, —Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞\nif (fileType === 'unknown' && fileName) {\n  const ext = fileName.split('.').pop()?.toLowerCase();\n  if (ext === 'pdf') fileType = 'pdf';\n  else if (['xlsx', 'xls'].includes(ext)) fileType = 'xlsx';\n  else if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext)) fileType = 'image';\n  else if (['txt', 'csv'].includes(ext)) fileType = 'text';\n}\n\nreturn [{ \n  json: { \n    ...json,\n    _fileType: fileType,\n    _mimeType: mimeType,\n    _fileName: fileName,\n    _binaryKey: binaryKey,\n    _debug: {\n      binaryKeys: Object.keys(binary),\n      hasBinary: Object.keys(binary).length > 0\n    }\n  },\n  binary: binary\n}];"
      },
      "id": "c5c6c1f3-368d-4365-bfa9-9e756a2f5a99",
      "name": "Code: Detect File Type",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1904,
        -704
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json._fileType }}",
                    "rightValue": "pdf",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PDF"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json._fileType }}",
                    "rightValue": "xlsx",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "XLSX"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json._fileType }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Image"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "5fa5a148-9629-410c-a9f4-7539fe22bfad",
      "name": "Switch: File Type",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1680,
        -736
      ]
    },
    {
      "parameters": {
        "operation": "pdf",
        "binaryPropertyName": "={{ $json._binaryKey || 'data' }}",
        "options": {}
      },
      "id": "4694b05e-d566-4d82-bd7c-16e9bb4e7d69",
      "name": "Extract: PDF",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -1456,
        -960
      ]
    },
    {
      "parameters": {
        "operation": "xlsx",
        "binaryPropertyName": "file",
        "options": {}
      },
      "id": "ddd00642-ec1e-44c9-848c-484bff455bfd",
      "name": "Extract: XLSX",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -1456,
        -800
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================================\n// Code: Combine Text v4.4 (FIXED markdown wrapper)\n// –°–æ–±–∏—Ä–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (PDF, XLSX, Vision)\n// ============================================================\nconst items = $input.all();\nlet text = '';\nlet sourceType = 'unknown';\nlet debugInfo = [];\n\nif (items.length === 0) {\n  return [{ json: { text_content: '', _sourceType: 'empty', _debug: ['No input items'] } }];\n}\n\nlet firstItem = items[0].json;\n\n// –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ (Vision –∏–Ω–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç [[{...}]])\nif (Array.isArray(firstItem) && firstItem.length > 0) {\n  firstItem = firstItem[0];\n  debugInfo.push('Unwrapped nested array');\n}\n\nconst firstItemKeys = Object.keys(firstItem);\ndebugInfo.push(`First item keys: ${firstItemKeys.join(', ')}`);\n\n// 1. Vision (OpenAI/Claude) - content –º–∞—Å—Å–∏–≤ —Å output_text\nif (Array.isArray(firstItem.content) && firstItem.content[0]?.text) {\n  text = firstItem.content[0].text;\n  sourceType = 'image';\n  debugInfo.push('Vision response (content[0].text)');\n}\n// 2. Vision –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç - message.content\nelse if (firstItem.message?.content) {\n  text = firstItem.message.content;\n  sourceType = 'image';\n  debugInfo.push('Vision response (message.content)');\n}\n// 3. PDF - –æ–±—ã—á–Ω–æ –∏–º–µ–µ—Ç –ø–æ–ª–µ text\nelse if (firstItem.text && typeof firstItem.text === 'string' && firstItem.text.length > 10) {\n  text = firstItem.text;\n  sourceType = 'pdf';\n  debugInfo.push('PDF text extracted');\n}\n// 4. XLSX - –º–Ω–æ–∂–µ—Å—Ç–≤–æ items —Å —Ç–∞–±–ª–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏\nelse if (items.length > 1 || \n         firstItem.row !== undefined || \n         firstItem['A'] !== undefined || \n         firstItemKeys.some(k => !k.startsWith('_') && k !== 'binary' && k !== 'pairedItem')) {\n  \n  const hasTableData = items.length > 1 || \n                       firstItemKeys.some(k => /^[A-Z]$/.test(k)) ||\n                       firstItemKeys.some(k => !k.startsWith('_') && typeof firstItem[k] !== 'object');\n  \n  if (hasTableData) {\n    sourceType = 'xlsx';\n    debugInfo.push('XLSX detected');\n    debugInfo.push(`Columns: ${firstItemKeys.filter(k => !k.startsWith('_')).join(', ')}`);\n    \n    const rows = items.map(item => {\n      const rowData = item.json;\n      return Object.entries(rowData)\n        .filter(([key, value]) => value !== undefined && value !== null && value !== '' && (!key.startsWith('_') || key.startsWith('__')))\n        .map(([key, value]) => `${key}: ${String(value)}`)\n        .join(' | ');\n    }).filter(row => row.trim());\n    \n    text = rows.join('\\n');\n    debugInfo.push(`Rows combined: ${rows.length}`);\n  }\n}\n// 5. Direct content string\nelse if (typeof firstItem.content === 'string') {\n  text = firstItem.content;\n  sourceType = 'text';\n  debugInfo.push('Direct content string');\n}\n// 6. Fallback - body.text\nelse if (firstItem.body?.text) {\n  text = firstItem.body.text;\n  sourceType = 'text';\n  debugInfo.push('Body text fallback');\n}\n\n// ‚úÖ –ù–û–í–û–ï: –£–±–∏—Ä–∞–µ–º markdown-–æ–±—ë—Ä—Ç–∫—É ```json ... ``` (Vision –∏–Ω–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç)\nif (text) {\n  const originalLength = text.length;\n  text = text.replace(/^```json\\s*\\n?/i, '').replace(/\\n?```\\s*$/i, '').trim();\n  if (text.length !== originalLength) {\n    debugInfo.push('Removed markdown wrapper');\n  }\n}\n\nif (!text) {\n  debugInfo.push('WARNING: No text extracted!');\n  debugInfo.push(`Structure: ${JSON.stringify(firstItem).substring(0, 300)}`);\n}\n\nreturn [{ \n  json: { \n    text_content: text,\n    _sourceType: sourceType,\n    _debug: debugInfo,\n    _itemsCount: items.length\n  } \n}];"
      },
      "id": "dfe0a132-8b48-4d45-a913-ee47396ed87d",
      "name": "Code: Combine Text",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1232,
        -800
      ]
    },
    {
      "parameters": {
        "resource": "chat",
        "chatModel": "gpt-4.1-mini",
        "prompt": {
          "messages": [
            {
              "role": "system",
              "content": "–¢—ã - AI –ø–∞—Ä—Å–µ—Ä –∑–∞—è–≤–æ–∫ –Ω–∞ –ú–ï–¢–ê–õ–õ–û–ü–†–û–ö–ê–¢. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∏–∑–≤–ª–µ—á—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∑–∞—è–≤–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.\n\n**–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô JSON –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:**\n```json\n{\n  \"items\": [\n    {\n      \"name\": \"–¢—Ä—É–±–∞ —ç–ª–µ–∫—Ç—Ä–æ—Å–≤–∞—Ä–Ω–∞—è 57x3.5\",\n      \"quantity\": 100,\n      \"unit\": \"–º\",\n      \"gost\": \"–ì–û–°–¢ 10704-91\",\n      \"pieces\": null,\n      \"length_per_piece\": null,\n      \"width\": null,\n      \"length_sheet\": null,\n      \"steel_grade\": null\n    }\n  ]\n}\n```\n\n**–ü–†–ê–í–ò–õ–ê:**\n1. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ —Ç–æ–Ω–Ω–∞—Ö (—Ç, —Ç–Ω) ‚Üí quantity + unit=\"—Ç–Ω\"\n2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –ö–ò–õ–û–ì–†–ê–ú–ú–ê–• (–∫–≥, –ö–ì, –∫–∏–ª–æ–≥—Ä–∞–º–º) ‚Üí –†–ê–ó–î–ï–õ–ò –ù–ê 1000 ‚Üí quantity + unit=\"—Ç–Ω\"\n3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –º–µ—Ç—Ä–∞—Ö (–º, –º.–ø., –ú/–ø, –º/–ø, –ø–æ–≥.–º) ‚Üí quantity + unit=\"–º\"\n4. –®—Ç—É–∫–∏ (—à—Ç, –®—Ç.) ‚Üí pieces (—á–∏—Å–ª–æ) + unit=\"—à—Ç\"\n5. –î–ª–∏–Ω–∞ 1 —à—Ç—É–∫–∏ ‚Üí length_per_piece\n6. –†–∞–∑–º–µ—Ä—ã –ª–∏—Å—Ç–æ–≤ ‚Üí width, length_sheet (–≤ –º–µ—Ç—Ä–∞—Ö)\n7. –ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏ ‚Üí steel_grade\n8. NULL –¥–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª–µ–π\n9. –û—Ç–≤–µ—Ç –¢–û–õ–¨–ö–û JSON –±–µ–∑ markdown\n\n**‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –ö–û–õ–û–ù–û–ö –í –¢–ê–ë–õ–ò–¶–ê–•:**\n- –ö–æ–ª–æ–Ω–∫–∞ \"–ú/–ø\" = –ú–ï–¢–†–´ –ø–æ–≥–æ–Ω–Ω—ã–µ ‚Üí quantity (—á–∏—Å–ª–æ –∫–∞–∫ –µ—Å—Ç—å) + unit=\"–º\"\n- –ö–æ–ª–æ–Ω–∫–∞ \"–®—Ç.\" = –®–¢–£–ö–ò ‚Üí pieces (—á–∏—Å–ª–æ –∫–∞–∫ –µ—Å—Ç—å) + unit=\"—à—Ç\"\n- –ö–æ–ª–æ–Ω–∫–∞ \"–∫–≥\" –∏–ª–∏ \"–ö–ì\" = –ö–ò–õ–û–ì–†–ê–ú–ú–´ ‚Üí –†–ê–ó–î–ï–õ–ò –ù–ê 1000 ‚Üí quantity + unit=\"—Ç–Ω\"\n- –ù–ï –ü–ï–†–ï–°–ß–ò–¢–´–í–ê–ô —á–∏—Å–ª–∞! –ë–µ—Ä–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –ö–ê–ö –ï–°–¢–¨ (–∫—Ä–æ–º–µ –∫–≥‚Üí—Ç–Ω)\n- –î–ª—è –ë–ê–õ–û–ö, –î–í–£–¢–ê–í–†–û–í, –®–í–ï–õ–õ–ï–†–û–í, –¢–†–£–ë ‚Üí –∫–æ–ª–æ–Ω–∫–∞ –ú/–ø = –ú–ï–¢–†–´\n- –î–ª—è –õ–ò–°–¢–û–í ‚Üí –∫–æ–ª–æ–Ω–∫–∞ –®—Ç. = –®–¢–£–ö–ò\n\n**–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ü–ê–†–°–ò–ù–ì–ê:**\n- \"–î–≤—É—Ç–∞–≤—Ä 30–ë2, –ú/–ø: 204\" ‚Üí quantity: 204, unit: \"–º\" (–ù–ï —Ç–æ–Ω–Ω—ã!)\n- \"–¢—Ä—É–±–∞ 200—Ö100—Ö5, –ú/–ø: 12\" ‚Üí quantity: 12, unit: \"–º\"\n- \"–õ–∏—Å—Ç 8, –®—Ç.: 1\" ‚Üí pieces: 1, unit: \"—à—Ç\"\n- \"–õ–∏—Å—Ç 30, –®—Ç.: –ø–æ–ª.–ª–∏—Å—Ç–∞\" ‚Üí pieces: 0.5, unit: \"—à—Ç\"\n- \"–®–≤–µ–ª–ª–µ—Ä 20–ü, –∫–≥: 1288.78\" ‚Üí quantity: 1.289, unit: \"—Ç–Ω\" (1288.78 / 1000)\n- \"–£–≥–æ–ª–æ–∫ 100—Ö10, –∫–≥: 872.97\" ‚Üí quantity: 0.873, unit: \"—Ç–Ω\" (872.97 / 1000)\n\n**–°–û–ö–†–ê–©–ï–ù–ò–Ø:** —Ö/–∫=—Ö–æ–ª–æ–¥–Ω–æ–∫–∞—Ç–∞–Ω—ã–π, –≥/–∫=–≥–æ—Ä—è—á–µ–∫–∞—Ç–∞–Ω—ã–π, —ç/—Å=—ç–ª–µ–∫—Ç—Ä–æ—Å–≤–∞—Ä–Ω–∞—è, –±/—à=–±–µ—Å—à–æ–≤–Ω–∞—è, –æ—Ü=–æ—Ü–∏–Ω–∫–æ–≤–∞–Ω–Ω–∞—è, –≤–≥–ø=–≤–æ–¥–æ–≥–∞–∑–æ–ø—Ä–æ–≤–æ–¥–Ω–∞—è, –ø—Ä–æ—Ñ=–ø—Ä–æ—Ñ–∏–ª—å–Ω–∞—è\n\n–†–∞—Å–ø–∞—Ä—Å–∏ –∑–∞—è–≤–∫—É:"
            },
            {
              "content": "={{ $json.text_content }}"
            }
          ]
        },
        "options": {},
        "requestOptions": {}
      },
      "id": "29a2d083-07cc-48eb-844a-8457ab1b5f1d",
      "name": "OpenAI: Parse File Content",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1.1,
      "position": [
        -1024,
        -800
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "credentials": {
        "openAiApi": {
          "id": "ZNb2GdFIiM7vrhFZ",
          "name": "OpenAi account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================\n// Code: Process File Parse v4\n// –ò–ó–ú–ï–ù–ï–ù–û: –§–æ—Ä–º–∏—Ä—É–µ—Ç parsed_data –¥–ª—è Validate Order Fields\n// ============================================================\n\nconst aiMessage = $input.first().json;\nconst combineData = $('Code: Combine Text').first().json;\n\nlet parsedData;\nlet success = true;\nlet error = null;\n\ntry {\n  let jsonText = aiMessage.message?.content || aiMessage.content || '';\n  jsonText = jsonText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  parsedData = JSON.parse(jsonText);\n  \n  if (!parsedData.items || !Array.isArray(parsedData.items)) {\n    throw new Error('Invalid AI response: missing items array');\n  }\n  \n  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º items —Å –ø–æ–ª–µ–º name (–Ω—É–∂–Ω–æ –¥–ª—è Validate Order Fields)\n  parsedData.items = parsedData.items.map((item, i) => ({\n    index: i + 1,\n    name: item.name,  // ‚Üê –í–ê–ñ–ù–û: Validate –∏—â–µ—Ç –ø–æ name\n    raw_text: item.name,\n    quantity: item.quantity || item.pieces,\n    unit: item.unit || (item.pieces ? '—à—Ç' : '–º'),\n    pieces: item.pieces,\n    length_per_piece: item.length_per_piece,\n    width: item.width,\n    length_sheet: item.length_sheet,\n    steel_grade: item.steel_grade,\n    gost: item.gost\n  }));\n  \n} catch (e) {\n  success = false;\n  error = e.message;\n  parsedData = { items: [] };\n}\n\n// –§–æ—Ä–º–∞—Ç –¥–ª—è Validate Order Fields:\n// { parsed_data: { items: [...] } }\nreturn [{ \n  json: { \n    _sourceType: combineData._sourceType,\n    _parseSuccess: success,\n    _parseError: error,\n    _debug: combineData._debug,\n    parsed_data: {\n      items: parsedData.items\n    }\n  } \n}];"
      },
      "id": "dcb56680-d97a-45d5-b401-db6b25401790",
      "name": "Code: Process File Parse",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -800,
        -800
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================================\n// CODE: Validate Order Fields V3.1\n// –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –ª–∏—Å—Ç–æ–≤ (—Ç–æ–ª—â–∏–Ω–∞ + —Ä–∞—Å–∫—Ä–æ–π)\n// ============================================================\n\nconst inputData = $input.first().json;\nconst parsedData = inputData.parsed_data;\n\n// === SUPABASE CONFIG ===\nconst SUPABASE_URL = 'https://neeejfmscjetprxjscto.supabase.co';\nconst SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lZWVqZm1zY2pldHByeGpzY3RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NTAyNTYsImV4cCI6MjA3NjMyNjI1Nn0.wHOtFj_pFGPEzDt2RMQr_zHfg10i9msvSi79tQCjnvU';\n\n// === DEBUG INFO ===\nconst debug = {\n  version: 'v3.1',\n  timestamp: new Date().toISOString(),\n  metalTypesLoaded: false,\n  metalTypesCount: 0,\n  errors: [],\n  warnings: [],\n  itemsProcessed: 0,\n  itemsValidated: 0\n};\n\nconsole.log('üöÄ Validate Order Fields v3.1 started');\n\n// ============================================================\n// –°–¢–ê–ù–î–ê–†–¢–ù–´–ï –†–ê–°–ö–†–û–ò –õ–ò–°–¢–û–í (—à–∏—Ä–∏–Ω–∞ √ó –¥–ª–∏–Ω–∞ –≤ –º–º)\n// ============================================================\nconst STANDARD_SHEET_CUTS = [\n  { width: 1000, length: 2000 },\n  { width: 1250, length: 2500 },\n  { width: 1500, length: 3000 },\n  { width: 1500, length: 6000 },\n  { width: 2000, length: 6000 },\n  // –í –º–µ—Ç—Ä–∞—Ö (–¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ 1.25√ó2.5)\n  { width: 1, length: 2 },\n  { width: 1.25, length: 2.5 },\n  { width: 1.5, length: 3 },\n  { width: 1.5, length: 6 },\n];\n\n// ============================================================\n// 1. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò\n// ============================================================\n\n/**\n * –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –ë–î\n */\nfunction normalizeSize(size) {\n  if (!size) return '';\n  return String(size)\n    .toLowerCase()\n    .replace(/[√óxX—Ö–•\\*]/g, '—Ö')\n    .replace(/,/g, '.')\n    .replace(/\\s+/g, '')\n    .replace(/–º–º|mm/gi, '')\n    .trim();\n}\n\n/**\n * –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤—Å–µ—Ö —á–∏—Å–µ–ª –∏–∑ —Å—Ç—Ä–æ–∫–∏\n */\nfunction extractNumbers(text) {\n  if (!text) return [];\n  const regex = /\\d+(?:[.,]\\d+)?/g;\n  const matches = text.match(regex);\n  if (!matches) return [];\n  return matches.map(m => parseFloat(m.replace(',', '.')));\n}\n\n/**\n * –ü—Ä–æ–≤–µ—Ä–∫–∞: —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–∞—Ä–∞ —á–∏—Å–µ–ª —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —Ä–∞—Å–∫—Ä–æ–µ–º –ª–∏—Å—Ç–∞\n * @returns {object|null} { width, length } –≤ –º–µ—Ç—Ä–∞—Ö –∏–ª–∏ null\n */\nfunction isSheetCut(num1, num2) {\n  // –°–æ—Ä—Ç–∏—Ä—É–µ–º: –º–µ–Ω—å—à–µ–µ = —à–∏—Ä–∏–Ω–∞, –±–æ–ª—å—à–µ–µ = –¥–ª–∏–Ω–∞\n  const w = Math.min(num1, num2);\n  const l = Math.max(num1, num2);\n  \n  for (const cut of STANDARD_SHEET_CUTS) {\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –º–º\n    if ((w === cut.width && l === cut.length) || \n        (Math.abs(w - cut.width) < 1 && Math.abs(l - cut.length) < 1)) {\n      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –º–µ—Ç—Ä–∞—Ö\n      return {\n        width: cut.width >= 100 ? cut.width / 1000 : cut.width,\n        length: cut.length >= 100 ? cut.length / 1000 : cut.length\n      };\n    }\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –º–µ—Ç—Ä–∞—Ö (1.25√ó2.5)\n    if (Math.abs(w - cut.width) < 0.01 && Math.abs(l - cut.length) < 0.01) {\n      return { width: w, length: l };\n    }\n  }\n  \n  // –≠–≤—Ä–∏—Å—Ç–∏–∫–∞: –µ—Å–ª–∏ –æ–±–∞ —á–∏—Å–ª–∞ > 100, —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ —Ä–∞—Å–∫—Ä–æ–π –≤ –º–º\n  if (w >= 100 && l >= 100 && w <= 3000 && l <= 12000) {\n    return { width: w / 1000, length: l / 1000 };\n  }\n  \n  // –≠–≤—Ä–∏—Å—Ç–∏–∫–∞: –µ—Å–ª–∏ –æ–±–∞ —á–∏—Å–ª–∞ < 10 –∏ –ø–æ—Ö–æ–∂–∏ –Ω–∞ –º–µ—Ç—Ä—ã (1.25, 2.5)\n  if (w > 0.5 && w < 5 && l > 1 && l < 15) {\n    return { width: w, length: l };\n  }\n  \n  return null;\n}\n\n/**\n * –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ò —Ä–∞—Å–∫—Ä–æ—è –¥–ª—è –õ–ò–°–¢–û–í\n * @returns { size: string, width: number, lengthSheet: number }\n */\nfunction extractSheetParams(itemName) {\n  const numbers = extractNumbers(itemName);\n  \n  if (numbers.length === 0) {\n    return { size: null, width: null, lengthSheet: null };\n  }\n  \n  // –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω AxB (—Ä–∞—Å–∫—Ä–æ–π)\n  const cutMatch = itemName.match(/(\\d+(?:[.,]\\d+)?)\\s*[√óxX—Ö–•\\*]\\s*(\\d+(?:[.,]\\d+)?)/i);\n  \n  let thickness = null;\n  let width = null;\n  let lengthSheet = null;\n  \n  if (cutMatch) {\n    // –ï—Å—Ç—å —Ä–∞—Å–∫—Ä–æ–π\n    const cutNum1 = parseFloat(cutMatch[1].replace(',', '.'));\n    const cutNum2 = parseFloat(cutMatch[2].replace(',', '.'));\n    \n    const sheetCut = isSheetCut(cutNum1, cutNum2);\n    \n    if (sheetCut) {\n      // –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ä–∞—Å–∫—Ä–æ–π\n      width = sheetCut.width;\n      lengthSheet = sheetCut.length;\n      \n      // –¢–æ–ª—â–∏–Ω–∞ = –¥—Ä—É–≥–æ–µ —á–∏—Å–ª–æ –≤ —Å—Ç—Ä–æ–∫–µ (–Ω–µ —á–∞—Å—Ç—å —Ä–∞—Å–∫—Ä–æ—è)\n      for (const num of numbers) {\n        // –ß–∏—Å–ª–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é —Ä–∞—Å–∫—Ä–æ—è\n        if (Math.abs(num - cutNum1) > 0.01 && Math.abs(num - cutNum2) > 0.01) {\n          // –¢–æ–ª—â–∏–Ω–∞ –æ–±—ã—á–Ω–æ 0.3 - 200 –º–º\n          if (num >= 0.3 && num <= 200) {\n            thickness = num;\n            break;\n          }\n        }\n      }\n    } else {\n      // –î–≤–∞ —á–∏—Å–ª–∞ —á–µ—Ä–µ–∑ √ó –Ω–æ —ç—Ç–æ –ù–ï —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞—Å–∫—Ä–æ–π\n      // –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ \"8√ó1250\" - –æ—à–∏–±–∫–∞ –≤–≤–æ–¥–∞\n      // –ë–µ—Ä—ë–º –ø–µ—Ä–≤–æ–µ –æ–¥–∏–Ω–æ—á–Ω–æ–µ —á–∏—Å–ª–æ –∫–∞–∫ —Ç–æ–ª—â–∏–Ω—É\n      for (const num of numbers) {\n        if (num >= 0.3 && num <= 200) {\n          thickness = num;\n          break;\n        }\n      }\n    }\n  } else {\n    // –ù–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞ A√óB, –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–∞\n    // –ü–µ—Ä–≤–æ–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ —á–∏—Å–ª–æ = —Ç–æ–ª—â–∏–Ω–∞\n    for (const num of numbers) {\n      if (num >= 0.3 && num <= 200) {\n        thickness = num;\n        break;\n      }\n    }\n  }\n  \n  return {\n    size: thickness !== null ? String(thickness) : null,\n    width: width,\n    lengthSheet: lengthSheet\n  };\n}\n\n/**\n * –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏\n * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—ã: 57√ó3.5, 80x80x3, ‚åÄ219, d159, ‚Ññ20, 20–ö1 –∏ —Ç.–¥.\n */\nfunction extractSizeFromName(itemName, metalKey, category) {\n  if (!itemName) return null;\n  \n  const name = itemName.toLowerCase();\n  \n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // –°–ü–ï–¶–ò–ê–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –î–õ–Ø –õ–ò–°–¢–û–í\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  if (category === 'sheet' || (metalKey && metalKey.includes('sheet'))) {\n    const sheetParams = extractSheetParams(itemName);\n    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ–ª—â–∏–Ω—É –∫–∞–∫ —Ä–∞–∑–º–µ—Ä\n    // width –∏ lengthSheet –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –≤ item\n    return sheetParams.size;\n  }\n  \n  // === –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –ü–ê–¢–¢–ï–†–ù–´ ===\n  \n  // 1. –ë–∞–ª–∫–∏ –∏ —à–≤–µ–ª–ª–µ—Ä—ã: –Ω–æ–º–µ—Ä + —Å–µ—Ä–∏—è (20–ö1, 10–ë1, 16–ü, 24–£)\n  if (metalKey && (metalKey.includes('beam') || metalKey.includes('shveller'))) {\n    const beamMatch = itemName.match(/(\\d+)\\s*([–ê-–Ø–∞-—èA-Za-z]+\\d*)/);\n    if (beamMatch) {\n      return beamMatch[1] + beamMatch[2];\n    }\n    const numMatch = itemName.match(/‚Ññ?\\s*(\\d+)/);\n    if (numMatch) {\n      return numMatch[1];\n    }\n  }\n  \n  // 2. –¢—Ä—É–±—ã —Å 3 —Ä–∞–∑–º–µ—Ä–∞–º–∏: 80√ó80√ó3 –∏–ª–∏ 100—Ö40—Ö2\n  const pipe3Match = itemName.match(/(\\d+(?:[.,]\\d+)?)\\s*[√óxX—Ö–•\\*]\\s*(\\d+(?:[.,]\\d+)?)\\s*[√óxX—Ö–•\\*]\\s*(\\d+(?:[.,]\\d+)?)/i);\n  if (pipe3Match) {\n    const a = pipe3Match[1].replace(',', '.');\n    const b = pipe3Match[2].replace(',', '.');\n    const c = pipe3Match[3].replace(',', '.');\n    return `${a}—Ö${b}—Ö${c}`;\n  }\n  \n  // 3. –¢—Ä—É–±—ã —Å 2 —Ä–∞–∑–º–µ—Ä–∞–º–∏: 57√ó3.5 –∏–ª–∏ 159—Ö4.5\n  const pipe2Match = itemName.match(/(\\d+(?:[.,]\\d+)?)\\s*[√óxX—Ö–•\\*]\\s*(\\d+(?:[.,]\\d+)?)/i);\n  if (pipe2Match) {\n    const d = parseFloat(pipe2Match[1].replace(',', '.'));\n    const s = parseFloat(pipe2Match[2].replace(',', '.'));\n    \n    // ‚úÖ –ö–í–ê–î–†–ê–¢–ù–´–ï –¢–†–£–ë–´: 80√ó3 ‚Üí 80√ó80√ó3\n    // –ï—Å–ª–∏ metalKey —Å–æ–¥–µ—Ä–∂–∏—Ç \"kvadr\" –∏ –≤—Ç–æ—Ä–æ–µ —á–∏—Å–ª–æ —è–≤–Ω–æ –º–µ–Ω—å—à–µ –ø–µ—Ä–≤–æ–≥–æ (—Ç–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω–∫–∏)\n    // —Ç–æ —ç—Ç–æ —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: —Å—Ç–æ—Ä–æ–Ω–∞ √ó —Ç–æ–ª—â–∏–Ω–∞\n    if (metalKey && metalKey.includes('kvadr') && s < d && s <= 12) {\n      // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º: 80√ó3 ‚Üí 80√ó80√ó3\n      return `${d}—Ö${d}—Ö${s}`;\n    }\n    \n    // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö (–∫—Ä—É–≥–ª—ã–µ —Ç—Ä—É–±—ã –∏ —Ç.–¥.): –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å\n    return `${d}—Ö${s}`;\n  }\n  \n  // 4. –î–∏–∞–º–µ—Ç—Ä: ‚åÄ219, √ò159, d57\n  const diamMatch = itemName.match(/[‚åÄ√ò√∏]\\s*(\\d+(?:[.,]\\d+)?)/);\n  if (diamMatch) {\n    return diamMatch[1].replace(',', '.');\n  }\n  const dMatch = itemName.match(/\\bd\\s*(\\d+(?:[.,]\\d+)?)/i);\n  if (dMatch) {\n    return dMatch[1].replace(',', '.');\n  }\n  \n  // 5. –ê—Ä–º–∞—Ç—É—Ä–∞, –∫—Ä—É–≥, –ø—Ä–æ–≤–æ–ª–æ–∫–∞: –ø—Ä–æ—Å—Ç–æ –¥–∏–∞–º–µ—Ç—Ä (12, 16, 25)\n  if (category === 'wire' || (metalKey && (metalKey.includes('armature') || metalKey.includes('circle') || metalKey.includes('wire') || metalKey.includes('katanka')))) {\n    const numbers = extractNumbers(itemName);\n    for (const num of numbers) {\n      if (num > 0 && num < 100) {\n        return String(num);\n      }\n    }\n  }\n  \n  // 6. –û–±—â–∏–π fallback: –ø–µ—Ä–≤—ã–µ —á–∏—Å–ª–∞ —á–µ—Ä–µ–∑ √ó\n  const numbers = extractNumbers(itemName);\n  if (numbers.length >= 3) {\n    return `${numbers[0]}—Ö${numbers[1]}—Ö${numbers[2]}`;\n  } else if (numbers.length === 2) {\n    return `${numbers[0]}—Ö${numbers[1]}`;\n  } else if (numbers.length === 1) {\n    return String(numbers[0]);\n  }\n  \n  return null;\n}\n\n/**\n * –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–∞—Å–∫—Ä–æ—è –ª–∏—Å—Ç–∞ (—à–∏—Ä–∏–Ω–∞ –∏ –¥–ª–∏–Ω–∞)\n * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –ø–æ—Å–ª–µ extractSizeFromName\n */\nfunction extractSheetCut(itemName, metalKey, category) {\n  if (category !== 'sheet' && !(metalKey && metalKey.includes('sheet'))) {\n    return { width: null, lengthSheet: null };\n  }\n  \n  const sheetParams = extractSheetParams(itemName);\n  return {\n    width: sheetParams.width,\n    lengthSheet: sheetParams.lengthSheet\n  };\n}\n\n/**\n * –ü–æ–∏—Å–∫ —Ç–∏–ø–∞ –º–µ—Ç–∞–ª–ª–∞ –ø–æ aliases (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)\n */\nfunction findMetalType(itemName, metalTypes) {\n  if (!itemName || !metalTypes || metalTypes.length === 0) return null;\n  \n  const nameLower = itemName.toLowerCase().trim();\n  \n  let bestMatch = null;\n  let bestScore = 0;\n  \n  for (const metalType of metalTypes) {\n    let aliases = metalType.aliases || [];\n    \n    if (typeof aliases === 'string') {\n      try {\n        const cleaned = aliases.replace(/^\"\\{/, '[').replace(/\\}\"$/, ']').replace(/\\\\\"/g, '\"');\n        aliases = JSON.parse(cleaned);\n      } catch (e) {\n        try {\n          aliases = JSON.parse(aliases);\n        } catch (e2) {\n          aliases = [];\n        }\n      }\n    }\n    \n    for (const alias of aliases) {\n      if (!alias) continue;\n      const aliasLower = alias.toLowerCase().trim();\n      \n      if (nameLower.includes(aliasLower)) {\n        const score = aliasLower.length * 2;\n        if (score > bestScore) {\n          bestScore = score;\n          bestMatch = metalType;\n        }\n      }\n      \n      if (aliasLower.includes(nameLower) && nameLower.length >= 3) {\n        const score = nameLower.length;\n        if (score > bestScore) {\n          bestScore = score;\n          bestMatch = metalType;\n        }\n      }\n    }\n  }\n  \n  return bestMatch;\n}\n\n/**\n * Fuzzy matching —Ä–∞–∑–º–µ—Ä–æ–≤\n */\nfunction fuzzyMatchSize(targetDims, metalSizes, tolerance = 0.05) {\n  if (!targetDims || targetDims.length === 0 || !metalSizes || metalSizes.length === 0) {\n    return null;\n  }\n  \n  let bestMatch = null;\n  let bestDistance = Infinity;\n  \n  for (const sizeRecord of metalSizes) {\n    const dbDims = [\n      sizeRecord.dimension_1,\n      sizeRecord.dimension_2,\n      sizeRecord.dimension_3\n    ].filter(d => d !== null && d !== undefined);\n    \n    // –î–ª—è –ª–∏—Å—Ç–æ–≤: —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –ø–µ—Ä–≤–æ–º—É –∏–∑–º–µ—Ä–µ–Ω–∏—é (—Ç–æ–ª—â–∏–Ω–µ)\n    if (sizeRecord.category === 'sheet') {\n      if (targetDims.length >= 1 && dbDims.length >= 1) {\n        const diff = Math.abs(targetDims[0] - dbDims[0]);\n        const maxVal = Math.max(targetDims[0], dbDims[0]);\n        \n        if (maxVal === 0 || diff / maxVal <= tolerance) {\n          if (diff < bestDistance) {\n            bestDistance = diff;\n            bestMatch = sizeRecord;\n          }\n        }\n      }\n    } else {\n      if (dbDims.length !== targetDims.length) continue;\n      \n      let distance = 0;\n      let withinTolerance = true;\n      \n      for (let i = 0; i < targetDims.length; i++) {\n        const diff = Math.abs(targetDims[i] - dbDims[i]);\n        const maxVal = Math.max(targetDims[i], dbDims[i]);\n        \n        if (maxVal > 0 && diff / maxVal > tolerance) {\n          withinTolerance = false;\n          break;\n        }\n        \n        distance += diff * diff;\n      }\n      \n      if (withinTolerance) {\n        distance = Math.sqrt(distance);\n        if (distance < bestDistance) {\n          bestDistance = distance;\n          bestMatch = sizeRecord;\n        }\n      }\n    }\n  }\n  \n  return bestMatch;\n}\n\n// ============================================================\n// 2. –ó–ê–ì–†–£–ó–ö–ê –°–ü–†–ê–í–û–ß–ù–ò–ö–û–í\n// ============================================================\n\nlet metalTypes = [];\n\ntry {\n  console.log('üì• Loading metal_types...');\n  \n  const typesResponse = await this.helpers.httpRequest({\n    method: 'GET',\n    url: `${SUPABASE_URL}/rest/v1/metal_types?select=*`,\n    headers: {\n      'apikey': SUPABASE_ANON_KEY,\n      'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\n      'Content-Type': 'application/json'\n    },\n    json: true\n  });\n  \n  if (Array.isArray(typesResponse)) {\n    metalTypes = typesResponse;\n    debug.metalTypesLoaded = true;\n    debug.metalTypesCount = metalTypes.length;\n    console.log(`‚úÖ metal_types loaded: ${metalTypes.length} records`);\n  } else {\n    throw new Error('metal_types response is not an array');\n  }\n} catch (error) {\n  debug.errors.push(`metal_types load error: ${error.message}`);\n  console.error('‚ùå metal_types load error:', error.message);\n}\n\nif (metalTypes.length === 0) {\n  return [{\n    json: {\n      success: false,\n      error: 'CRITICAL: metal_types not loaded',\n      items: [],\n      _debug: debug\n    }\n  }];\n}\n\n// ============================================================\n// 3. –í–ê–õ–ò–î–ê–¶–ò–Ø –ö–ê–ñ–î–û–ô –ü–û–ó–ò–¶–ò–ò\n// ============================================================\n\nconst validatedItems = [];\n\nif (!parsedData || !parsedData.items || !Array.isArray(parsedData.items)) {\n  debug.errors.push('parsed_data.items is missing or not an array');\n  return [{\n    json: {\n      success: false,\n      error: 'No items to validate',\n      items: [],\n      _debug: debug\n    }\n  }];\n}\n\nconsole.log(`üìã Validating ${parsedData.items.length} items...`);\n\nfor (const item of parsedData.items) {\n  debug.itemsProcessed++;\n  \n  const itemDebug = {\n    original_name: item.name,\n    steps: []\n  };\n  \n  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n  // 3.1. –ü–û–ò–°–ö –¢–ò–ü–ê –ú–ï–¢–ê–õ–õ–ê\n  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n  \n  const metalType = findMetalType(item.name, metalTypes);\n  \n  if (!metalType) {\n    itemDebug.steps.push('‚ùå Metal type not found');\n    validatedItems.push({\n      ...item,\n      metal_key: null,\n      metal_name: item.name,\n      _validation_passed: false,\n      _validation_error: '–¢–∏–ø –º–µ—Ç–∞–ª–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ'\n    });\n    debug.warnings.push(`Metal type not found for: \"${item.name}\"`);\n    continue;\n  }\n  \n  item.metal_key = metalType.metal_key;  // ‚Üê –ö–õ–Æ–ß–ï–í–û–ï –ü–û–õ–ï!\n  item.metal_name = metalType.metal_name;\n  item._metalKey = metalType.metal_key;\n  item._metalName = metalType.metal_name;\n  item._category = metalType.category;\n  itemDebug.steps.push(`‚úÖ Metal: ${metalType.metal_name} (${metalType.metal_key})`);\n  \n  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n  // 3.2. –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –†–ê–ó–ú–ï–†–ê –ò–ó –ù–ê–ó–í–ê–ù–ò–Ø\n  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n  \n  const extractedSize = extractSizeFromName(item.name, metalType.metal_key, metalType.category);\n  \n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // 3.2.1. –î–õ–Ø –õ–ò–°–¢–û–í: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–∞—Å–∫—Ä–æ—è (—à–∏—Ä–∏–Ω–∞ √ó –¥–ª–∏–Ω–∞)\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  if (metalType.category === 'sheet' || metalType.metal_key.includes('sheet')) {\n    const sheetCut = extractSheetCut(item.name, metalType.metal_key, metalType.category);\n    \n    if (sheetCut.width !== null) {\n      item.width = sheetCut.width;\n      item._widthFromParsing = true;\n      itemDebug.steps.push(`üìê Sheet width: ${sheetCut.width} –º`);\n    }\n    \n    if (sheetCut.lengthSheet !== null) {\n      item.length_sheet = sheetCut.lengthSheet;\n      item._lengthSheetFromParsing = true;\n      itemDebug.steps.push(`üìê Sheet length: ${sheetCut.lengthSheet} –º`);\n    }\n  }\n  \n  if (extractedSize) {\n    item.size = extractedSize;\n    itemDebug.steps.push(`üìè Extracted size: \"${extractedSize}\"`);\n  } else {\n    itemDebug.steps.push('‚ö†Ô∏è Size not extracted from name');\n  }\n  \n  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n  // 3.3. –î–û–ë–ê–í–õ–ï–ù–ò–ï –î–ï–§–û–õ–¢–ù–´–• –ó–ù–ê–ß–ï–ù–ò–ô\n  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n  \n  // –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –¥–ª–∏–Ω–∞\n  if (metalType.has_length && !item.length_per_piece && metalType.length_default) {\n    item.length_per_piece = metalType.length_default;\n    item._lengthIsDefault = true;\n  }\n  \n  // –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –º–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏\n  if (metalType.has_steel_grade && !item.steel_grade) {\n    item.steel_grade = '–°—Ç3';\n    item._steelGradeIsDefault = true;\n  }\n  \n  // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –ª–∏—Å—Ç–∞ (–¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–µ —Ä–∞—Å–ø–∞—Ä—Å–∏–ª–∏ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)\n  if (metalType.has_width && !item.width) {\n    item.width = 1.25;\n    item._widthIsDefault = true;\n  }\n  \n  if (metalType.has_length_sheet && !item.length_sheet) {\n    item.length_sheet = 2.5;\n    item._lengthSheetIsDefault = true;\n  }\n  \n  item._validation_passed = true;\n  debug.itemsValidated++;\n  validatedItems.push(item);\n}\n\n// ============================================================\n// 4. –†–ï–ó–£–õ–¨–¢–ê–¢\n// ============================================================\n\ndebug.itemsProcessed = parsedData.items.length;\nconsole.log(`‚úÖ Validation complete: ${debug.itemsValidated}/${debug.itemsProcessed} items validated`);\n\n// –§–æ—Ä–º–∞—Ç –¥–ª—è Respond: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π API response\nreturn [{\n  json: {\n    success: true,\n    error: null,\n    items: validatedItems,\n    _sourceType: inputData._sourceType,\n    _debug: debug\n  }\n}];"
      },
      "id": "fb03de02-fb61-4801-9fbe-9e994cd5b121",
      "name": "Validate Order Fields",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1232,
        -240
      ],
      "notes": "Validates metal types, extracts sizes, adds metal_key"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================\n// CODE: Validate Order Fields V3.4.2 (File Flow)\n// –ò–ó–ú–ï–ù–ï–ù–ò–Ø v3.4.2:\n// - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ extractSizeFromName –¥–ª—è –≥–Ω—É—Ç–æ–≥–æ —à–≤–µ–ª–ª–µ—Ä–∞ (AxBxC)\n// - –†–∞–∑–¥–µ–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –±–∞–ª–æ–∫ (–Ω–æ–º–µ—Ä) –∏ —à–≤–µ–ª–ª–µ—Ä–æ–≤ (—Ä–∞–∑–º–µ—Ä)\n// - –î–æ–±–∞–≤–ª–µ–Ω debug log –¥–ª—è –ø–æ–∏—Å–∫–∞ metal_key\n// ============================================================\n\nconst inputData = $input.first().json;\nconst parsedData = inputData.parsed_data;\n\n// === SUPABASE CONFIG ===\nconst SUPABASE_URL = 'https://neeejfmscjetprxjscto.supabase.co';\nconst SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lZWVqZm1zY2pldHByeGpzY3RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NTAyNTYsImV4cCI6MjA3NjMyNjI1Nn0.wHOtFj_pFGPEzDt2RMQr_zHfg10i9msvSi79tQCjnvU';\n\n// === DEBUG INFO ===\nconst debug = {\n  version: 'v3.4.2',\n  timestamp: new Date().toISOString(),\n  metalTypesLoaded: false,\n  metalTypesCount: 0,\n  errors: [],\n  warnings: [],\n  itemsProcessed: 0,\n  itemsValidated: 0\n};\n\nconsole.log('üöÄ Validate Order Fields v3.4.2 (File) started');\n\n// ============================================================\n// –°–¢–ê–ù–î–ê–†–¢–ù–´–ï –†–ê–°–ö–†–û–ò –õ–ò–°–¢–û–í (—à–∏—Ä–∏–Ω–∞ √ó –¥–ª–∏–Ω–∞ –≤ –º–º)\n// ============================================================\nconst STANDARD_SHEET_CUTS = [\n  { width: 1000, length: 2000 },\n  { width: 1250, length: 2500 },\n  { width: 1500, length: 3000 },\n  { width: 1500, length: 6000 },\n  { width: 2000, length: 6000 },\n  { width: 1, length: 2 },\n  { width: 1.25, length: 2.5 },\n  { width: 1.5, length: 3 },\n  { width: 1.5, length: 6 },\n];\n\n// === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===\nfunction normalizeSize(size) {\n  if (!size) return '';\n  return String(size).toLowerCase().replace(/[√óxX—Ö–•\\*]/g, '—Ö').replace(/,/g, '.').replace(/\\s+/g, '').replace(/–º–º|mm/gi, '').trim();\n}\n\nfunction extractNumbers(text) {\n  if (!text) return [];\n  const matches = text.match(/\\d+(?:[.,]\\d+)?/g);\n  if (!matches) return [];\n  return matches.map(m => parseFloat(m.replace(',', '.')));\n}\n\nfunction isSheetCut(num1, num2) {\n  const w = Math.min(num1, num2);\n  const l = Math.max(num1, num2);\n  for (const cut of STANDARD_SHEET_CUTS) {\n    if ((Math.abs(w - cut.width) < 1 && Math.abs(l - cut.length) < 1) || (Math.abs(w - cut.width) < 0.01 && Math.abs(l - cut.length) < 0.01)) {\n      return { width: cut.width >= 100 ? cut.width / 1000 : cut.width, length: cut.length >= 100 ? cut.length / 1000 : cut.length };\n    }\n  }\n  if (w >= 100 && l >= 100 && w <= 3000 && l <= 12000) return { width: w / 1000, length: l / 1000 };\n  if (w > 0.5 && w < 5 && l > 1 && l < 15) return { width: w, length: l };\n  return null;\n}\n\nfunction extractSheetParams(itemName) {\n  const numbers = extractNumbers(itemName);\n  if (numbers.length === 0) return { size: null, width: null, lengthSheet: null };\n  const cutMatch = itemName.match(/(\\d+(?:[.,]\\d+)?)\\s*[√óxX—Ö–•\\*]\\s*(\\d+(?:[.,]\\d+)?)/i);\n  let thickness = null, width = null, lengthSheet = null;\n  if (cutMatch) {\n    const cutNum1 = parseFloat(cutMatch[1].replace(',', '.'));\n    const cutNum2 = parseFloat(cutMatch[2].replace(',', '.'));\n    const sheetCut = isSheetCut(cutNum1, cutNum2);\n    if (sheetCut) {\n      width = sheetCut.width;\n      lengthSheet = sheetCut.length;\n      for (const num of numbers) {\n        if (Math.abs(num - cutNum1) > 0.01 && Math.abs(num - cutNum2) > 0.01 && num >= 0.3 && num <= 200) {\n          thickness = num;\n          break;\n        }\n      }\n    } else {\n      for (const num of numbers) { if (num >= 0.3 && num <= 200) { thickness = num; break; } }\n    }\n  } else {\n    const trailingThickness = itemName.match(/[- ]\\s*(\\d+(?:[.,]\\d+)?)\\s*$/);\n    if (trailingThickness) {\n      const t = parseFloat(trailingThickness[1].replace(',', '.'));\n      if (t >= 0.3 && t <= 200) {\n        thickness = t;\n      }\n    }\n    if (!thickness) {\n      for (const num of numbers) { if (num >= 0.3 && num <= 200) { thickness = num; break; } }\n    }\n  }\n  return { size: thickness !== null ? String(thickness) : null, width, lengthSheet };\n}\n\nfunction extractSizeFromName(itemName, metalKey, category) {\n  if (!itemName) return null;\n  const name = itemName.toLowerCase();\n  \n  // –õ–∏—Å—Ç—ã\n  if (category === 'sheet' || (metalKey && metalKey.includes('sheet'))) {\n    return extractSheetParams(itemName).size;\n  }\n  \n  // ============================================================\n  // v3.4.2: –†–ê–ó–î–ï–õ–ï–ù–ê –õ–û–ì–ò–ö–ê –ë–ê–õ–û–ö –ò –®–í–ï–õ–õ–ï–†–û–í\n  // ============================================================\n  \n  // –ë–ê–õ–ö–ò - –Ω–æ–º–µ—Ä —Ç–∏–ø–∞ \"40–®1\", \"30–ö1\"\n  if (metalKey && metalKey.includes('beam')) {\n    const beamMatch = itemName.match(/(\\d+)\\s*([–ê-–Ø–∞-—èA-Za-z]+\\d*)/);\n    if (beamMatch) return beamMatch[1] + beamMatch[2].toUpperCase();\n    const numMatch = itemName.match(/‚Ññ?\\s*(\\d+)/);\n    if (numMatch) return numMatch[1];\n  }\n  \n  // –®–í–ï–õ–õ–ï–†–´ –ì–ù–£–¢–´–ï - —Ä–∞–∑–º–µ—Ä AxBxC —Ç–∏–ø–∞ \"160x120x6\"\nif (metalKey && metalKey.includes('shveller') && metalKey !== 'shveller' && !metalKey.includes('_oc')) {\n    const sizeMatch = itemName.match(/(\\d+)\\s*[√óxX—Ö–•\\*]\\s*(\\d+)\\s*[√óxX—Ö–•\\*]\\s*(\\d+)/);\n    if (sizeMatch) {\n      return `${sizeMatch[1]}x${sizeMatch[2]}x${sizeMatch[3]}`;\n    }\n    // Fallback - –¥–≤–∞ —á–∏—Å–ª–∞ (–±–µ–∑ —Ç–æ–ª—â–∏–Ω—ã)\n    const size2Match = itemName.match(/(\\d+)\\s*[√óxX—Ö–•\\*]\\s*(\\d+)/);\n    if (size2Match) {\n      return `${size2Match[1]}x${size2Match[2]}`;\n    }\n  }\n  \n  // –®–í–ï–õ–õ–ï–†–´ –û–ë–´–ß–ù–´–ï - –Ω–æ–º–µ—Ä —Ç–∏–ø–∞ \"20\", \"30\"\n  if (metalKey && metalKey.includes('shveller') && !metalKey.includes('gnut')) {\n    const numMatch = itemName.match(/(\\d+)(?:[–£–ü–°]|[—É–ø—Å])?/);\n    if (numMatch) return numMatch[1];\n  }\n  \n  // –¢—Ä—É–±—ã –∏ –ø—Ä–æ—Ñ–∏–ª–∏ - —Ñ–æ—Ä–º–∞—Ç AxBxC\n  const pipe3Match = itemName.match(/(\\d+(?:[.,]\\d+)?)\\s*[√óxX—Ö–•\\*]\\s*(\\d+(?:[.,]\\d+)?)\\s*[√óxX—Ö–•\\*]\\s*(\\d+(?:[.,]\\d+)?)/i);\n  if (pipe3Match) return `${pipe3Match[1].replace(',', '.')}—Ö${pipe3Match[2].replace(',', '.')}—Ö${pipe3Match[3].replace(',', '.')}`;\n  \n  const pipe2Match = itemName.match(/(\\d+(?:[.,]\\d+)?)\\s*[√óxX—Ö–•\\*]\\s*(\\d+(?:[.,]\\d+)?)/i);\n  if (pipe2Match) {\n    const d = parseFloat(pipe2Match[1].replace(',', '.')), s = parseFloat(pipe2Match[2].replace(',', '.'));\n    if (metalKey && metalKey.includes('kvadr') && s < d && s <= 12) return `${d}—Ö${d}—Ö${s}`;\n    return `${d}—Ö${s}`;\n  }\n  \n  const diamMatch = itemName.match(/[‚åÄ√ò√∏]\\s*(\\d+(?:[.,]\\d+)?)/);\n  if (diamMatch) return diamMatch[1].replace(',', '.');\n  \n  const numbers = extractNumbers(itemName);\n  if (numbers.length >= 3) return `${numbers[0]}—Ö${numbers[1]}—Ö${numbers[2]}`;\n  if (numbers.length === 2) return `${numbers[0]}—Ö${numbers[1]}`;\n  if (numbers.length === 1) return String(numbers[0]);\n  \n  return null;\n}\n\n// ============================================================\n// –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: findMetalType v3.4.2\n// –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –ø—Ä—è–º—ã–µ –ø—Ä–∞–≤–∏–ª–∞ + aliases + –æ–±—Ä–∞—Ç–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É\n// ============================================================\nfunction findMetalType(itemName, metalTypes) {\n  if (!itemName || !metalTypes || metalTypes.length === 0) return null;\n  const nameLower = itemName.toLowerCase().trim();\n\n  // ============================================================\n  // ‚úÖ –ü–†–Ø–ú–´–ï –ü–†–ê–í–ò–õ–ê (–ü–ï–†–ï–î –ø–æ–∏—Å–∫–æ–º –ø–æ aliases)\n  // –†–∞–±–æ—Ç–∞—é—Ç –∏ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö (Vision) –∏ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö (Excel) –Ω–∞–∑–≤–∞–Ω–∏–π\n  // ============================================================\n\n  // 1. –õ–ò–°–¢–´ - –¥–ª–∏–Ω–Ω—ã–µ –∏ –∫–æ—Ä–æ—Ç–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è\n  if (nameLower.includes('–ø—Ä–æ–∫–∞—Ç –ª–∏—Å—Ç–æ–≤–æ–π') || nameLower.includes('–ª–∏—Å—Ç–æ–≤–æ–π –≥/–∫') || \n      nameLower.includes('–ª–∏—Å—Ç –≥/–∫') || nameLower.includes('–ª–∏—Å—Ç –≥–æ—Ä—è—á') ||\n      nameLower.match(/^–ª–∏—Å—Ç\\s+\\d/) ||\n      (nameLower.includes('–ª–∏—Å—Ç') && !nameLower.includes('–æ—Ü–∏–Ω–∫') && !nameLower.includes('—Ö/–∫') && !nameLower.includes('—Ö–æ–ª–æ–¥–Ω') && nameLower.match(/\\d/))) {\n    const found = metalTypes.find(m => m.metal_key === 'sheet_hot');\n    if (found) {\n      console.log(`üìã –ü—Ä—è–º–æ–µ –ø—Ä–∞–≤–∏–ª–æ (–ª–∏—Å—Ç –≥/–∫): \"${itemName}\" ‚Üí sheet_hot`);\n      return found;\n    }\n  }\n  \n  // –õ–∏—Å—Ç —Ö–æ–ª–æ–¥–Ω–æ–∫–∞—Ç–∞–Ω—ã–π\n  if (nameLower.includes('–ª–∏—Å—Ç —Ö/–∫') || nameLower.includes('–ª–∏—Å—Ç —Ö–æ–ª–æ–¥–Ω') || nameLower.includes('–ª–∏—Å—Ç–æ–≤–æ–π —Ö/–∫')) {\n    const found = metalTypes.find(m => m.metal_key === 'sheet_cold');\n    if (found) return found;\n  }\n  \n  // –õ–∏—Å—Ç –æ—Ü–∏–Ω–∫–æ–≤–∞–Ω–Ω—ã–π\n  if (nameLower.includes('–ª–∏—Å—Ç –æ—Ü–∏–Ω–∫') || nameLower.includes('–æ—Ü–∏–Ω–∫–æ–≤–∞–Ω–Ω—ã–π –ª–∏—Å—Ç')) {\n    const found = metalTypes.find(m => m.metal_key === 'sheet_galv');\n    if (found) return found;\n  }\n\n  // 2. –ü–†–û–§–ò–õ–¨–ù–´–ï –¢–†–£–ë–´ - —Ä–∞—Å–ø–æ–∑–Ω–∞—ë–º –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º AxBxC –∏–ª–∏ AxB\n  const isProfilePipe = nameLower.includes('—Å–≤–∞—Ä–Ω–æ–π –ø—Ä–æ—Ñ–∏–ª—å') || nameLower.includes('–ø—Ä–æ—Ñ–∏–ª—å —Å–≤–∞—Ä–Ω–æ–π') ||\n      nameLower.includes('‚ñ°') || nameLower.includes('–ø—Ä–æ—Ñ–∏–ª—å –∫–≤–∞–¥—Ä') || \n      nameLower.includes('—Ç—Ä—É–±–∞ –ø—Ä–æ—Ñ–∏–ª—å–Ω') ||\n      nameLower.includes('—Ç—Ä—É–±–∞ –∫–≤–∞–¥—Ä') ||\n      nameLower.includes('—Ç—Ä—É–±–∞ –ø—Ä—è–º–æ—É–≥') ||\n      nameLower.match(/^–ø—Ä–æ—Ñ–∏–ª—å\\s+\\d/) ||\n      nameLower.match(/^—Ç—Ä—É–±–∞\\s+\\d/);\n  \n  if (isProfilePipe) {\n    const sizeMatch = itemName.match(/(\\d+)\\s*[√óxX—Ö–•\\*]\\s*(\\d+)(?:\\s*[√óxX—Ö–•\\*]\\s*(\\d+))?/);\n    if (sizeMatch) {\n      const a = parseInt(sizeMatch[1]);\n      const b = parseInt(sizeMatch[2]);\n      const c = sizeMatch[3] ? parseInt(sizeMatch[3]) : null;\n\n      if (c !== null) {\n        if (a === b) {\n          const found = metalTypes.find(m => m.metal_key === 'tryba_es_kvadr');\n          if (found) {\n            console.log(`üìê –ü—Ä—è–º–æ–µ –ø—Ä–∞–≤–∏–ª–æ (–∫–≤–∞–¥—Ä. —Ç—Ä—É–±–∞): \"${itemName}\" ‚Üí tryba_es_kvadr (${a}x${b}x${c})`);\n            return found;\n          }\n        } else {\n          const found = metalTypes.find(m => m.metal_key === 'tryba_es_pr');\n          if (found) {\n            console.log(`üìê –ü—Ä—è–º–æ–µ –ø—Ä–∞–≤–∏–ª–æ (–ø—Ä—è–º–æ—É–≥. —Ç—Ä—É–±–∞): \"${itemName}\" ‚Üí tryba_es_pr (${a}x${b}x${c})`);\n            return found;\n          }\n        }\n      } else {\n        if (b <= 12) {\n          const found = metalTypes.find(m => m.metal_key === 'tryba_es_kvadr');\n          if (found) {\n            console.log(`üìê –ü—Ä—è–º–æ–µ –ø—Ä–∞–≤–∏–ª–æ (–∫–≤–∞–¥—Ä. —Ç—Ä—É–±–∞ —Å–æ–∫—Ä.): \"${itemName}\" ‚Üí tryba_es_kvadr (${a}x${b})`);\n            return found;\n          }\n        }\n      }\n    }\n    const found = metalTypes.find(m => m.metal_key === 'tryba_es_kvadr');\n    if (found) return found;\n  }\n\n  // 3. –ë–ê–õ–ö–ò –ò –î–í–£–¢–ê–í–†–´\n  if (nameLower.includes('–±–∞–ª–∫–∞') || nameLower.includes('–¥–≤—É—Ç–∞–≤—Ä')) {\n    const found = metalTypes.find(m => m.metal_key === 'beam');\n    if (found) return found;\n  }\n\n  // ============================================================\n  // 4. –®–í–ï–õ–õ–ï–†–´ (v3.4.2: —É–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ metal_key)\n  // ============================================================\n  if (nameLower.includes('—à–≤–µ–ª–ª–µ—Ä')) {\n    console.log(`üîç –ò—â–µ–º —à–≤–µ–ª–ª–µ—Ä: \"${itemName}\"`);\n    console.log(`   –≥–Ω—É—Ç: ${nameLower.includes('–≥–Ω—É—Ç')}, –æ—Ü: ${nameLower.includes('–æ—Ü')}`);\n    \n    // 4.1 –ì–Ω—É—Ç—ã–π –æ—Ü–∏–Ω–∫–æ–≤–∞–Ω–Ω—ã–π\n    if (nameLower.includes('–≥–Ω—É—Ç') && nameLower.includes('–æ—Ü')) {\n      // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∫–ª—é—á–µ–π\n      const keys = ['shveller_gnutiy_oc', 'shveller_gn_oc', 'shveller_gnutyy_oc'];\n      for (const key of keys) {\n        const found = metalTypes.find(m => m.metal_key === key);\n        if (found) {\n          console.log(`üìã –ü—Ä—è–º–æ–µ –ø—Ä–∞–≤–∏–ª–æ: \"${itemName}\" ‚Üí ${key}`);\n          return found;\n        }\n      }\n      console.log(`‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω –∫–ª—é—á –¥–ª—è –≥–Ω—É—Ç–æ–≥–æ –æ—Ü. —à–≤–µ–ª–ª–µ—Ä–∞`);\n    }\n    \n    // 4.2 –ì–Ω—É—Ç—ã–π\n    if (nameLower.includes('–≥–Ω—É—Ç')) {\n      // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∫–ª—é—á–µ–π\n      const keys = ['shveller_gnutiy', 'shveller_gn', 'shveller_gnutyy', 'shveller_gnutyi'];\n      for (const key of keys) {\n        const found = metalTypes.find(m => m.metal_key === key);\n        if (found) {\n          console.log(`üìã –ü—Ä—è–º–æ–µ –ø—Ä–∞–≤–∏–ª–æ: \"${itemName}\" ‚Üí ${key}`);\n          return found;\n        }\n      }\n      // Fallback: –∏—â–µ–º –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é\n      const foundPartial = metalTypes.find(m => m.metal_key.includes('shveller') && m.metal_key.includes('gn'));\n      if (foundPartial) {\n        console.log(`üìã –ù–∞–π–¥–µ–Ω –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é: \"${itemName}\" ‚Üí ${foundPartial.metal_key}`);\n        return foundPartial;\n      }\n      console.log(`‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω –∫–ª—é—á –¥–ª—è –≥–Ω—É—Ç–æ–≥–æ —à–≤–µ–ª–ª–µ—Ä–∞. –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–ª—é—á–∏ —Å–æ \"shveller\":`);\n      metalTypes.filter(m => m.metal_key.includes('shveller')).forEach(m => console.log(`   - ${m.metal_key}`));\n    }\n    \n    // 4.3 –û—Ü–∏–Ω–∫–æ–≤–∞–Ω–Ω—ã–π\n    if (nameLower.includes('–æ—Ü')) {\n      const found = metalTypes.find(m => m.metal_key === 'shveller_oc');\n      if (found) return found;\n    }\n    \n    // 4.4 –û–±—ã—á–Ω—ã–π —à–≤–µ–ª–ª–µ—Ä\n    const found = metalTypes.find(m => m.metal_key === 'shveller');\n    if (found) return found;\n  }\n\n  // 5. –£–ì–û–õ–ö–ò\n  if (nameLower.includes('—É–≥–æ–ª–æ–∫')) {\n    if (nameLower.includes('–æ—Ü')) {\n      const found = metalTypes.find(m => m.metal_key === 'ygolok_oc');\n      if (found) return found;\n    }\n    const found = metalTypes.find(m => m.metal_key === 'ygolok');\n    if (found) return found;\n  }\n\n  // 6. –ê–†–ú–ê–¢–£–†–ê\n  if (nameLower.includes('–∞—Ä–º–∞—Ç—É—Ä')) {\n    if (nameLower.includes('–∞500') || nameLower.includes('a500')) {\n      const found = metalTypes.find(m => m.metal_key === 'armature_a500c');\n      if (found) return found;\n    }\n    if (nameLower.includes('–∞3') || nameLower.includes('a3') || nameLower.includes('–∞-iii')) {\n      const found = metalTypes.find(m => m.metal_key === 'armature_a3');\n      if (found) return found;\n    }\n    if (nameLower.includes('–∞1') || nameLower.includes('a1') || nameLower.includes('–∞-i')) {\n      const found = metalTypes.find(m => m.metal_key === 'armature_a1');\n      if (found) return found;\n    }\n    const found = metalTypes.find(m => m.metal_key === 'armature_a3');\n    if (found) return found;\n  }\n\n  // 7. –ö–†–£–ì–õ–´–ï –¢–†–£–ë–´\n  if ((nameLower.includes('—Ç—Ä—É–±–∞') && !nameLower.match(/–ø—Ä–æ—Ñ–∏–ª—å|–∫–≤–∞–¥—Ä|–ø—Ä—è–º–æ—É–≥|\\d+\\s*[√óx—Ö]\\s*\\d+\\s*[√óx—Ö]\\s*\\d+/)) ||\n      nameLower.includes('—Ç—Ä—É–±–∞ –∫—Ä—É–≥') || nameLower.includes('—Ç—Ä—É–±–∞ –≤–æ–¥–æ–≥–∞–∑') || nameLower.includes('—Ç—Ä—É–±–∞ –≤–≥–ø')) {\n    const pipeMatch = itemName.match(/(\\d+)\\s*[√óxX—Ö–•\\*]\\s*(\\d+)(?:\\s*[√óxX—Ö–•\\*]\\s*(\\d+))?/);\n    if (!pipeMatch || !pipeMatch[3]) {\n      if (nameLower.includes('–±–µ—Å—à–æ–≤') || nameLower.includes('–≥–æ—Å—Ç 8732')) {\n        const found = metalTypes.find(m => m.metal_key === 'tryba_besh');\n        if (found) return found;\n      }\n      if (nameLower.includes('–æ—Ü')) {\n        const found = metalTypes.find(m => m.metal_key === 'tryba_vgp_oc');\n        if (found) return found;\n      }\n      const found = metalTypes.find(m => m.metal_key === 'tryba_vgp');\n      if (found) return found;\n    }\n  }\n\n  // 8. –ö–ê–¢–ê–ù–ö–ê\n  if (nameLower.includes('–∫–∞—Ç–∞–Ω–∫')) {\n    const found = metalTypes.find(m => m.metal_key === 'katanka');\n    if (found) return found;\n  }\n\n  // 9. –ö–†–£–ì (–ø—Ä–æ–∫–∞—Ç –∫—Ä—É–≥–ª—ã–π)\n  if (nameLower.includes('–∫—Ä—É–≥') && !nameLower.includes('—Ç—Ä—É–±–∞')) {\n    const found = metalTypes.find(m => m.metal_key === 'krug');\n    if (found) return found;\n  }\n\n  // ============================================================\n  // –ü–û–ò–°–ö –ü–û ALIASES (–µ—Å–ª–∏ –ø—Ä—è–º—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏)\n  // ============================================================\n  let bestMatch = null, bestScore = 0;\n  \n  for (const metalType of metalTypes) {\n    let aliases = metalType.aliases || [];\n    if (typeof aliases === 'string') {\n      try { aliases = JSON.parse(aliases.replace(/^\"\\{/, '[').replace(/\\}\"$/, ']').replace(/\\\\\"/g, '\"')); } catch (e) { try { aliases = JSON.parse(aliases); } catch (e2) { aliases = []; } }\n    }\n    \n    for (const alias of aliases) {\n      if (!alias) continue;\n      const aliasLower = alias.toLowerCase().trim();\n      \n      if (nameLower.includes(aliasLower)) {\n        const score = aliasLower.length * 2;\n        if (score > bestScore) { bestScore = score; bestMatch = metalType; }\n      }\n      \n      if (aliasLower.includes(nameLower) && nameLower.length >= 3) {\n        const score = nameLower.length;\n        if (score > bestScore) { bestScore = score; bestMatch = metalType; }\n      }\n    }\n  }\n  \n  if (bestMatch) {\n    console.log(`üîç –ù–∞–π–¥–µ–Ω–æ –ø–æ aliases: \"${itemName}\" ‚Üí ${bestMatch.metal_key}`);\n  }\n  \n  return bestMatch;\n}\n\n// === –ó–ê–ì–†–£–ó–ö–ê –°–ü–†–ê–í–û–ß–ù–ò–ö–û–í ===\nlet metalTypes = [];\ntry {\n  const typesResponse = await this.helpers.httpRequest({\n    method: 'GET',\n    url: `${SUPABASE_URL}/rest/v1/metal_types?select=*`,\n    headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type': 'application/json' },\n    json: true\n  });\n  if (Array.isArray(typesResponse)) {\n    metalTypes = typesResponse;\n    debug.metalTypesLoaded = true;\n    debug.metalTypesCount = metalTypes.length;\n    \n    // v3.4.2: –õ–æ–≥–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–ª—é—á–∏ —à–≤–µ–ª–ª–µ—Ä–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\n    const shvellerKeys = metalTypes.filter(m => m.metal_key.includes('shveller')).map(m => m.metal_key);\n    console.log(`üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–ª—é—á–∏ —à–≤–µ–ª–ª–µ—Ä–æ–≤: ${shvellerKeys.join(', ')}`);\n  }\n} catch (error) {\n  debug.errors.push(`metal_types load error: ${error.message}`);\n}\n\nif (metalTypes.length === 0) {\n  return [{ json: { success: false, error: 'CRITICAL: metal_types not loaded', items: [], _debug: debug } }];\n}\n\n// === –í–ê–õ–ò–î–ê–¶–ò–Ø ===\nconst validatedItems = [];\nif (!parsedData || !parsedData.items || !Array.isArray(parsedData.items)) {\n  return [{ json: { success: false, error: 'No items to validate', items: [], _debug: debug } }];\n}\n\nfor (const item of parsedData.items) {\n  debug.itemsProcessed++;\n  \n  item.index = item.index || debug.itemsProcessed;\n  item.raw_text = item.raw_text || item.name;\n  \n  let simplifiedName = item.name;\n  simplifiedName = simplifiedName.replace(/\\s*–ø–æ\\s*–ì–û–°–¢\\s*[\\d\\-]+/gi, '');\n  simplifiedName = simplifiedName.replace(/\\s*–ì–û–°–¢\\s*[\\d\\-]+/gi, '');\n  simplifiedName = simplifiedName.replace(/\\s*-\\s*C\\d+[-.]\\d+/gi, '');\n  simplifiedName = simplifiedName.replace(/\\s+/g, ' ').trim();\n  item.name = simplifiedName;\n  \n  const metalType = findMetalType(item.raw_text, metalTypes);\n  \n  if (!metalType) {\n    validatedItems.push({ ...item, metal_key: null, metal_name: item.name, _validation_passed: false, _validation_error: '–¢–∏–ø –º–µ—Ç–∞–ª–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω' });\n    debug.warnings.push(`Metal type not found for: \"${item.name}\"`);\n    continue;\n  }\n  \n  item.metal_key = metalType.metal_key;\n  item.metal_name = metalType.metal_name;\n  item._metalKey = metalType.metal_key;\n  item._metalName = metalType.metal_name;\n  item._category = metalType.category;\n  \n  const extractedSize = extractSizeFromName(item.raw_text, metalType.metal_key, metalType.category);\n  if (extractedSize) item.size = extractedSize;\n  \n  if (metalType.category === 'sheet' || metalType.metal_key.includes('sheet')) {\n    const sheetParams = extractSheetParams(item.raw_text);\n    if (sheetParams.width) { item.width = sheetParams.width; item._widthFromParsing = true; }\n    if (sheetParams.lengthSheet) { item.length_sheet = sheetParams.lengthSheet; item._lengthSheetFromParsing = true; }\n  }\n  \n  if (metalType.has_length && !item.length_per_piece && metalType.length_default) {\n    item.length_per_piece = metalType.length_default;\n    item._lengthIsDefault = true;\n  }\n  if (metalType.has_steel_grade && !item.steel_grade) {\n    item.steel_grade = '–°—Ç3';\n    item._steelGradeIsDefault = true;\n  }\n  if (metalType.has_width && !item.width) { item.width = 1.25; item._widthIsDefault = true; }\n  if (metalType.has_length_sheet && !item.length_sheet) { item.length_sheet = 2.5; item._lengthSheetIsDefault = true; }\n  \n  item._validation_passed = true;\n  debug.itemsValidated++;\n  validatedItems.push(item);\n}\n\nconsole.log(`‚úÖ Validation complete: ${debug.itemsValidated}/${debug.itemsProcessed} items validated`);\n\nreturn [{ json: { success: true, error: null, items: validatedItems, _sourceType: inputData._sourceType, _debug: debug } }];"
      },
      "id": "dca988c7-5a4a-44fa-8934-bceb037fe5fd",
      "name": "Validate Order Fields (File)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -576,
        -800
      ],
      "notes": "Validates metal types, extracts sizes, adds metal_key (File flow)"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "7cb1d902-353d-470f-9402-a879ea8ecc4a",
      "name": "Respond: Parse",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1024,
        -240
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "ca048a1b-5e01-43bb-81cd-ea26d659efa4",
      "name": "Respond: Parse File",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -352,
        -800
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "calc-calculate",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "f2875289-d6af-4c8e-b324-00a58d408766",
      "name": "Webhook: Calculate",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2128,
        80
      ],
      "webhookId": "calc-calculate-001",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "https://raw.githubusercontent.com/lamblackout/metal-calculator/main/docs/database/metals.json",
        "options": {}
      },
      "id": "7b1cab58-e127-4703-8ce0-c347065fef8c",
      "name": "HTTP: Load Metals Database",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1904,
        80
      ]
    },
    {
      "parameters": {
        "jsCode": "const metalsDatabase = $('HTTP: Load Metals Database').first().json.metals;\nconst webhookData = $('Webhook: Calculate').first().json;\nconst items = webhookData.body.items || [];\n\nconst DENSITY = 7.85;\n\nfunction normalizeSize(size) {\n  if (!size) return '';\n  return String(size).replace(/[xX√ó*]/g, '—Ö').replace(/,/g, '.').trim();\n}\n\nfunction calculateWeightPerMeter(metalKey, size) {\n  const normalized = normalizeSize(size);\n  const parts = normalized.split('—Ö').map(p => parseFloat(p));\n  \n  if (metalKey?.includes('tryba') && parts.length === 3) {\n    const [a, b, t] = parts;\n    return 2 * (a + b - 2 * t) * t * DENSITY / 1000;\n  }\n  if (metalKey?.includes('tryba') && parts.length === 2) {\n    const [d, t] = parts;\n    return (d - t) * t * Math.PI * DENSITY / 1000;\n  }\n  if ((metalKey?.includes('armature') || metalKey?.includes('circle')) && parts.length === 1) {\n    return Math.PI * parts[0] * parts[0] / 4 * DENSITY / 1000;\n  }\n  if (metalKey?.includes('sheet') && parts.length === 1) {\n    return parts[0] * DENSITY;\n  }\n  return null;\n}\n\nconst results = [];\nlet totalWeight = 0;\nlet totalLength = 0;\nlet successCount = 0;\n\nfor (const item of items) {\n  const result = {\n    index: item.index,\n    metal_name: item.metal_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',\n    size: item.size || '-',\n    weight: null,\n    length: null,\n    pieces: null,\n    error: null\n  };\n  \n  const weightPerMeter = calculateWeightPerMeter(item.metal_key, item.size);\n  \n  if (!weightPerMeter) {\n    result.error = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–µ—Å';\n    results.push(result);\n    continue;\n  }\n  \n  const quantity = parseFloat(item.quantity) || 0;\n  const unit = (item.unit || '').toLowerCase();\n  const lengthPiece = parseFloat(item.length_per_piece) || 6;\n  const isSheet = item.metal_key?.includes('sheet');\n  \n  try {\n    if (isSheet) {\n      const width = parseFloat(item.width) || 1.25;\n      const lengthSheet = parseFloat(item.length_sheet) || 2.5;\n      const area = width * lengthSheet;\n      const weightPerSheet = weightPerMeter * area / 1000;\n      \n      if (unit.includes('—Ç')) {\n        result.weight = quantity;\n        result.pieces = Math.ceil(quantity / weightPerSheet);\n      } else if (unit.includes('—à—Ç')) {\n        result.pieces = quantity;\n        result.weight = quantity * weightPerSheet;\n      } else if (unit.includes('¬≤')) {\n        result.weight = quantity * weightPerMeter / 1000;\n        result.pieces = Math.ceil(quantity / area);\n      }\n      result.length = (result.pieces || 0) * lengthSheet;\n    } else {\n      if (unit.includes('—Ç')) {\n        result.weight = quantity;\n        result.length = (quantity * 1000) / weightPerMeter;\n        result.pieces = Math.ceil(result.length / lengthPiece);\n      } else if (unit.includes('–º') && !unit.includes('¬≤')) {\n        result.length = quantity;\n        result.weight = (quantity * weightPerMeter) / 1000;\n        result.pieces = Math.ceil(quantity / lengthPiece);\n      } else if (unit.includes('—à—Ç')) {\n        result.pieces = quantity;\n        result.length = quantity * lengthPiece;\n        result.weight = (result.length * weightPerMeter) / 1000;\n      }\n    }\n    \n    if (result.weight !== null) {\n      result.weight = Math.round(result.weight * 1000) / 1000;\n      result.length = Math.round(result.length * 100) / 100;\n      totalWeight += result.weight;\n      totalLength += result.length;\n      successCount++;\n    }\n  } catch (e) {\n    result.error = e.message;\n  }\n  \n  results.push(result);\n}\n\nreturn [{\n  json: {\n    success: true,\n    items: results,\n    totals: {\n      weight: Math.round(totalWeight * 1000) / 1000,\n      length: Math.round(totalLength * 100) / 100,\n      items_total: items.length,\n      items_calculated: successCount\n    }\n  }\n}];"
      },
      "id": "218b246e-e9d5-43d5-b7bd-3c0467447a4e",
      "name": "Code: Calculate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1680,
        80
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "039e59a9-7429-4508-a007-481cd1ca15c7",
      "name": "Respond: Calculate",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1456,
        80
      ]
    },
    {
      "parameters": {
        "path": "calc-refs",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "83198640-ea28-43a3-810d-484f859b69b2",
      "name": "Webhook: Get Refs",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2128,
        384
      ],
      "webhookId": "calc-refs-001",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "metal_types",
        "returnAll": true,
        "filterType": "none"
      },
      "id": "067fd6c4-cdfe-4393-8d66-edd78bb4c778",
      "name": "Supabase: Get Metal Types",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1904,
        384
      ],
      "credentials": {
        "supabaseApi": {
          "id": "zV2DqqzhilTxlmiG",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const types = $input.all().map(item => item.json);\n\nreturn [{\n  json: {\n    success: true,\n    metal_types: types.map(t => ({\n      id: t.id,\n      metal_key: t.metal_key,\n      metal_name: t.metal_name,\n      category: t.category\n    })),\n    count: types.length\n  }\n}];"
      },
      "id": "c0de2afc-9d7b-4cbf-a5b0-e03bd2e85781",
      "name": "Code: Format Refs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1680,
        384
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "f4db5315-017f-4c25-a12e-8af56953a1ce",
      "name": "Respond: Refs",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1456,
        384
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: 'Unsupported file type: ' + $json._fileType + ' (mimeType: ' + $json._mimeType + ', fileName: ' + $json._fileName + ')', items: [] }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "54c23c89-6a7e-4382-b88a-bbdbd75358d7",
      "name": "Respond: Unsupported File",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1456,
        -432
      ]
    },
    {
      "parameters": {
        "content": "## üìã Web Calculator API v4\n\n**–î–æ–±–∞–≤–ª–µ–Ω–æ:**\n- ‚úÖ Validate Order Fields - –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç metal_key –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é\n- ‚úÖ –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ä–∞–∑–º–µ—Ä—ã –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏–π\n- ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è\n\n**Endpoints:**\n- POST /calc-parse - –ø–∞—Ä—Å–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞\n- POST /calc-parse-file - –ø–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–æ–≤ (PDF/XLSX/Image)\n- POST /calc-calculate - —Ä–∞—Å—á—ë—Ç –≤–µ—Å–∞\n- GET /calc-refs - —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏",
        "height": 320,
        "width": 496
      },
      "id": "431c45d0-7bb7-492d-8f41-e554f945aa1e",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2704,
        -608
      ]
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "CHATGPT-4O-LATEST"
        },
        "text": "–†–∞—Å–ø–æ–∑–Ω–∞–π –∑–∞—è–≤–∫—É –Ω–∞ –º–µ—Ç–∞–ª–ª–æ–ø—Ä–æ–∫–∞—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.\n\n–ü–†–ê–í–ò–õ–ê –ß–¢–ï–ù–ò–Ø –¢–ê–ë–õ–ò–¶:\n1. –ß–∏—Ç–∞–π –í–°–ï –∫–æ–ª–æ–Ω–∫–∏ - —Ä–∞–∑–º–µ—Ä/—Ç–æ–ª—â–∏–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–æ–ª–æ–Ω–∫–µ –æ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è\n2. –û–±—ä–µ–¥–∏–Ω—è–π –Ω–∞–∑–≤–∞–Ω–∏–µ + —Ä–∞–∑–º–µ—Ä –≤ –ø–æ–ª–µ \"name\"\n3. –°–∏–º–≤–æ–ª—ã: ‚ñ° = —Ç—Ä—É–±–∞ –∫–≤–∞–¥—Ä–∞—Ç–Ω–∞—è, ‚à† = —É–≥–æ–ª–æ–∫, -t = —Ç–æ–ª—â–∏–Ω–∞ –ª–∏—Å—Ç–∞\n4. –í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û —Å–º–æ—Ç—Ä–∏ –Ω–∞ –ó–ê–ì–û–õ–û–í–ö–ò –∫–æ–ª–æ–Ω–æ–∫!\n\n–ü–†–ï–û–ë–†–ê–ó–û–í–ê–ù–ò–ï –í name:\n- \"–ü—Ä–æ–∫–∞—Ç –ª–∏—Å—Ç–æ–≤–æ–π\" + \"-t18\" ‚Üí \"–õ–∏—Å—Ç –≥/–∫ 18\"\n- \"‚ñ°80x80x5\" ‚Üí \"–¢—Ä—É–±–∞ –∫–≤–∞–¥—Ä. 80x80x5\" (–µ—Å–ª–∏ A=B)\n- \"‚ñ°180x140x6\" ‚Üí \"–¢—Ä—É–±–∞ –ø—Ä—è–º–æ—É–≥. 180x140x6\" (–µ—Å–ª–∏ A‚â†B)\n- \"–®–≤–µ–ª–ª–µ—Ä 160x120x6\" ‚Üí \"–®–≤–µ–ª–ª–µ—Ä –≥–Ω—É—Ç—ã–π 160x120x6\"\n- \"‚à†125x125x8\" ‚Üí \"–£–≥–æ–ª–æ–∫ 125x125x8\"\n- –ß–∏—Ç–∞–π —Ä–∞–∑–º–µ—Ä—ã –¢–û–ß–ù–û –∫–∞–∫ –Ω–∞–ø–∏—Å–∞–Ω–æ!\n\n‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –ö–û–õ–û–ù–û–ö:\n- –ö–æ–ª–æ–Ω–∫–∞ \"–ú/–ø\" –∏–ª–∏ \"–º.–ø.\" = –ú–ï–¢–†–´ –ø–æ–≥–æ–Ω–Ω—ã–µ ‚Üí quantity + unit=\"–º\"\n- –ö–æ–ª–æ–Ω–∫–∞ \"–®—Ç.\" = –®–¢–£–ö–ò ‚Üí pieces (—á–∏—Å–ª–æ) + unit=\"—à—Ç\"\n- –ö–æ–ª–æ–Ω–∫–∞ —Å —Ç–æ–Ω–Ω–∞–º–∏ (—Ç, —Ç–Ω) ‚Üí quantity + unit=\"—Ç–Ω\"\n- –î–ª—è –ë–ê–õ–û–ö, –î–í–£–¢–ê–í–†–û–í, –®–í–ï–õ–õ–ï–†–û–í, –¢–†–£–ë –æ–±—ã—á–Ω–æ —É–∫–∞–∑—ã–≤–∞—é—Ç –ú–ï–¢–†–´ (–ú/–ø), –Ω–µ —Ç–æ–Ω–Ω—ã!\n- –î–ª—è –õ–ò–°–¢–û–í –æ–±—ã—á–Ω–æ —É–∫–∞–∑—ã–≤–∞—é—Ç –®–¢–£–ö–ò (–®—Ç.)\n- –ù–ï –ü–ï–†–ï–°–ß–ò–¢–´–í–ê–ô —á–∏—Å–ª–∞! –ë–µ—Ä–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –ö–ê–ö –ï–°–¢–¨\n\n‚ö†Ô∏è –û–°–û–ë–´–ï –ü–†–ê–í–ò–õ–ê –î–õ–Ø –õ–ò–°–¢–û–í:\n- –î–ª—è –ø–æ–∑–∏—Ü–∏–π \"–õ–∏—Å—Ç\" –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—â–∏ –∫–æ–ª–æ–Ω–∫—É \"–®—Ç.\" –≤ —Ç–∞–±–ª–∏—Ü–µ\n- –ï—Å–ª–∏ –≤ –∫–æ–ª–æ–Ω–∫–µ \"–®—Ç.\" —Å—Ç–æ–∏—Ç —á–∏—Å–ª–æ (1, 2, 3...) ‚Üí pieces = —ç—Ç–æ —á–∏—Å–ª–æ\n- –ï—Å–ª–∏ –Ω–∞–ø–∏—Å–∞–Ω–æ \"–ø–æ–ª.–ª–∏—Å—Ç–∞\" –∏–ª–∏ \"0.5\" ‚Üí pieces = 0.5\n- –ï—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ \"–®—Ç.\" –ø—É—Å—Ç–∞—è –¥–ª—è –ª–∏—Å—Ç–∞ ‚Üí pieces = null\n- –ù–ï –í–´–ß–ò–°–õ–Ø–ô —à—Ç—É–∫–∏ —Å–∞–º –∏–∑ –≤–µ—Å–∞ –∏–ª–∏ –º–µ—Ç—Ä–æ–≤!\n\n–ü–†–ê–í–ò–õ–ê –ü–ê–†–°–ò–ù–ì–ê:\n- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –ú–ï–¢–†–ê–• (–º, –º.–ø., –ú/–ø, –ø–æ–≥.–º) ‚Üí quantity + unit=\"–º\"\n- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –¢–û–ù–ù–ê–• (—Ç, —Ç–Ω) ‚Üí quantity + unit=\"—Ç–Ω\"\n- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –®–¢–£–ö (—à—Ç, –®—Ç.) ‚Üí pieces (—á–∏—Å–ª–æ) + unit=\"—à—Ç\"\n- –î–ª–∏–Ω–∞ 1 —à—Ç—É–∫–∏ (–º–µ—Ç—Ä—ã) ‚Üí length_per_piece\n- –®–∏—Ä–∏–Ω–∞ –ª–∏—Å—Ç–∞ ‚Üí width (–≤ –º–µ—Ç—Ä–∞—Ö)\n- –ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏ (—Å—Ç3, 09–ì2–°, –°345) ‚Üí steel_grade\n- –ì–û–°–¢ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω ‚Üí gost\n- –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ ‚Üí null\n\nJSON —Ñ–æ—Ä–º–∞—Ç:\n{\"items\":[{\"name\":\"–Ω–∞–∑–≤–∞–Ω–∏–µ —Å —Ä–∞–∑–º–µ—Ä–æ–º\",\"quantity\":—á–∏—Å–ª–æ,\"unit\":\"–º –∏–ª–∏ —Ç–Ω –∏–ª–∏ —à—Ç\",\"gost\":\"–ì–û–°–¢...\",\"pieces\":null,\"length_per_piece\":null,\"width\":null,\"steel_grade\":\"–º–∞—Ä–∫–∞\"}],\"customer_name\":null,\"delivery_address\":null,\"customer_inn\":null,\"contact_person\":null,\"contact_phone\":null,\"additional_notes\":null}\n\n–°–æ–∫—Ä–∞—â–µ–Ω–∏—è: —Ö/–∫=—Ö–æ–ª–æ–¥–Ω–æ–∫–∞—Ç–∞–Ω—ã–π, –≥/–∫=–≥–æ—Ä—è—á–µ–∫–∞—Ç–∞–Ω—ã–π, —ç/—Å=—ç–ª–µ–∫—Ç—Ä–æ—Å–≤–∞—Ä–Ω–∞—è, –æ—Ü=–æ—Ü–∏–Ω–∫–æ–≤–∞–Ω–Ω–∞—è\n\n–ü–†–ò–ú–ï–†–´:\n\"–î–≤—É—Ç–∞–≤—Ä 30–ë2, –ú/–ø: 204\" ‚Üí {\"name\":\"–î–≤—É—Ç–∞–≤—Ä 30–ë2\",\"quantity\":204,\"unit\":\"–º\"}\n\"–ë–∞–ª–∫–∞ 20 - 15—à—Ç –ø–æ 12–º\" ‚Üí {\"name\":\"–ë–∞–ª–∫–∞ 20\",\"pieces\":15,\"length_per_piece\":12,\"unit\":\"—à—Ç\"}\n\"–õ–∏—Å—Ç 8, –®—Ç.: 1\" ‚Üí {\"name\":\"–õ–∏—Å—Ç –≥/–∫ 8\",\"pieces\":1,\"unit\":\"—à—Ç\"}\n\"–õ–∏—Å—Ç 30, –®—Ç.: –ø–æ–ª.–ª–∏—Å—Ç–∞\" ‚Üí {\"name\":\"–õ–∏—Å—Ç –≥/–∫ 30\",\"pieces\":0.5,\"unit\":\"—à—Ç\"}\n\"–õ–∏—Å—Ç 8–º–º 1.5—Ö6–º\" ‚Üí {\"name\":\"–õ–∏—Å—Ç –≥/–∫ 8\",\"width\":1.5,\"length_per_piece\":6}\n\n–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π JSON.",
        "inputType": "base64",
        "binaryPropertyName": "file",
        "options": {
          "maxTokens": 16000
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2,
      "position": [
        -1456,
        -608
      ],
      "id": "10da4f4a-4afe-4b8a-aec6-61358bbf2e78",
      "name": "Analyze image",
      "credentials": {
        "openAiApi": {
          "id": "ZNb2GdFIiM7vrhFZ",
          "name": "OpenAi account"
        }
      }
    }
  ],
  "pinData": {
    "Webhook: Parse File": [
      {
        "json": {
          "headers": {
            "host": "primary-production-4e88.up.railway.app",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36",
            "content-length": "10268",
            "accept": "*/*",
            "accept-encoding": "gzip, deflate, br, zstd",
            "accept-language": "ru,en;q=0.9",
            "content-type": "multipart/form-data; boundary=----WebKitFormBoundaryAAQ0ORIBmYcKB1FA",
            "origin": "https://lamblackout.github.io",
            "priority": "u=1, i",
            "referer": "https://lamblackout.github.io/",
            "sec-ch-ua": "\"Google Chrome\";v=\"141\", \"Not?A_Brand\";v=\"8\", \"Chromium\";v=\"141\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"Windows\"",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "cross-site",
            "x-forwarded-for": "154.81.198.52",
            "x-forwarded-host": "primary-production-4e88.up.railway.app",
            "x-forwarded-proto": "https",
            "x-railway-edge": "railway/europe-west4-drams3a",
            "x-railway-request-id": "FAjGlMw9TJajfEe55nX1uw",
            "x-real-ip": "154.81.198.52",
            "x-request-start": "1766739760680"
          },
          "params": {},
          "query": {},
          "body": {},
          "webhookUrl": "https://primary-production-4e88.up.railway.app/webhook/calc-parse-file",
          "executionMode": "production"
        },
        "binary": {
          "file": {
            "mimeType": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            "fileExtension": "xlsx",
            "data": "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",
            "fileName": "–ó–∞—è–≤–∫–∞ –æ—Ç –ñ–ë–ò –∑–∞–ª–∏—Ç–æ –∂–µ–ª—Ç—ã–º - –Ω–∞—à–µ.xlsx",
            "fileSize": "9.97 kB"
          }
        }
      }
    ]
  },
  "connections": {
    "Webhook: Parse": {
      "main": [
        [
          {
            "node": "Set: Text Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set: Text Content": {
      "main": [
        [
          {
            "node": "OpenAI: Parse Order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI: Parse Order": {
      "main": [
        [
          {
            "node": "Code: Process Parse Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code: Process Parse Result": {
      "main": [
        [
          {
            "node": "Validate Order Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook: Parse File": {
      "main": [
        [
          {
            "node": "Code: Detect File Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code: Detect File Type": {
      "main": [
        [
          {
            "node": "Switch: File Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch: File Type": {
      "main": [
        [
          {
            "node": "Extract: PDF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract: XLSX",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond: Unsupported File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract: PDF": {
      "main": [
        [
          {
            "node": "Code: Combine Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract: XLSX": {
      "main": [
        [
          {
            "node": "Code: Combine Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code: Combine Text": {
      "main": [
        [
          {
            "node": "OpenAI: Parse File Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI: Parse File Content": {
      "main": [
        [
          {
            "node": "Code: Process File Parse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code: Process File Parse": {
      "main": [
        [
          {
            "node": "Validate Order Fields (File)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Order Fields": {
      "main": [
        [
          {
            "node": "Respond: Parse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Order Fields (File)": {
      "main": [
        [
          {
            "node": "Respond: Parse File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook: Calculate": {
      "main": [
        [
          {
            "node": "HTTP: Load Metals Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP: Load Metals Database": {
      "main": [
        [
          {
            "node": "Code: Calculate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code: Calculate": {
      "main": [
        [
          {
            "node": "Respond: Calculate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook: Get Refs": {
      "main": [
        [
          {
            "node": "Supabase: Get Metal Types",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase: Get Metal Types": {
      "main": [
        [
          {
            "node": "Code: Format Refs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code: Format Refs": {
      "main": [
        [
          {
            "node": "Respond: Refs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze image": {
      "main": [
        [
          {
            "node": "Code: Combine Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "fff12bd7-eb77-4530-96cd-9f53d9a340e6",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "e053b61b8b3bdff69a323dc7c626e5598b37038308beed9b02f6dd362745fcdd"
  },
  "id": "XHJStACtRzHma7bi",
  "tags": []
}
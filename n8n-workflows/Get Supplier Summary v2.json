{
  "name": "Get Supplier Summary v2",
  "nodes": [
    {
      "parameters": {
        "path": "get-supplier-summary",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "1be0d8ce-a89c-40b1-bb5d-973fe274217f",
      "name": "Webhook: Get Summary",
      "type": "n8n-nodes-base.webhook",
      "position": [
        -1296,
        176
      ],
      "typeVersion": 2,
      "webhookId": "get-supplier-summary-v2"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "supplier_requests",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "request_id",
              "condition": "eq",
              "keyValue": "={{ $json.query.request_id }}"
            }
          ]
        }
      },
      "id": "dc9bf81d-8a34-4e91-be58-d4ec3cbb658f",
      "name": "Supabase: Get Request",
      "type": "n8n-nodes-base.supabase",
      "position": [
        -1088,
        176
      ],
      "typeVersion": 1,
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "zV2DqqzhilTxlmiG",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–π–¥–µ–Ω–∞ –ª–∏ –∑–∞—è–≤–∫–∞\nconst data = $input.first().json;\n\nif (!data || !data.request_id) {\n  return [{\n    json: {\n      exists: false,\n      error: 'request_not_found',\n      message: '–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'\n    }\n  }];\n}\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—à–ª–æ –ª–∏ –≤—Ä–µ–º—è —Å–±–æ—Ä–∞\nconst collectAt = new Date(data.collect_at);\nconst now = new Date();\n\nconst isReady = now >= collectAt;\nconst remainingMs = collectAt - now;\nconst remainingMinutes = Math.max(0, Math.ceil(remainingMs / 60000));\n\nconsole.log(`üìã –ó–∞—è–≤–∫–∞: ${data.request_id}`);\nconsole.log(`‚è∞ –í—Ä–µ–º—è —Å–±–æ—Ä–∞: ${collectAt.toISOString()}`);\nconsole.log(`‚è∞ –°–µ–π—á–∞—Å: ${now.toISOString()}`);\nconsole.log(`‚úÖ –ì–æ—Ç–æ–≤–∞: ${isReady}`);\n\nreturn [{\n  json: {\n    exists: true,\n    is_ready: isReady,\n    remaining_minutes: remainingMinutes,\n    ...data\n  }\n}];"
      },
      "id": "cadadd1b-b6c9-474d-b9b7-3646bd2b7c91",
      "name": "Code: Check Request",
      "type": "n8n-nodes-base.code",
      "position": [
        -864,
        176
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "exists-check",
              "leftValue": "={{ $json.exists }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "1fa78280-727e-4a7f-9866-4da0c268dd48",
      "name": "IF: Request Exists?",
      "type": "n8n-nodes-base.if",
      "position": [
        -640,
        176
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": false,\n  \"error\": \"request_not_found\",\n  \"message\": \"–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\"\n}",
        "options": {
          "responseCode": "404",
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "4f1a376a-ff1c-4547-a7ed-26165a8f4a1f",
      "name": "Respond: Not Found",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        -416,
        384
      ],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ready-check",
              "leftValue": "={{ $json.is_ready }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "4096e097-eebd-4e04-a57d-df850f9e1b05",
      "name": "IF: Time Passed?",
      "type": "n8n-nodes-base.if",
      "position": [
        -416,
        176
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": false,\n  \"error\": \"not_ready\",\n  \"message\": \"–°–±–æ—Ä –æ—Ç–≤–µ—Ç–æ–≤ –µ—â—ë –∏–¥—ë—Ç. –û—Å—Ç–∞–ª–æ—Å—å ~{{ $json.remaining_minutes }} –º–∏–Ω.\",\n  \"remaining_minutes\": {{ $json.remaining_minutes }},\n  \"collect_at\": \"{{ $json.collect_at }}\"\n}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "b357f362-a439-4cd4-ab13-148ecd56b972",
      "name": "Respond: Not Ready",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        -208,
        384
      ],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "supplier_responses",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "request_id",
              "condition": "eq",
              "keyValue": "={{ $json.request_id }}"
            }
          ]
        }
      },
      "id": "5289725f-3fa1-4966-8d93-7490c97adc4a",
      "name": "Supabase: Get Responses",
      "type": "n8n-nodes-base.supabase",
      "position": [
        -208,
        176
      ],
      "typeVersion": 1,
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "zV2DqqzhilTxlmiG",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –§–æ—Ä–º–∏—Ä—É–µ–º —Å–≤–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É\nconst responses = $input.all();\nconst requestData = $('Code: Check Request').first().json;\nconst requestId = requestData.request_id;\n\n// –ü–∞—Ä—Å–∏–º items –∏–∑ JSON —Å—Ç—Ä–æ–∫–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ\nlet originalItems = requestData.items;\nif (typeof originalItems === 'string') {\n  try {\n    originalItems = JSON.parse(originalItems);\n  } catch (e) {\n    originalItems = [];\n  }\n}\nif (!Array.isArray(originalItems)) {\n  originalItems = [];\n}\n\nconsole.log(`üìä –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤–æ–¥–∫–∏ –¥–ª—è ${requestId}`);\nconsole.log(`üì¶ –ü–æ–∑–∏—Ü–∏–π –≤ –∑–∞–∫–∞–∑–µ: ${originalItems.length}`);\nconsole.log(`üì® –û—Ç–≤–µ—Ç–æ–≤ –≤ –±–∞–∑–µ: ${responses.length}`);\n\n// –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–≤–µ—Ç–∏–ª–∏ —Å —Ü–µ–Ω–∞–º–∏\nconst suppliers = [];\nconst supplierPrices = {};\nconst supplierNotes = {};\n\nfor (const resp of responses) {\n  const data = resp.json;\n  \n  if (!data || !data.request_id) continue;\n  \n  let prices = data.prices;\n  let notes = data.notes;\n  \n  if (typeof prices === 'string') {\n    try { prices = JSON.parse(prices); } catch (e) { prices = {}; }\n  }\n  if (typeof notes === 'string') {\n    try { notes = JSON.parse(notes); } catch (e) { notes = {}; }\n  }\n  \n  if (prices && Object.keys(prices).length > 0) {\n    let email = data.supplier_email || '';\n    const emailMatch = email.match(/<([^>]+)>/);\n    if (emailMatch) {\n      email = emailMatch[1];\n    }\n    email = email.toLowerCase().trim();\n    \n    let name = data.supplier_name || email;\n    if (name.includes('<')) {\n      name = name.split('<')[0].trim();\n    }\n    if (!name || name.length < 2) {\n      name = email.split('@')[0];\n    }\n    \n    suppliers.push({ email, name });\n    supplierPrices[email] = prices;\n    supplierNotes[email] = notes || {};\n    \n    console.log(`‚úÖ –ü–æ—Å—Ç–∞–≤—â–∏–∫: ${name} (${email}) - ${Object.keys(prices).length} —Ü–µ–Ω`);\n  }\n}\n\nconsole.log(`‚úÖ –í—Å–µ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ —Å —Ü–µ–Ω–∞–º–∏: ${suppliers.length}`);\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã\nconst summaryRows = [];\nlet totalBestPrice = 0;\n\nfor (let i = 0; i < originalItems.length; i++) {\n  const item = originalItems[i];\n  const itemIndex = String(i + 1);\n  \n  const row = {\n    '‚Ññ': itemIndex,\n    '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ': item.metal_type || item.metal_name || item.name || '',\n    '–†–∞–∑–º–µ—Ä': item.size || '',\n    '–ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏': item.steel_grade || item.grade || '',\n    '–í–µ—Å, —Ç': item.weight || 0\n  };\n  \n  let bestPrice = null;\n  \n  for (const supplier of suppliers) {\n    const prices = supplierPrices[supplier.email] || {};\n    const notes = supplierNotes[supplier.email] || {};\n    const price = prices[itemIndex];\n    const note = notes[itemIndex];\n    \n    const colName = supplier.email;\n    row[`${colName} (—Ü–µ–Ω–∞)`] = price || '‚Äî';\n    \n    if (note) {\n      row[`${colName} (–ø—Ä–∏–º.)`] = note;\n    }\n    \n    if (price && (bestPrice === null || price < bestPrice)) {\n      bestPrice = price;\n    }\n  }\n  \n  // –£–±—Ä–∞–ª–∏: row['–õ—É—á—à–∞—è —Ü–µ–Ω–∞'] –∏ row['–õ—É—á—à–∏–π –ø–æ—Å—Ç–∞–≤—â–∏–∫']\n  \n  if (bestPrice) {\n    totalBestPrice += bestPrice;\n  }\n  \n  summaryRows.push(row);\n}\n\nconst totalWeight = originalItems.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);\n\nreturn [{ \n  json: {\n    request_id: requestId,\n    created_at: requestData.created_at,\n    category: requestData.category,\n    total_weight: totalWeight.toFixed(3),\n    suppliers_count: requestData.suppliers_count || 0,\n    responses_count: suppliers.length,\n    total_best_price: Math.round(totalBestPrice),\n    summary_rows: summaryRows,\n    suppliers: suppliers.map(s => s.email),\n    has_responses: suppliers.length > 0\n  }\n}];"
      },
      "id": "dbf7eaf4-565e-4fce-9c26-2a03eb9e1868",
      "name": "Code: Build Summary",
      "type": "n8n-nodes-base.code",
      "position": [
        32,
        176
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Excel\nconst summaryData = $json;\nconst rows = summaryData.summary_rows || [];\n\nif (rows.length === 0) {\n  return [{ \n    json: { \n      '‚Ññ': '‚Äî',\n      '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',\n      '–†–∞–∑–º–µ—Ä': '',\n      '–ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏': '',\n      '–í–µ—Å, —Ç': ''\n    } \n  }];\n}\n\n// –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—ë–º —Å—Ç—Ä–æ–∫–∏ –∫–∞–∫ –µ—Å—Ç—å\nconst result = rows.map(row => ({ json: row }));\n\n// –î–æ–±–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç—Ä–æ–∫—É\nresult.push({\n  json: {\n    '‚Ññ': '',\n    '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ': '–ò–¢–û–ì–û:',\n    '–†–∞–∑–º–µ—Ä': '',\n    '–ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏': '',\n    '–í–µ—Å, —Ç': summaryData.total_weight\n  }\n});\n\nreturn result;"
      },
      "id": "8ef1cf30-5c50-4f75-8742-6dbeff7b8494",
      "name": "Code: Prepare for Excel",
      "type": "n8n-nodes-base.code",
      "position": [
        240,
        176
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "toFile",
        "fileFormat": "xlsx",
        "options": {
          "fileName": "={{ '–°–≤–æ–¥–∫–∞_' + $('Code: Build Summary').first().json.request_id + '.xlsx' }}",
          "headerRow": true,
          "sheetName": "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω"
        }
      },
      "id": "a6bab0ec-cfdf-46ce-9c89-0c2b9264d525",
      "name": "Spreadsheet: Create Excel",
      "type": "n8n-nodes-base.spreadsheetFile",
      "position": [
        464,
        176
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º Excel —Ñ–∞–π–ª –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64\nconst summaryData = $('Code: Build Summary').first().json;\nconst binaryData = $input.first().binary;\n\nlet excelBase64 = '';\nlet fileName = `–°–≤–æ–¥–∫–∞_${summaryData.request_id}.xlsx`;\n\n// Spreadsheet –Ω–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ binary.data\nif (binaryData) {\n  // –ù–∞—Ö–æ–¥–∏–º –∫–ª—é—á —Å Excel —Ñ–∞–π–ª–æ–º\n  for (const key of Object.keys(binaryData)) {\n    const file = binaryData[key];\n    if (file && file.data) {\n      excelBase64 = file.data;\n      fileName = file.fileName || fileName;\n      console.log(`üìé –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª: ${fileName}, —Ä–∞–∑–º–µ—Ä base64: ${excelBase64.length}`);\n      break;\n    }\n  }\n}\n\nif (!excelBase64) {\n  console.log('‚ö†Ô∏è Excel —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ binary –¥–∞–Ω–Ω—ã—Ö');\n  console.log('Binary keys:', Object.keys(binaryData || {}));\n}\n\nreturn [{\n  json: {\n    success: true,\n    ready: true,\n    request_id: summaryData.request_id,\n    category: summaryData.category,\n    total_weight: summaryData.total_weight,\n    suppliers_count: summaryData.suppliers_count,\n    responses_count: summaryData.responses_count,\n    total_best_price: summaryData.total_best_price,\n    suppliers: summaryData.suppliers,\n    has_responses: summaryData.has_responses,\n    excel_base64: excelBase64,\n    excel_filename: fileName,\n    message: summaryData.responses_count > 0 \n      ? `–ü–æ–ª—É—á–µ–Ω–æ ${summaryData.responses_count} –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤`\n      : '–ù–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤'\n  }\n}];"
      },
      "id": "598683fb-3902-4883-86ff-da3b07d5dd01",
      "name": "Code: Final Response",
      "type": "n8n-nodes-base.code",
      "position": [
        688,
        176
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "63868ac5-e268-4146-8a08-70b3e5d24660",
      "name": "Respond: Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        912,
        176
      ],
      "typeVersion": 1.1
    }
  ],
  "pinData": {
    "Webhook: Get Summary": [
      {
        "json": {
          "headers": {
            "host": "primary-production-4e88.up.railway.app",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36",
            "accept": "*/*",
            "accept-encoding": "gzip, deflate, br, zstd",
            "accept-language": "en-US,en;q=0.9,ru;q=0.8",
            "if-none-match": "W/\"6b92-knhBySvqylXcVWS9fiJq+QF8yHw\"",
            "origin": "https://lamblackout.github.io",
            "priority": "u=1, i",
            "referer": "https://lamblackout.github.io/",
            "sec-ch-ua": "\"Google Chrome\";v=\"143\", \"Chromium\";v=\"143\", \"Not A(Brand\";v=\"24\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"Windows\"",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "cross-site",
            "x-forwarded-for": "194.110.207.107",
            "x-forwarded-host": "primary-production-4e88.up.railway.app",
            "x-forwarded-proto": "https",
            "x-railway-edge": "railway/europe-west4-drams3a",
            "x-railway-request-id": "L562e27oTG-qecIqYqdHTg",
            "x-real-ip": "194.110.207.107",
            "x-request-start": "1766585358646"
          },
          "params": {},
          "query": {
            "request_id": "–ó–ü-20251224-079"
          },
          "body": {},
          "webhookUrl": "https://primary-production-4e88.up.railway.app/webhook/get-supplier-summary",
          "executionMode": "production"
        }
      }
    ]
  },
  "connections": {
    "Webhook: Get Summary": {
      "main": [
        [
          {
            "node": "Supabase: Get Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase: Get Request": {
      "main": [
        [
          {
            "node": "Code: Check Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code: Check Request": {
      "main": [
        [
          {
            "node": "IF: Request Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Request Exists?": {
      "main": [
        [
          {
            "node": "IF: Time Passed?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond: Not Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Time Passed?": {
      "main": [
        [
          {
            "node": "Supabase: Get Responses",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Supabase: Get Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase: Get Responses": {
      "main": [
        [
          {
            "node": "Code: Build Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code: Build Summary": {
      "main": [
        [
          {
            "node": "Code: Prepare for Excel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code: Prepare for Excel": {
      "main": [
        [
          {
            "node": "Spreadsheet: Create Excel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Spreadsheet: Create Excel": {
      "main": [
        [
          {
            "node": "Code: Final Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code: Final Response": {
      "main": [
        [
          {
            "node": "Respond: Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "f43fc164-a382-4525-ae78-7f7d9edbb166",
  "meta": {
    "instanceId": "e053b61b8b3bdff69a323dc7c626e5598b37038308beed9b02f6dd362745fcdd"
  },
  "id": "foJlJJH5mzvPjN1R",
  "tags": []
}